<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Kay Haw&#39;s Blog Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Kay Haw&#39;s Blog Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"><title data-react-helmet="true">è‡ªå®šä¹‰newå’Œdelete | Kay Haw&#x27;s Blog</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://kayhaw.github.io/docs/EffectiveC++/Effective-C++-Chap8"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="è‡ªå®šä¹‰newå’Œdelete | Kay Haw&#x27;s Blog"><meta data-react-helmet="true" name="description" content="ã€ŠEffective C++ã€‹è‹±æ–‡ç¬¬ä¸‰ç‰ˆè¯»ä¹¦ç¬”è®°ç¬¬å…«ç« "><meta data-react-helmet="true" property="og:description" content="ã€ŠEffective C++ã€‹è‹±æ–‡ç¬¬ä¸‰ç‰ˆè¯»ä¹¦ç¬”è®°ç¬¬å…«ç« "><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://kayhaw.github.io/docs/EffectiveC++/Effective-C++-Chap8"><link data-react-helmet="true" rel="alternate" href="https://kayhaw.github.io/docs/EffectiveC++/Effective-C++-Chap8" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://kayhaw.github.io/docs/EffectiveC++/Effective-C++-Chap8" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.0138175c.css">
<link rel="preload" href="/assets/js/runtime~main.ed6f7924.js" as="script">
<link rel="preload" href="/assets/js/main.87f14a62.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Kay Haw&#x27;s Blog" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Kay Haw&#x27;s Blog" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Kay Haw&#x27;s Blog</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro">è¯»ä¹¦ç¬”è®°</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/kayhaw" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ğŸŒ</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/intro">è¯»ä¹¦ç¬”è®°</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">C++PrimerPlus</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">EffectiveC++</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/EffectiveC++/Effective-C++-Chap1">å…»æˆC++å¥½ä¹ æƒ¯</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/EffectiveC++/Effective-C++-Chap2">æ„é€ å‡½æ•°,ææ„å‡½æ•°å’Œèµ‹å€¼æ“ä½œç¬¦</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/EffectiveC++/Effective-C++-Chap3">èµ„æºç®¡ç†</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/EffectiveC++/Effective-C++-Chap4">è®¾è®¡å’Œå£°æ˜</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/EffectiveC++/Effective-C++-Chap5">ä»£ç å®ç°</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/EffectiveC++/Effective-C++-Chap6">ç»§æ‰¿å’Œé¢å‘å¯¹è±¡è®¾è®¡</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/EffectiveC++/Effective-C++-Chap7">æ¨¡æ¿å’Œæ³›å‹ç¼–ç¨‹</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/EffectiveC++/Effective-C++-Chap8">è‡ªå®šä¹‰newå’Œdelete</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/EffectiveC++/Effective-C++-Chap9">æ‚å½•</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Learning Akka</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Stream Processing with Apache Flink</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">é«˜æ€§èƒ½MySQL</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>è‡ªå®šä¹‰newå’Œdelete</h1></header><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>ã€ŠEffective C++ã€‹è‹±æ–‡ç¬¬ä¸‰ç‰ˆè¯»ä¹¦ç¬”è®°ç¬¬å…«ç« </p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="item49ç†è§£new-handlerçš„è¡Œä¸º"></a>Item49:ç†è§£new-handlerçš„è¡Œä¸º<a class="hash-link" href="#item49ç†è§£new-handlerçš„è¡Œä¸º" title="Direct link to heading">#</a></h2><p>å½“newæ“ä½œç¬¦ä¸èƒ½å®Œæˆå†…å­˜åˆ†é…çš„è¯·æ±‚ï¼Œå®ƒå°±ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œå¾ˆä¹…ä¹‹å‰ï¼Œè¿™æ ·çš„newä¼šè¿”å›ç©ºæŒ‡é’ˆï¼Œæœ‰äº›è€å¼çš„ç¼–è¯‘å™¨è¿˜æ˜¯è¿™æ ·åšï¼Œä½†æˆ‘ä»¬æœ€åå†è°ˆè¿™ç‚¹ï¼Œåœ¨æŠ›å‡ºå¼‚å¸¸ä¹‹å‰ï¼Œnewæ“ä½œç¬¦ä¼šè°ƒç”¨ä¸€ä¸ªå®¢æˆ·ç«¯æŒ‡å®šçš„é”™è¯¯å¤„ç†å‡½æ•°new-handler(å®é™…æƒ…å†µæ›´å¤æ‚ï¼Œè§Item51)ï¼Œå®¢æˆ·ç«¯é€šè¿‡set_new_handleræ¥è®¾ç½®è¿™ä¸ªå¤„ç†å‡½æ•°ï¼Œset_new_handleråœ¨å¤´æ–‡ä»¶<code>&lt;new&gt;</code>ä¸­å£°æ˜ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">namespace</span><span class="token plain"> std </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">new_handler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    new_handler </span><span class="token function" style="color:#d73a49">set_new_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">new_handler p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>å¦‚ä¸Šæ‰€ç¤ºçš„ä»£ç ï¼Œnew_handleræ˜¯å‡½æ•°æŒ‡é’ˆçš„åˆ«åï¼Œè¯¥å‡½æ•°å‚æ•°ç±»å‹å’Œè¿”å›ç±»å‹ä¸ºvoidï¼Œset_new_handlerçš„å‚æ•°ä¸ºç±»å‹new_handlerï¼Œè¯¥å‚æ•°å°±æ˜¯newå¤±è´¥ååº”è¯¥è°ƒç”¨çš„å‡½æ•°ï¼Œè¿”å›ç±»å‹ä¹Ÿä¸ºnew_handlerï¼Œè¡¨ç¤ºä¹‹å‰è®¾ç½®çš„new-handlerï¼Œå¦‚æœç¬¬ä¸€æ¬¡è°ƒç”¨set_new_handlerå°†æ˜¯ç©ºæŒ‡é’ˆã€‚set_new_handlerçš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// newå¤±è´¥è°ƒç”¨çš„å‡½æ•°</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">outOfMem</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">cerr</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">&quot;Unable to satisfy request for memory\n&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">abort</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">set_new_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">outOfMem</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pBigDataArray </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1000000000L</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>å½“newæ“ä½œç¬¦ä¸èƒ½æ»¡è¶³å†…å­˜è¯·æ±‚æ—¶ï¼Œå®ƒå°†ä¼šé‡å¤è°ƒç”¨new-handlerå‡½æ•°ç›´åˆ°æœ‰å……è¶³çš„å†…å­˜ï¼Œä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„new-handlerå‡½æ•°åº”è¯¥å…·å¤‡å¦‚ä¸‹æ¡ä»¶<strong>ä¹‹ä¸€</strong>ï¼š</p><ul><li>è®©æ›´å¤šçš„å†…å­˜å¯ç”¨ã€‚ä¸€ç§æ–¹å¼æ˜¯åœ¨ç¨‹åºå¼€å§‹æ—¶é¢„ç•™ä¸€å¤§å—å†…å­˜ï¼Œç„¶ååœ¨é¦–æ¬¡è°ƒç”¨new-handleræ—¶é‡Šæ”¾è¿™äº›å†…å­˜</li><li>å®‰è£…å¦ä¸€ä¸ªnew-handlerã€‚å½“ç°æœ‰çš„new-handlerä¸èƒ½æä¾›æ›´å¤šå¯ç”¨çš„å†…å­˜ï¼Œä½†ä¹Ÿè®¸å®ƒçŸ¥é“å¦ä¸€ä¸ªnew-handlerå¯ä»¥ï¼Œç„¶åè‡ªåŠ¨å®‰è£…è¿™ä¸ªæ›´å¥½çš„new-handler</li><li>å¸è½½new-handlerã€‚å³ç»™set_new_handlerä¼ é€’å‚æ•°ä¸ºç©ºï¼Œå¦‚æœæ²¡æœ‰å®‰è£…new-handlerï¼Œnewæ“ä½œç¬¦ä¼šæŠ›å‡ºå¼‚å¸¸</li><li>æŠ›å‡ºbac_allocç±»å¼‚å¸¸æˆ–è€…bac_allocç±»æ´¾ç”Ÿçš„å¼‚å¸¸</li><li>æ²¡æœ‰è¿”å›å€¼ï¼Œé€šå¸¸è°ƒç”¨abortæˆ–è€…exit</li></ul><p>æœ‰äº›æ—¶å€™éœ€è¦æ ¹æ®å¯¹è±¡ç±»ç”¨ä¸åŒçš„æ–¹å¼å¤„ç†å†…å­˜åˆ†é…å¤±è´¥ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">X</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">outOfMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Y</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">outOfMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">X</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> p1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> X</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">Y</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> p2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> Y</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>C++æ²¡å¹¶æœ‰æ”¯æŒç‰¹å®šç±»å‹çš„new-handlerï¼Œä½†æ˜¯ä¹Ÿæ²¡å¿…è¦ï¼Œä½ å¯ä»¥è‡ªå·±ä¸ºæ¯ä¸ªç±»æä¾›å®šåˆ¶åŒ–çš„set_new_handlerå’Œoperator newå‡½æ•°ï¼Œç±»çš„set_new_handlerå‡½æ•°å…è®¸å®¢æˆ·ç«¯æŒ‡å®šç±»çš„new-handler(å°±åƒæ ‡å‡†åº“çš„set_new_handlerå…è®¸å®¢æˆ·ç«¯æŒ‡å®šå…¨å±€çš„new-handler)ã€‚å¦‚æœä½ æƒ³è¦è‡ªè¡Œå¤„ç†<code>new Widget</code>æ—¶å†…å­˜åˆ†é…å¤±è´¥ï¼Œéœ€è¦å£°æ˜é™æ€æˆå‘˜new_handleræŒ‡å®šnew-handlerå‡½æ•°ï¼ŒWidetç±»å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Widget</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">new_handler </span><span class="token function" style="color:#d73a49">set_new_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">new_handler p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">bad_alloc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">new_handler currentHandler</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>é™æ€æˆå‘˜å¿…é¡»åœ¨ç±»ä½“å¤–å®šä¹‰(é™¤éæ˜¯const)ï¼Œæ‰€ä»¥åŠ ä¸Šï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">new_handler Widget</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">currentHandler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>set_new_handlerä¿å­˜ä¼ å…¥çš„new_handlerå¹¶è¿”å›æ›´æ”¹ä¹‹å‰çš„new_handlerï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">new_handler </span><span class="token class-name">Widget</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">set_new_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">new_handler p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">new_handler oldHandler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> currentHandler</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    currentHandler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> oldHandler</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>æœ€åï¼ŒWidgetç±»çš„<code>operator new</code>å°†ä¼šå®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š</p><ul><li>è°ƒç”¨Widgetç±»çš„set_new_handlerï¼Œå°†Widgetç±»çš„new-handlerä½œä¸ºå…¨å±€çš„new-handler</li><li>è°ƒç”¨å…¨å±€çš„<code>operator new</code>æ–¹æ³•æ‰§è¡Œå†…å­˜åˆ†é…ï¼Œå¦‚æœå¤±è´¥ï¼Œå…¨å±€çš„<code>operator new</code>å”¤èµ·Widgetçš„new-handlerï¼Œå¦‚æœå…¨å±€çš„<code>operator new</code>æœ€åè¿˜æ˜¯ä¸èƒ½åˆ†é…å†…å­˜ï¼Œå®ƒä¼šæŠ›å‡ºbad_allocå¼‚å¸¸ï¼Œæ­¤æ—¶ï¼ŒWidgetçš„<code>operator new</code>æ–¹æ³•å¿…é¡»å›æ‰§åŸæ¥çš„å…¨å±€new-handlerï¼Œç„¶åå‘å¤–æŠ›å‡ºå¼‚å¸¸ï¼Œä¸ºäº†ç¡®ä¿åŸnew-handleræ€»æ˜¯æ¢å¤ï¼ŒWidgetç±»å°†å…¨å±€new-handlerä½œä¸ºèµ„æºä¿å­˜</li><li>å¦‚æœå…¨å±€çš„<code>operator new</code>èƒ½å¤Ÿåˆ†é…è¶³å¤Ÿå¤šçš„å†…å­˜ï¼ŒWidgetç±»çš„operator newæ–¹æ³•è¿”å›åˆ†é…å†…å­˜çš„æŒ‡é’ˆï¼Œç”±ææ„å‡½æ•°æ¢å¤å…¨å±€çš„new-handler</li></ul><p>æ¥ä¸‹æ¥é¦–å…ˆå®ç°èµ„æºç®¡ç†ç±»ï¼Œå®ƒéµå¾ªRAIIçš„è®¾è®¡åŸåˆ™ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">NewHandlerHolder</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">explicit</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NewHandlerHolder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">new_handler nh</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nh</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">~</span><span class="token function" style="color:#d73a49">NewHanlderHolder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">set_new_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">handler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">new_handler handler</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">NewHandlerHolder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> NewHandlerHolder</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">              </span><span class="token comment" style="color:#999988;font-style:italic">// é˜²æ­¢C++ç”Ÿæˆè‡ªå®šä¹‰çš„</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        NewHandlerHolder</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> NewHandlerHolder</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// æ‹·è´å‡½æ•°</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ç„¶åå®ç°Widgetç±»çš„operator newæ–¹æ³•ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Widget</span><span class="token operator" style="color:#393A34">::</span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">bad_alloc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    NewHandlerHolder                           </span><span class="token comment" style="color:#999988;font-style:italic">// è®¾ç½®å…¨å±€new-handlerä¸ºWidgetçš„</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">h</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">set_new_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">currentHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// åˆ©ç”¨set_new_handlerè¿”å›åŸæ¥çš„new-handlerå°†å…¶ä¿å­˜</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">                                              </span><span class="token comment" style="color:#999988;font-style:italic">// hçš„ææ„å‡½æ•°è‡ªåŠ¨è¿˜åŸå…¨å±€çš„new-handler</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Widgetçš„ä½¿ç”¨ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">outOfMem</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Widget</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">set_new_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">outOfMem</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// å°†outOfMemè®¾ç½®ä¸ºWidgetçš„new-handleræ–¹æ³•</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Widget </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pw1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> Widget</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">               </span><span class="token comment" style="color:#999988;font-style:italic">// newå¤±è´¥è°ƒç”¨outOfMem</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">string </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ps </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// newå¤±è´¥è°ƒç”¨å…¨å±€new-handler(å¦‚æœæœ‰çš„è¯)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Widget</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">set_new_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">// è®¾ç½®Widgetç±»çš„new-handlerä¸ºç©º</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">Widget </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pw2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> Widget</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">               </span><span class="token comment" style="color:#999988;font-style:italic">// newå¤±è´¥æŠ›å‡ºå¼‚å¸¸</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ä»¥ä¸Šä»£ç çš„å®ç°ä¸ç±»æ— å…³ï¼Œå¯ä»¥é‡å¤ä½¿ç”¨ï¼Œå› æ­¤å®šä¹‰ä¸€ä¸ªæ¨¡æ¿åŸºç±»ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">template</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typename</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">NewHandlerSupport</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">new_handler </span><span class="token function" style="color:#d73a49">set_new_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">new_handler p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">bad_alloc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">new_handler currentHandler</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">template</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typename</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">new_handler</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">NewHandlerSupport</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">set_new_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">new_handler p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">new_handler oldHandler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> currentHandler</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    currentHandler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> oldHandler</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">template</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typename</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> NewHandlerSupport</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">::</span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">bad_alloc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    NewHandlerHolder </span><span class="token function" style="color:#d73a49">h</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">set_new_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">currentHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">template</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typename</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">new_handler NewHandlerSupport</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">currentHandler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ä½¿ç”¨è¿™ä¸ªåŸºç±»æ¨¡æ¿å¾ˆç®€å•ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Widget</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause class-name">public</span><span class="token base-clause"> </span><span class="token base-clause class-name">NewHandlerSupport</span><span class="token base-clause operator" style="color:#393A34">&lt;</span><span class="token base-clause class-name">Widget</span><span class="token base-clause operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>è¿™ä¸ªä»£ç çœ‹èµ·æ¥ååˆ†æ€ªå¼‚ï¼šWidgetç»§æ‰¿è‡ªNewHandlerSupportæ¨¡æ¿å®ä¾‹åŒ–çš„ç±»ï¼Œè€Œå®ä¾‹åŒ–ç±»å‹å‚æ•°åˆæ˜¯Widgetè‡ªå·±ã€‚ä½†ä»”ç»†è§‚å¯Ÿå‘ç°<strong>NewHandlerSupportæ¨¡æ¿æ ¹æœ¬æ²¡æœ‰ç”¨åˆ°è¿‡ç±»å‹å‚æ•°Tï¼Œå®ƒä¹Ÿä¸éœ€è¦ï¼Œå®é™…ä¸Šæˆ‘ä»¬æ‰€éœ€è¦çš„å°±æ˜¯æ¯ç§ä¸åŒç±»å‹æœ‰ä¸åŒçš„NewHandlerSupportæ‹·è´ï¼Œç‰¹åˆ«çš„æ˜¯ç±»é™æ€å˜é‡currentHandlerï¼Œæ¨¡æ¿å‚æ•°Tåªæ˜¯ç”¨æ¥åŒºåˆ†ä¸åŒçš„ç»§æ‰¿ç±»ï¼Œå½“NewHandlerSupportæ¨¡æ¿å®ä¾‹åŒ–æ—¶æ¨¡æ¿æœºåˆ¶è‡ªåŠ¨ä¸ºæ¯ä¸ªTç±»å‹ç”ŸæˆcurrentHandleræ‹·è´</strong>ï¼Œè¿™ç§æ´¾ç”Ÿç±»ç»§æ‰¿çš„æ¨¡æ¿åŸºç±»ä»¥æ´¾ç”Ÿç±»è‡ªå·±ä¸ºç±»å‹å‚æ•°çš„æŠ€æœ¯ç§°ä¸º<em>å¥‡æ€ªé€’å½’æ¨¡æ¿æ¨¡å¼(CRTP, curiously recurring template pattern)</em>ã€‚ç›´åˆ°1993å¹´ï¼ŒC++è¿˜æ˜¯è¦æ±‚operator newæ“ä½œå¤±è´¥æ—¶è¿”å›nullï¼Œè€Œç°åœ¨æ˜¯æŠ›å‡ºbad_allocå¼‚å¸¸ï¼Œä¸ºäº†è®©è€ä»£ç å…¼å®¹ï¼ŒC++æ ‡å‡†å§”å‘˜ä¼šæä¾›äº†nothrow(åœ¨<code>&lt;new&gt;</code>å¤´æ–‡ä»¶ä¸­å®šä¹‰)ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Widget</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">Widget </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pw1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> Widget</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                   </span><span class="token comment" style="color:#999988;font-style:italic">// newå¤±è´¥æŠ›å‡ºbad_allocå¼‚å¸¸</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pw1 </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">                            </span><span class="token comment" style="color:#999988;font-style:italic">// ç»“æœæ€»æ˜¯false</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">Widget </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pw2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">nothrow</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> Widget</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// newå¤±è´¥è¿”å›null</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pw2 </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">                            </span><span class="token comment" style="color:#999988;font-style:italic">// å¯èƒ½æ˜¯true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>è¡¨è¾¾å¼<code>new (std::nothrow) Widget</code>é¦–å…ˆè°ƒç”¨nothrowç‰ˆæœ¬çš„operator newæ“ä½œç¬¦å‡½æ•°åˆ†é…å†…å­˜ï¼Œå¦‚æœå†…å­˜åˆ†é…å¤±è´¥ï¼Œè¿”å›ç©ºæŒ‡é’ˆï¼Œå¦‚æœæˆåŠŸï¼Œç„¶åè°ƒç”¨Widgetçš„æ„é€ å‡½æ•°ï¼Œä½†æ­¤æ—¶æ‰€æœ‰çš„ä¿è¯éƒ½æ²¡äº†ï¼Œæ„é€ å‡½æ•°ä¹Ÿå¯èƒ½ä½¿ç”¨newï¼Œè€Œä¸”è¿˜ä¸ä¸€å®šä½¿ç”¨nothrowç‰ˆæœ¬çš„newï¼Œå¦‚æœæ„é€ å‡½æ•°ä¸­çš„newæŠ›å‡ºå¼‚å¸¸ï¼Œå°±ä¼šåœ¨<code>new (std::nothrow) Widget</code>å‡ºç°ã€‚æ€»ç»“ï¼Ÿä½¿ç”¨nothrow newåªä¿è¯<code>operator new</code>ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä½†æ²¡æœ‰ä¿è¯è¡¨è¾¾å¼<code>new (std::nothrow) Widget</code>ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ä½ å¯èƒ½æ°¸è¿œä¸éœ€è¦ç”¨åˆ°nothrow new</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>æ€»ç»“</h5></div><div class="admonition-content"><p>ä½¿ç”¨<code>set_new_handler</code>æŒ‡å®šå†…å­˜åˆ†é…å¤±è´¥æ—¶è°ƒç”¨çš„å‡½æ•°ï¼›Nothrow newçš„èƒ½åŠ›æœ‰é™ï¼Œåªèƒ½ç”¨äºå†…å­˜åˆ†é…æ—¶ï¼Œä½†éšåçš„æ„é€ å‡½æ•°è¿˜æ˜¯ä¼šæœ‰å¯èƒ½æŠ›å‡ºå¼‚å¸¸</p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="item50ç†è§£ä½•æ—¶æ›¿ä»£newå’Œdeleteæ‰æœ‰æ„ä¹‰"></a>Item50:ç†è§£ä½•æ—¶æ›¿ä»£newå’Œdeleteæ‰æœ‰æ„ä¹‰<a class="hash-link" href="#item50ç†è§£ä½•æ—¶æ›¿ä»£newå’Œdeleteæ‰æœ‰æ„ä¹‰" title="Direct link to heading">#</a></h2><p>è®©æˆ‘ä»¬å›åˆ°åŸºç¡€ï¼Œä¸ºä»€ä¹ˆæœ‰äººæƒ³è¦æ›¿ä»£ç¼–è¯‘å™¨æä¾›çš„newå’Œdeleteæ“ä½œç¬¦å‘¢ï¼Ÿæœ‰ç€ä¸‰ç§å¸¸è§åŸå› ï¼š</p><ul><li><strong>æ£€æµ‹ä½¿ç”¨é”™è¯¯</strong>ï¼Œä½¿ç”¨newè€Œæ²¡æœ‰ä½¿ç”¨deleteå¯¼è‡´å†…å­˜æ³„éœ²ï¼Œå·²ç”¨newè€Œå†æ¬¡ä½¿ç”¨deleteæ˜¯æœªå®šä¹‰è¡Œä¸ºï¼Œå¦‚æœnewå«æœ‰åˆ†é…å†…å­˜åœ°å€çš„åˆ—è¡¨ï¼Œdeleteä»è¯¥åˆ—è¡¨ä¸­åˆ é™¤åœ°å€ï¼Œå¯ä»¥æ£€æµ‹åˆ°ç±»ä¼¼çš„ä½¿ç”¨é”™è¯¯ï¼›ç±»ä¼¼åœ°ï¼Œç¼–è¯‘é”™è¯¯ä¹Ÿä¼šå¯¼è‡´æ•°æ®overrun(å†™å…¥æ•°æ®è¶…è¿‡åˆ†é…å†…å­˜å—çš„æœ«å°¾)å’Œunderrun(å†™å…¥æ•°æ®æå‰åˆ°åˆ†é…å†…å­˜å—çš„å¼€å¤´)ï¼Œè‡ªå®šä¹‰çš„newå¯ä»¥å¤šåˆ†é…ä¸€ç‚¹å†…å­˜ä¿å­˜å·²çŸ¥çš„å­—èŠ‚æ¨¡å¼(&quot;ç­¾å&quot;)ï¼Œdeleteå¯ä»¥é€šè¿‡æ£€æŸ¥ç­¾åæ˜¯å¦å®Œæ•´æ¥æ£€æµ‹æ˜¯å¦å‡ºç°overrunå’Œunderrun</li><li><strong>æé«˜æ•ˆç‡</strong>ï¼Œç¼–è¯‘å™¨æä¾›çš„newå’Œdeleteæ˜¯é€šç”¨è®¾è®¡ï¼šå®ƒä»¬é€‚åº”é•¿æœŸè¿è¡Œçš„ç¨‹åº(WebæœåŠ¡å™¨)ï¼Œä¹Ÿè¦é€‚åº”è¿è¡Œä¸åˆ°1ç§’çš„ç¨‹åºï¼Œéœ€è¦è€ƒè™‘å †ç¢ç‰‡åŒ–ç­‰ç­‰ã€‚newå’Œdeleteå¯¹æ‰€æœ‰æƒ…å†µéƒ½èƒ½è¾ƒå¥½å·¥ä½œï¼Œä½†åŒæ—¶æ²¡æœ‰å¯¹å“ªç§æƒ…å†µè¿›è¡Œä¼˜åŒ–ï¼Œå¦‚æœä½ å¯¹è‡ªå·±ç¨‹åºçš„åŠ¨æ€å†…å­˜ä½¿ç”¨æ¨¡å¼æœ‰è¾ƒå¥½çš„ç†è§£ï¼Œè‡ªå®šä¹‰newå’Œoperatorå¯ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½</li><li><strong>æ”¶é›†ä½¿ç”¨æ•°æ®</strong>ï¼Œåœ¨å¼€å§‹é‡å®šä¹‰newå’Œdeleteä¹‹å‰ï¼Œæ”¶é›†è½¯ä»¶ä½¿ç”¨åŠ¨æ€å†…å­˜çš„ä¿¡æ¯æ˜¯å¾ˆç²¾æ˜çš„äº‹ï¼Œåˆ†é…å†…å­˜å—ä½“ç§¯çš„åˆ†å¸ƒå¦‚ä½•ï¼Ÿç”Ÿå‘½å‘¨æœŸçš„åˆ†å¸ƒå¦‚ä½•ï¼Ÿå†…å­˜å—æ˜¯æŒ‰ç…§FIFOè¿˜æ˜¯LIFOçš„é¡ºåºåˆ†é…é‡Šæ”¾ï¼Œæˆ–è€…æ˜¯æ›´éšæœºçš„é¡ºåºï¼Ÿè‡ªå®šä¹‰newå’Œdeleteå¯ä»¥è½»æ˜“åœ°æ”¶é›†è¿™äº›æ•°æ®</li></ul><p>ä»æ¦‚å¿µä¸Šè‡ªå®šä¹‰newå¾ˆç®€å•ï¼Œå¦‚ä¸‹æ‰€ç¤ºæä¾›äº†ä¸€ä¸ªè‡ªå®šä¹‰newæ ·ä¾‹ï¼Œè¯¥newæ“ä½œç¬¦æ£€æµ‹overrunå’Œunderrunï¼Œä»£ç é‡Œè¿˜æœ‰ä¸€äº›å°ç‘•ç–µä½†æ˜¯å¾ˆå¿«å°±ä¼šæåˆ°ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> signature </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xDEADBEEF</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> Byte</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ä»¥ä¸‹ä»£ç æœ‰äº›ç‘•ç–µ</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">bad_alloc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">namespace</span><span class="token plain"> std</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_t realSize </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> size </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pMem </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">malloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">realSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">pMem</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bad_alloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// åœ¨åˆ†é…å†…å­˜çš„å¼€å§‹å’Œæœ«å°¾å†™å…¥signature</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">static_cast</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">int</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pMem</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> signature</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">reinterpret_cast</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">int</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">siatic_cast</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Byte</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pMem</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">realSize</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> signature</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// è¿”å›ç¬¬ä¸€ä¸ªsignatureåé¢çš„æŒ‡é’ˆåœ°å€</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static_cast</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Byte</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">pMem</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ä»¥ä¸Šè‡ªå®šä¹‰çš„newæ“ä½œç¬¦çš„ç¼ºç‚¹å¤§å¤šæ•°æºäºå®ƒæ²¡æœ‰åšæŒC++ä¸­newå‡½æ•°çš„ä¼ ç»Ÿï¼Œæ¯”å¦‚ï¼ŒItem51è¯´æ‰€æœ‰çš„newæ“ä½œç¬¦åº”è¯¥åŒ…å«ä¸€ä¸ªå¾ªç¯ï¼Œå¹¶ä¸”è¯¥å¾ªç¯è°ƒç”¨new-handlerï¼Œå¯è¿™é‡Œçš„newå¹¶æ²¡æœ‰ï¼ŒItem51è¯¦ç»†è¯´æ˜è¿™ä¸€ç‚¹ï¼Œè¿™é‡Œæˆ‘ä»¬å…³æ³¨å¦ä¸€ä¸ªç»†å¾®çš„é—®é¢˜ï¼šå¯¹é½ã€‚è®¸å¤šæ¶æ„è¦æ±‚ç‰¹å®šç±»å‹æ•°æ®å­˜æ”¾åœ¨ç‰¹å®šå†…å­˜åœ°å€ï¼Œæ¯”å¦‚æŒ‡é’ˆå˜é‡çš„åœ°å€ä¸º4çš„å€æ•°ï¼Œdoubleå˜é‡çš„åœ°å€ä¸º8çš„å€æ•°ï¼Œå¦‚æœæ²¡æœ‰éµå¾ªè¿™ä¸ªè§„åˆ™å°†ä¼šå¼•èµ·è¿è¡Œæ—¶çš„ç¡¬ä»¶å¼‚å¸¸ï¼Œæœ‰äº›æ¶æ„å¯¹æ­¤å¯èƒ½ä¼šå®½å®¹äº›ï¼Œä½†æ˜¯å¯¹é½çš„è¯æ€§èƒ½ä¼šæ›´å¥½ã€‚C++è¦æ±‚æ‰€æœ‰çš„newæ“ä½œç¬¦è¿”å›<strong>å¯¹é½ä»»ä½•ç±»å‹çš„æŒ‡é’ˆ</strong>ï¼Œmallocæ»¡è¶³åŒæ ·çš„è¦æ±‚ï¼Œæ‰€æœ‰å•å•ä½¿ç”¨mallocå¹¶è¿”å›å…¶åœ°å€çš„newæ“ä½œç¬¦æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ ·ä¾‹ä»£ç è¿”å›çš„æ˜¯mallocè¿”å›çš„åœ°å€åŠ ä¸Šä¸€ä¸ªintå¤§å°çš„åç§»ï¼Œè¯¥åœ°å€å¹¶ä¸ä¿è¯æ˜¯å¯¹é½çš„ï¼Œæ¯”å¦‚newä¸€ä¸ªdoubleæ•°ç»„ï¼Œdoubleä¸º8å­—èŠ‚ï¼Œintä¸º4å­—èŠ‚ï¼Œè¿”å›åœ°å€æ²¡æœ‰å’Œ8å¯¹é½ï¼Œæœ€åçš„ç»“æœæ˜¯ç¨‹åºä¸è¿è¡Œæˆ–è€…è¿è¡Œå¾—æ›´æ…¢ã€‚<br>
è®¸å¤šæƒ…å†µä¸‹ï¼Œä½ å¹¶ä¸éœ€è¦è‡ªå®šä¹‰newå’Œdeleteï¼Œæœ‰äº›ç¼–è¯‘å™¨å·²ç»åœ¨å…¶å†…å­˜ç®¡ç†å‡½æ•°ä¸­å®ç°äº†è°ƒè¯•å’Œæ—¥å¿—åŠŸèƒ½ï¼Œæµè§ˆä¸€ä¸‹ç¼–è¯‘å™¨çš„æ–‡æ¡£å¯ä»¥å¸®åŠ©ä½ æ‰“æ¶ˆè‡ªå®šä¹‰newå’Œdeleteçš„å¿µå¤´ï¼Œè®¸å¤šå•†ä¸šäº§å“æä¾›å¯æ›¿æ¢å†…å­˜ç®¡ç†å‡½æ•°çš„ç¼–è¯‘å™¨ï¼Œåªéœ€è¦ä¹°ä¸‹å¹¶é‡æ–°é“¾æ¥å³å¯ï¼Œå¦ä¸€ç§é€‰æ‹©æ˜¯å¼€æºçš„å†…å­˜ç®¡ç†å™¨ï¼Œæ¯”å¦‚Boostçš„Poolåº“ã€‚æœ¬èŠ‚çš„ä¸»é¢˜æ˜¯çŸ¥é“ä»€ä¹ˆæ—¶å€™æ›¿æ¢é»˜è®¤çš„newå’Œdeleteæ‰æœ‰æ„ä¹‰ï¼Œè¿™é‡Œæ€»ç»“å¦‚ä¸‹ï¼š</p><ul><li>æ£€æµ‹ä½¿ç”¨é”™è¯¯</li><li>æ”¶é›†åŠ¨æ€åˆ†é…å†…å­˜çš„ç»Ÿè®¡æ•°æ®</li><li>æé«˜å†…å­˜åˆ†é…å’Œé‡Šæ”¾çš„é€Ÿåº¦</li><li>å‡å°‘é»˜è®¤å†…å­˜ç®¡ç†çš„å†…å­˜å¼€é”€</li><li>è¡¥å¿é»˜è®¤åˆ†é…ä¸ä½³çš„å¯¹é½</li><li>é›†ä¸­ç›¸å…³å¯¹è±¡</li><li>è·å¾—éä¼ ç»Ÿçš„è¡Œä¸º</li></ul><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>æ€»ç»“</h5></div><div class="admonition-content"><p>è‡ªå®šä¹‰newå’Œdeleteçš„åŸå› æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚æ”¹å–„æ€§èƒ½ï¼Œè°ƒè¯•å †ä½¿ç”¨é”™è¯¯ï¼Œæ”¶é›†å †ä½¿ç”¨æ•°æ®ç­‰</p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="item51é‡å†™newå’Œdeleteæ—¶åšæŒæƒ¯ä¾‹"></a>Item51:é‡å†™newå’Œdeleteæ—¶åšæŒæƒ¯ä¾‹<a class="hash-link" href="#item51é‡å†™newå’Œdeleteæ—¶åšæŒæƒ¯ä¾‹" title="Direct link to heading">#</a></h2><p>Item50è¯´æ˜äº†ä½•æ—¶é‡å†™newå’Œdeleteï¼Œä½†æ²¡æœ‰è¯´æ˜é‡å®šä¹‰æ—¶åº”è¯¥éµå®ˆçš„æƒ¯ä¾‹ï¼Œè¿™äº›è§„åˆ™ä¸éš¾éµå®ˆï¼Œåªæ˜¯ç†è§£èµ·æ¥æ²¡æœ‰é‚£ä¹ˆç›´è§‚ï¼Œå› æ­¤äº†è§£å®ƒä»¬å¾ˆé‡è¦ã€‚é¦–å…ˆä»å®ç°operator newå¼€å§‹ï¼Œå®ƒéœ€è¦æœ‰æ­£ç¡®çš„è¿”å›å€¼ï¼Œå†…å­˜ä¸è¶³æ—¶è°ƒç”¨new-handlerï¼Œåº”å¯¹è¦æ±‚å†…å­˜å¤§å°ä¸º0çš„æƒ…å†µï¼ŒåŒæ—¶è¦é¿å…è¦†ç›–newçš„æ­£å¸¸å½¢å¼(è¯¦è§Item52)ã€‚newæ“ä½œç¬¦çš„è¿”å›å€¼çœ‹ä¼¼å¾ˆç®€å•ï¼šå¦‚æœç”³è¯·å†…å­˜æˆåŠŸï¼Œè¿”å›æŒ‡é’ˆï¼Œå¦åˆ™æŒ‰ç…§Item49çš„è§„åˆ™æŠ›å‡ºbad_allocå¼‚å¸¸ï¼Œä½†å¹¶ä¸ç®€å•ï¼Œå› ä¸ºnewä¼šå°è¯•å¤šæ¬¡åˆ†é…å†…å­˜ï¼Œå¹¶åœ¨æ¯ä¸€æ¬¡å¤±è´¥åè°ƒç”¨new-handlerå‡½æ•°ï¼Œè¿™é‡Œçš„å‡è®¾æ˜¯new-handlerèƒ½å¤Ÿé‡Šæ”¾ä¸€äº›å†…å­˜ï¼Œå½“new-handleä¸ºç©ºæ—¶newæ‰ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚å¥‡æ€ªçš„æ˜¯ï¼ŒC++è¦æ±‚newè¿”å›ä¸€ä¸ªåˆæ³•æŒ‡é’ˆï¼Œå³ä½¿ç”³è¯·å†…å­˜å¤§å°ä¸º0ï¼Œä»¥æ­¤ä¸ºä¾‹ï¼Œéæˆå‘˜çš„operator newä¼ªä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">bad_alloc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">namespace</span><span class="token plain"> std</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">// å¤„ç†åˆ†é…å¤§å°ä¸º0çš„æƒ…å†µ</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">               </span><span class="token comment" style="color:#999988;font-style:italic">// å°†å¤§å°æ”¹ä¸º1</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        attempt to allocate size bytes</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">the allocation was successful</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a pointer to the memory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// å†…å­˜åˆ†é…å¤±è´¥</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_handler globalHandler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">set_new_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">ser_new_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">globalHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">globaleHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">globalHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">bad_alloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>æ³¨æ„ä»£ç ä¸­å¤„ç†sizeä¸º0çš„æŠ€å·§ï¼Œç›´æ¥æŠŠsizeæ”¹ä¸º1ï¼Œç®€å•ä½†æœ‰æ•ˆï¼Œä¸ç„¶è¦æ€ä¹ˆåŠï¼Ÿå¦å¤–ä¹Ÿä¼šå‘ç°new-handlerè¢«è®¾ç½®ä¸ºnullï¼Œç„¶åé‡ç½®ï¼Œè¿™æ˜¯å› ä¸ºæ²¡æœ‰åŠæ³•ç›´æ¥å¤šçš„new-handleå‡½æ•°æŒ‡é’ˆï¼Œåªèƒ½è°ƒç”¨set_new_handleræ¥è·å¾—ï¼Œç²—æš´ä½†æ˜¯æœ‰æ•ˆï¼Œè‡³å°‘åœ¨å•çº¿ç¨‹ä¸­ï¼Œåœ¨å¤šçº¿ç¨‹ä¸­éœ€è¦ç”¨é”ç¡®ä¿å®‰å…¨ã€‚Item49ä¸­å¼ºè°ƒnewè¦åŒ…å«ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œä»¥ä¸Šä»£ç å±•ç¤ºäº†è¿™ç‚¹ï¼Œ<code>while(true)</code>æ˜¯æ— é™å¾ªç¯ï¼Œåªæœ‰å½“æˆåŠŸåˆ†é…å†…å­˜æˆ–è€…å¤±è´¥åå®Œæˆnew-handlerçš„å·¥ä½œ(è§Item49)æ‰èƒ½é€€å‡ºå¾ªç¯ã€‚è®¸å¤šäººéƒ½æ²¡æœ‰æ„è¯†åˆ°æˆå‘˜å‡½æ•°operator newä¼šè¢«æ´¾ç”Ÿç±»ç»§æ‰¿ï¼Œä»è€Œå¯¼è‡´ä¸€äº›é—®é¢˜ï¼Œä»¥ä¸Šçš„ä¼ªä»£ç ä¸­æŠŠsizeä¸º0æ”¹æˆ1é€‚ç”¨äºæ‰€æœ‰æƒ…å†µï¼Œä½†æ˜¯æ­£å¦‚Item51æ‰€è§£é‡Šçš„ï¼Œè‡ªå®šä¹‰çš„å†…å­˜ç®¡ç†å™¨æ˜¯ä¸ºäº†ä¼˜åŒ–ç‰¹å®šç±»çš„å†…å­˜åˆ†é…ï¼Œè€Œä¸æ˜¯æ‰€æœ‰ç±»æˆ–è€…ç±»çš„æ´¾ç”Ÿç±»è€Œè¿™ä¹ˆåšï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç»™å®šç±»Xçš„æˆå‘˜å‡½æ•°operator newï¼Œè¯¥æ–¹æ³•ç”³è¯·çš„å†…å­˜ä½“ç§¯å°±æ˜¯<code>sizeof(x)</code>ï¼Œä¸å¤šä¹Ÿä¸å°‘ï¼Œä½†æ˜¯ç”±äºç»§æ‰¿ï¼Œå¯èƒ½ä¼šè®©åŸºç±»çš„newæ“ä½œç¬¦å‡½æ•°åœ¨æ´¾ç”Ÿç±»å¯¹è±¡çš„åˆ›å»ºä¸­è¢«è°ƒç”¨ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Base</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">bad_alloc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Derived</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause class-name">public</span><span class="token base-clause"> </span><span class="token base-clause class-name">Base</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// åŸºç±»å¹¶æ²¡æœ‰å£°æ˜</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">                             </span><span class="token comment" style="color:#999988;font-style:italic">// operator newæ–¹æ³•</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Derived </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> Derived</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// è°ƒç”¨Base::operator new</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>å¦‚æœBase::operator newæ²¡æœ‰è€ƒè™‘åˆ°è¿™ç§æƒ…å†µï¼Œæœ€å¥½çš„æ–¹æ³•æ˜¯å‡å°‘è¯·æ±‚è°ƒç”¨â€œé”™è¯¯â€å¤§å°çš„å†…å­˜ï¼Œè€Œæ˜¯ä½¿ç”¨æ ‡å‡†(å…¨å±€)çš„newï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Base</span><span class="token operator" style="color:#393A34">::</span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">bad_alloc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Base</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>â€œæ…¢ç€ï¼â€æˆ‘æƒ³ä½ å·²ç»å¼€å§‹å¤§å«äº†ï¼Œâ€œä½ æ²¡æœ‰è€ƒè™‘sizeä¸º0çš„æƒ…å†µâ€ï¼Œå®é™…ä¸Šï¼Œè¿™å·²ç»åœ¨åŒ…å«åœ¨<code>size != sizeof(Base)</code>é‡Œé¢äº†ï¼ŒC++è§„å®šç©ºç±»çš„å¤§å°ä¸ä¸º0(è§Item39)ï¼Œç”±æ­¤<code>sizeof(Base)</code>æ°¸è¿œä¸ä¼šä¸º0ï¼Œæ‰€ä»¥å¦‚æœsizeä¸º0ï¼Œè¿˜æ˜¯ä¼šæ‰§è¡Œ<code>::operator new(size)</code>ã€‚å¦‚æœæƒ³è¦æ§åˆ¶ç±»æ•°ç»„ï¼Œéœ€è¦å®ç°<code>operator new[]</code>ï¼Œç§°ä¹‹ä¸ºâ€œarray newâ€ï¼Œå®ç°array newæ—¶è¦æ³¨æ„ï¼Œä½ æ‰€åšçš„æ‰€æœ‰åªæ˜¯åˆ†é…ä¸€å—å†…å­˜ï¼Œé‡Œé¢æ²¡æœ‰å¯¹è±¡ï¼Œå®é™…ä¸Šä½ ç”šè‡³ä¸çŸ¥é“æ•°ç»„é‡Œé¢æœ‰å¤šå°‘ä¸ªå¯¹è±¡ï¼šç¬¬ä¸€ï¼Œä½ ä¸çŸ¥é“æ¯ä¸ªå¯¹è±¡å¤§å°ï¼Œå› ä¸ºåŸºç±»çš„<code>operator new[]</code>å¯èƒ½ä¼šè¢«æ´¾ç”Ÿç±»è°ƒç”¨ï¼Œè€Œæ´¾ç”Ÿç±»å¯¹è±¡é€šå¸¸æ¯”åŸºç±»å¤§ï¼›ç¬¬äºŒï¼Œä¼ é€’ç»™<code>operator new[]</code>çš„å‚æ•°sizeå¯èƒ½ä¼šå¤šä¸€äº›ï¼Œæ­£å¦‚Item16æ‰€è¯´æ˜çš„ï¼ŒåŠ¨æ€åˆ†é…çš„å†…å­˜éœ€è¦é¢å¤–ç©ºé—´å­˜å‚¨å…ƒç´ ä¸ªæ•°ã€‚ä»¥ä¸Šå°±æ˜¯ä½ åœ¨é‡å†™operator newæ—¶æ‰€éœ€è¦éµå¾ªçš„æƒ¯ä¾‹ï¼Œå¯¹äºdeleteæ¥è¯´å°±å¾ˆç®€å•äº†ï¼Œåªéœ€è¦è®°ä½C++ä¿è¯é‡Šæ”¾ç©ºæŒ‡é’ˆæ—¶æ€»æ˜¯å®‰å…¨çš„ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rawMemory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rawMemory </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                      </span><span class="token comment" style="color:#999988;font-style:italic">// ç©ºæŒ‡é’ˆç›´æ¥è¿”å›</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    é‡Šæ”¾rawMemoryæ‰€æŒ‡å‘å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ä»¥ä¸Šçš„å®ç°ä»£ç æ˜¯ç®€å•çš„ï¼Œé™¤éä½ å¿…é¡»ç¡®ä¿è¢«é‡Šæ”¾çš„å¤§å°ï¼Œå‡è®¾ä½ çš„ç±»æ–¹æ³•operator newå‘<code>::operator new</code>è¦æ±‚â€œé”™è¯¯çš„â€å†…å­˜å¤§å°ï¼Œä½ ä¹Ÿè¦é€šè¿‡<code>::operator delete</code>é‡Šæ”¾å†…å­˜ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Base</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">bad_alloc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> rawMemory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> Base</span><span class="token operator" style="color:#393A34">::</span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> rawMemory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rawMemory </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">              </span><span class="token comment" style="color:#999988;font-style:italic">// æ£€æŸ¥ç©ºæŒ‡é’ˆ</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Base</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">               </span><span class="token comment" style="color:#999988;font-style:italic">// å¦‚æœå¤§å°æ˜¯â€œé”™è¯¯çš„â€</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">::</span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rawMemory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">// ä½¿ç”¨æ ‡å‡†çš„deleteé‡Šæ”¾å†…å­˜</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    é‡Šæ”¾rawMemoryæ‰€æŒ‡å‘å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>æœ‰è¶£çš„æ˜¯ï¼Œå¦‚æœåŸºç±»ææ„å‡½æ•°ä¸æ˜¯è™šå‡½æ•°ï¼Œå¯¹äºæ´¾ç”Ÿç±»å¯¹è±¡æ¥è¯´ï¼Œoperator deleteçš„sizeå‚æ•°å€¼å¤§å°å¯èƒ½æ˜¯é”™è¯¯çš„(åŒoperator newä¸€æ ·)ï¼Œè¿™å°±æ˜¯æœ€å¥½ç¡®ä¿åŸºç±»çš„ææ„å‡½æ•°æ˜¯virtualçš„åŸå› ï¼ŒItem7çš„ä¾‹å­æœ‰ç€æ›´å¯é çš„ç†ç”±ï¼Œç°åœ¨ä½ åªéœ€è¦è®°ä½å¦‚æœåŸºç±»çš„ææ„å‡½æ•°æ²¡æœ‰åŠ virtualçš„è¯ï¼Œoperator deleteå°±å¯èƒ½ä¼šå‡ºé—®é¢˜</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>æ€»ç»“</h5></div><div class="admonition-content"><p>é‡å†™newåº”è¯¥åŒ…å«ä¸€ä¸ªè¯•ç€åˆ†é…å†…å­˜çš„æ— é™å¾ªç¯ï¼Œå½“åˆ†é…å¤±è´¥åº”è¯¥è°ƒç”¨new-handlerï¼Œèƒ½å¤Ÿå¤„ç†ç”³è¯·å¤§å°ä¸º0çš„æƒ…å†µï¼Œç‰¹å®šç±»ç‰ˆæœ¬çš„newåº”è¯¥å¤„ç†æ¯”é¢„æœŸæ›´å¤§å†…å­˜å—çš„ç”³è¯·ï¼›é‡å†™deleteåœ¨æŒ‡é’ˆä¸ºç©ºæ—¶ä»€ä¹ˆä¹Ÿä¸å¹²ï¼Œç‰¹å®šç±»ç‰ˆæœ¬çš„deleteåº”è¯¥å¤„ç†æ¯”é¢„æœŸæ›´å¤§å†…å­˜å—çš„é‡Šæ”¾</p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="item52å¦‚æœè‡ªå®šä¹‰placement-newåˆ™è¦è‡ªå®šä¹‰å¯¹åº”çš„delete"></a>Item52:å¦‚æœè‡ªå®šä¹‰placement newåˆ™è¦è‡ªå®šä¹‰å¯¹åº”çš„delete<a class="hash-link" href="#item52å¦‚æœè‡ªå®šä¹‰placement-newåˆ™è¦è‡ªå®šä¹‰å¯¹åº”çš„delete" title="Direct link to heading">#</a></h2><p>Placement newå’Œplacement deleteå¹¶ä¸æ˜¯åœ¨C++åŠ¨ç‰©å›­ä¸­æœ€å¸¸è§çš„é‡å…½ï¼Œä¸å¿…å› ä¸ºä¸ç†Ÿæ‚‰å®ƒä»¬è€ŒæƒŠæ…Œï¼Œå›é¡¾Item16ï¼Œ17ä¸­newçš„ç”¨æ³•ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Widget </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pw </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> Widget</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>è¿™é‡Œè°ƒç”¨äº†ä¸¤ä¸ªå‡½æ•°ï¼Œé¦–å…ˆoperator newç”¨äºç”³è¯·å†…å­˜ï¼Œç„¶åæ˜¯Widgetçš„é»˜è®¤æ„é€ å‡½æ•°ã€‚å‡è®¾ç¬¬ä¸€ä¸ªå‡½æ•°è°ƒç”¨æˆåŠŸä½†æ˜¯ç¬¬äºŒä¸ªå¤±è´¥æŠ›å‡ºå¼‚å¸¸ï¼Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦é‡Šæ”¾ç¬¬ä¸€æ­¥ä¸­ç”³è¯·çš„å†…å­˜ï¼Œä½†æ˜¯å®¢æˆ·ç«¯ä»£ç ä¸èƒ½åšåˆ°ï¼Œå› ä¸ºWidgetæ„é€ å‡½æ•°æŠ›å‡ºå¼‚å¸¸ï¼Œpwæ²¡æœ‰è¢«èµ‹å€¼ï¼Œæ‰€ä»¥è´£ä»»è½åˆ°äº†C++è¿è¡Œæ—¶ç³»ç»Ÿèº«ä¸Šï¼Œå®ƒéœ€è¦è°ƒç”¨ä¸æ­¥éª¤1ä¸­operator newç›¸å¯¹åº”çš„operator deleteå‡½æ•°ï¼Œä½†è¿™ä»…é™äºC++è¿è¡Œæ—¶ç³»ç»ŸçŸ¥é“è¯¥è°ƒç”¨å“ªä¸ªoperator deleteå‡½æ•°ï¼Œå¦‚æœæ˜¯æ­£å¸¸ç­¾åçš„newå’Œdeleteæ“ä½œç¬¦å‡½æ•°ï¼Œè¿™å¹¶æ²¡ä»€ä¹ˆé—®é¢˜ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">bad_alloc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rawMemory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                      </span><span class="token comment" style="color:#999988;font-style:italic">// å…¨å±€ä½œç”¨åŸŸçš„æ­£å¸¸ç­¾å</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rawMemory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ç±»ä½œç”¨åŸŸçš„æ­£å¸¸ç­¾å</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>å¦‚æœåªä½¿ç”¨æ™®é€šå½¢å¼çš„newå’Œdeleteä¸ä¼šå‡ºç°ä»»ä½•é—®é¢˜ï¼Œè¿è¡Œæ—¶ç³»ç»ŸçŸ¥é“è°ƒç”¨å“ªä¸ªdeleteï¼Œä½†æ˜¯å¦‚æœä½ å£°æ˜äº†é¢å¤–å‚æ•°çš„operator newå‡½æ•°ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ï¼Œæ¯”å¦‚ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Widget</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">ostream</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> logStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">bad_alloc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pMemory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>æ¥å—é¢å¤–å‚æ•°(é™¤äº†å¤§å°å‚æ•°sizeå¤–)çš„operator newå‡½æ•°è¢«ç§°ä¸ºplacement newï¼Œæ¯”å¦‚è¿™é‡Œçš„<code>Widget::operator new</code>ï¼Œplacement newçš„å¸¸è§ç”¨æ³•å°±æ˜¯æŒ‡å®šå¯¹è±¡æ„é€ çš„åœ°å€ï¼Œå®ƒçš„å£°æ˜ä¸ºï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> pMemory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>å®é™…ä¸Šï¼Œè¿™ç§ç‰ˆæœ¬çš„newå·²ç»åŒ…å«åœ¨C++æ ‡å‡†åº“ä¸­ï¼ŒåŒ…å«å¤´æ–‡ä»¶<code>#include &lt;new&gt;</code>å°±å¯ä»¥ä½¿ç”¨ï¼Œå½“æåˆ°placement newæ—¶ï¼Œå…¶å®äººä»¬éƒ½åœ¨è¯´è¿™ä¸ªç‰¹æ®Šçš„ç‰ˆæœ¬ï¼Œå›åˆ°Widgetï¼Œè€ƒè™‘å¦‚ä¸‹å®¢æˆ·ç«¯ä»£ç ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Widget </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pw </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">cerr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> Widget</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>å†ä¸€æ¬¡åœ°ï¼Œå¦‚æœå†…å­˜åˆ†é…æˆåŠŸä½†æ˜¯Widgetæ„é€ å‡½æ•°æŠ›å‡ºå¼‚å¸¸ï¼Œè¿è¡Œæ—¶ç³»ç»Ÿè´Ÿè´£å›æ»šoperator newçš„æ“ä½œï¼Œä½†æ˜¯ï¼Œç”±äºè¿è¡Œæ—¶ç³»ç»Ÿä¸èƒ½ç†è§£<code>Widget::operator new</code>çš„å·¥ä½œï¼Œå®ƒå°±ä¸èƒ½æ’¤å›å†…å­˜åˆ†é…æ“ä½œï¼Œè½¬è€Œå¯»æ‰¾å’Œ<code>Widget::operator new</code>é…å¥—çš„ï¼Œ<strong>æœ‰çš„ç›¸åŒæ•°ç›®å’Œç›¸åŒç±»å‹çš„é¢å¤–å‚æ•°</strong>çš„operator deleteå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">ostream</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ç±»æ¯”placement newï¼Œç›¸é…å¥—çš„ç§°ä¸ºplacement deleteï¼Œä½†æ˜¯åˆ°ç°åœ¨Widgetä¹Ÿæ²¡æœ‰å£°æ˜å¦‚ä¸Šæ‰€ç¤ºçš„placement deleteï¼Œå› æ­¤è¿è¡Œç³»ç»Ÿæ‰¾ä¸åˆ°é…å¥—çš„deleteï¼Œç»“æœæ˜¯å®ƒé€‰æ‹©ä»€ä¹ˆä¹Ÿä¸å¹²ï¼Œå› æ­¤ï¼Œä¸ºäº†æ¶ˆé™¤å¯èƒ½çš„å†…å­˜æ³„éœ²ï¼Œå¦‚æœå®šä¹‰äº†é¢å¤–å‚æ•°çš„newæ“ä½œç¬¦ï¼Œå°±å¿…é¡»æä¾›å¯¹åº”çš„deleteæ“ä½œç¬¦ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Widget</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">ostream</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> logStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">bad_alloc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> pMemory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> pMemory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">ostream</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> logStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ç°åœ¨å½“<code>Widget *pw = new (std::cerr) Widget;</code>æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œå¯¹åº”çš„deleteä¼šè¢«è°ƒç”¨ç¡®ä¿æ²¡æœ‰å†…å­˜æ³„éœ²ï¼Œå¦‚æœæ²¡æœ‰å¼‚å¸¸æŠ›å‡ºï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨deleteåˆ é™¤å¯¹è±¡<code>delete pw;</code>ï¼Œæ­¤æ—¶è°ƒç”¨çš„æ˜¯æ­£å¸¸çš„deleteï¼Œplacement deleteåªæœ‰åœ¨placement newæŠ›å‡ºå¼‚å¸¸æ—¶æ‰è¢«è°ƒç”¨ï¼Œç›´æ¥ä½¿ç”¨deleteåŠ æŒ‡é’ˆæ°¸è¿œä¸ä¼šè°ƒç”¨placement deleteï¼Œè¿™æ„å‘³ç€ä½ éœ€è¦åŒæ—¶æä¾›æ­£å¸¸çš„deleteå’Œplacement deleteæ¥é˜²æ­¢å†…å­˜æ³„éœ²ã€‚å¦å¤–ï¼Œç”±äºæˆå‘˜å‡½æ•°ä¼šè¦†ç›–ç±»å¤–çš„åŒåå‡½æ•°ï¼Œéœ€è¦é¿å…ç±»çš„newæ“ä½œç¬¦å‡½æ•°è¦†ç›–å…¶ä»–çš„newæ“ä½œç¬¦å‡½æ•°ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Base</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">ostream</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> logStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">bad_alloc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Base </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pb </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> Base</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// é”™è¯¯ï¼</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">Base </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pb </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">cerr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> Base</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// æ­£ç¡®ï¼Œè°ƒç”¨placement new</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Baseç±»åªå£°æ˜äº†placement newï¼Œæ— æ³•ä½¿ç”¨æ­£å¸¸çš„newï¼Œç±»ä¼¼çš„ï¼Œæ´¾ç”Ÿç±»çš„newæ“ä½œç¬¦ä¼šè¦†ç›–å…¨å±€å’Œç»§æ‰¿çš„newæ“ä½œç¬¦ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Derived</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause class-name">public</span><span class="token base-clause"> </span><span class="token base-clause class-name">Base</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">bad_alloc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Derived </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">clog</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> Derived</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// é”™è¯¯ï¼ŒåŸºç±»çš„operator newå‡½æ•°è¢«è¦†ç›–</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">Derived </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> Derived</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Item33è®¨è®ºäº†è¯¦ç»†è®¨è®ºäº†è¿™ç§åç§°è¦†ç›–çš„æƒ…å†µï¼Œä½†æ˜¯å¯¹äºè‡ªå®šä¹‰å†…å­˜åˆ†é…å‡½æ•°ï¼Œä½ åªéœ€è¦è®°ä½é»˜è®¤C++æä¾›ä»¥ä¸‹ä¸‰ç§å½¢å¼çš„å…¨å±€operator newï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">bad_alloc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// æ­£å¸¸new</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                 </span><span class="token comment" style="color:#999988;font-style:italic">// placement new</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">nothrow_t</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// nothrow new</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>å¦‚æœä½ åœ¨ç±»ä¸­å£°æ˜ä»»ä½•operator newå‡½æ•°ï¼Œå°±ä¼šè¦†ç›–ä»¥ä¸Šçš„æ ‡å‡†å½¢å¼ï¼Œé™¤éä½ æ•…æ„ä¸ä½¿ç”¨æ ‡å‡†å½¢å¼çš„newï¼Œç¡®ä¿å®ƒä»¬å¯ç”¨ï¼Œå¯¹äºæ¯ç§å¯ç”¨çš„operator newï¼Œç¡®ä¿æœ‰å¯¹åº”çš„operator deleteï¼Œå¦‚æœæƒ³è®©è¿™äº›å‡½æ•°è¡¨ç°æ­£å¸¸çš„è¡Œä¸ºï¼Œåªè¦ç±»æˆå‘˜operator new/deleteè°ƒç”¨å…¨å±€operator new/deleteå³å¯ï¼Œä¸€ç§ç®€å•çš„å®ç°æ–¹å¼æ˜¯åˆ›å»ºåŒ…å«æ­£å¸¸æ¨¡å¼new/deleteçš„åŸºç±»ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">StandardNewDeleteForms</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// normal new/delete</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">bad_alloc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pMemory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pMemory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// placement new/delete</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ptr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ptr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pMemory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ptr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pMemory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ptr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// nothrow new/delete</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">nothrow_t</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> nt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pMemory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">nothrow_t</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> nt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pMemory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ç»§æ‰¿å’Œusingå£°æ˜(è§Item33)åœ¨æ ‡å‡†å½¢å¼çš„åŸºç¡€ä¸Šå¢åŠ è‡ªå®šä¹‰éƒ¨åˆ†ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Widget</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause class-name">public</span><span class="token base-clause"> </span><span class="token base-clause class-name">StandardNewDeleteForms</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> StandardNewDeleteForms</span><span class="token operator" style="color:#393A34">::</span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">// å¼•å…¥åŸºç±»æ‰€æœ‰é‡è½½ç‰ˆæœ¬çš„new</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> StandardNewDeleteForms</span><span class="token operator" style="color:#393A34">::</span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delete</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// å¼•å…¥åŸºç±»æ‰€æœ‰é‡è½½ç‰ˆæœ¬çš„delete</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">size_t size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">ostream</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> logStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">bad_alloc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">operator</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pMemory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">ostream</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> logStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>æ€»ç»“</h5></div><div class="admonition-content"><p>è‡ªå®šä¹‰placement newç¡®ä¿ä¹Ÿè¦è‡ªå®šä¹‰å¯¹åº”çš„deleteï¼Œå¦åˆ™ç¨‹åºä¼šå‡ºç°å¾®å¦™çš„ï¼Œé—´æ­‡çš„å†…å­˜æ³„éœ²ï¼›å½“å£°æ˜placement new/deleteæ—¶ï¼Œé™¤éæœ‰æ„è€Œä¸ºä¹‹ï¼Œä¸è¦è¦†ç›–æ­£å¸¸ç‰ˆæœ¬çš„new/delete</p></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/docs/tags/effective-c">Effective-C++</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/docs/tags/reading-notes">ReadingNotes</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/docs/tags/c">C++</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/kayhaw/kayhaw.github.io/edit/master/website/docs/EffectiveC++/Effective-C++-Chap8.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/EffectiveC++/Effective-C++-Chap7"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« æ¨¡æ¿å’Œæ³›å‹ç¼–ç¨‹</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/EffectiveC++/Effective-C++-Chap9"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">æ‚å½• Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#item49ç†è§£new-handlerçš„è¡Œä¸º" class="table-of-contents__link">Item49:ç†è§£new-handlerçš„è¡Œä¸º</a></li><li><a href="#item50ç†è§£ä½•æ—¶æ›¿ä»£newå’Œdeleteæ‰æœ‰æ„ä¹‰" class="table-of-contents__link">Item50:ç†è§£ä½•æ—¶æ›¿ä»£newå’Œdeleteæ‰æœ‰æ„ä¹‰</a></li><li><a href="#item51é‡å†™newå’Œdeleteæ—¶åšæŒæƒ¯ä¾‹" class="table-of-contents__link">Item51:é‡å†™newå’Œdeleteæ—¶åšæŒæƒ¯ä¾‹</a></li><li><a href="#item52å¦‚æœè‡ªå®šä¹‰placement-newåˆ™è¦è‡ªå®šä¹‰å¯¹åº”çš„delete" class="table-of-contents__link">Item52:å¦‚æœè‡ªå®šä¹‰placement newåˆ™è¦è‡ªå®šä¹‰å¯¹åº”çš„delete</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">è¯»ä¹¦ç¬”è®°</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://www.zhihu.com/people/xiao-ke-dou-7" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>çŸ¥ä¹<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/kayhaw" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://gitee.com/kayhaw" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 ä½•è½²(Kay Haw). Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.ed6f7924.js"></script>
<script src="/assets/js/main.87f14a62.js"></script>
</body>
</html>