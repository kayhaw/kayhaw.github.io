<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Kay Haw&#39;s Blog Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Kay Haw&#39;s Blog Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"><title data-react-helmet="true">Time-Based and Window Operators | Kay Haw&#x27;s Blog</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://kayhaw.github.io/docs/Stream Processing with Apache Flink/Stream-Processing-with-Apache-Flink-Chap06"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Time-Based and Window Operators | Kay Haw&#x27;s Blog"><meta data-react-helmet="true" name="description" content="Stream Processing with Apache Flink 第6章读书笔记"><meta data-react-helmet="true" property="og:description" content="Stream Processing with Apache Flink 第6章读书笔记"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://kayhaw.github.io/docs/Stream Processing with Apache Flink/Stream-Processing-with-Apache-Flink-Chap06"><link data-react-helmet="true" rel="alternate" href="https://kayhaw.github.io/docs/Stream Processing with Apache Flink/Stream-Processing-with-Apache-Flink-Chap06" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://kayhaw.github.io/docs/Stream Processing with Apache Flink/Stream-Processing-with-Apache-Flink-Chap06" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.0138175c.css">
<link rel="preload" href="/assets/js/runtime~main.7b33080d.js" as="script">
<link rel="preload" href="/assets/js/main.9bda434a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Kay Haw&#x27;s Blog" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Kay Haw&#x27;s Blog" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Kay Haw&#x27;s Blog</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro">读书笔记</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/kayhaw" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/intro">读书笔记</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">C++PrimerPlus</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">EffectiveC++</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Learning Akka</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Stream Processing with Apache Flink</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream Processing with Apache Flink/Stream-Processing-with-Apache-Flink-Chap01">状态流处理简介</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream Processing with Apache Flink/Stream-Processing-with-Apache-Flink-Chap02">流处理基础</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream Processing with Apache Flink/Stream-Processing-with-Apache-Flink-Chap03">Apache Flink架构</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream Processing with Apache Flink/Stream-Processing-with-Apache-Flink-Chap04">Apache Flink开发环境搭建</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream Processing with Apache Flink/Stream-Processing-with-Apache-Flink-Chap05">DataStream API(v.14.0)</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Stream Processing with Apache Flink/Stream-Processing-with-Apache-Flink-Chap06">Time-Based and Window Operators</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream Processing with Apache Flink/drift">drift</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Java并发编程实战</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">深入理解Java虚拟机</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">高性能MySQL</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Time-Based and Window Operators</h1></header><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p><em>Stream Processing with Apache Flink</em> 第6章读书笔记
示例代码见<a href="https://github.com/kayhaw/flink-example" target="_blank" rel="noopener noreferrer">flink-example</a></p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="设置时间语义"></a>设置时间语义<a class="hash-link" href="#设置时间语义" title="Direct link to heading">#</a></h2><p>Flink应用的时间语义由StreamExecutionEnvironment的属性timeCharacteristic确定，它可以设置如下枚举值：</p><ol><li><p><strong>TimeCharacteristic.ProcessingTime</strong>：设置时间语义为处理时间，计算结果快但是不准确，会漏掉延迟数据。</p></li><li><p><strong>TimeCharacteristic.EventTime</strong>：设置时间语义为事件时间，数据自身提供timestamp。Timestamp可以是数据本身的一个字段，也可以在source算子上赋值。计算结果准确，为了处理乱序数据会有延迟。</p></li><li><p><strong>TimeCharacteristic.IngestionTime</strong>：指定source算子的处理时间为事件时间，可以视为ProcessingTime和EventTime的结合体。</p></li></ol><p>通过<del><code>env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime)</code></del>指定应用时间语义，但从Flink 1.12起应用的默认时间语义就是<strong>EventTime</strong>，因此setStreamTimeCharacteristic已经过时，不推荐使用。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="指定timestamp和生成水印"></a>指定timestamp和生成水印<a class="hash-link" href="#指定timestamp和生成水印" title="Direct link to heading">#</a></h2><p>当设置时间语义为事件时间后，需要指定timestamp和生成水印，这里有2种方式实现：</p><ol><li><p>在SourceFunction中设置</p></li><li><p>调用<del>assignTimestampsAndWatermarks(TimestampAssigner)</del>方法</p></li></ol><p>根据<strong>水印生成离数据源越近越安全</strong>的原则，调用assignTimestampsAndWatermarks应该紧跟着source方法之后，位于所有基于事件时间的function之前，最好直接在SourceFunction中生成水印。</p><p>TimestampAssigner接口还派生出AssignerWithPeriodicWatermarks和AssignerWithPunctuatedWatermarks，表示不同的生成策略。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="周期性水印"></a><del>周期性水印</del><a class="hash-link" href="#周期性水印" title="Direct link to heading">#</a></h3><p>周期性水印默认每200ms发送一次水印，通过<code>StreamExecutionEnvironment.getConfig.setAutoWatermarkInterval(int)</code>设置发送间隔，或者实现AssignerWithPeriodicWatermarks接口的getCurrentWatermark方法。DataStream API还提供如下2个快捷项：</p><ol><li><p>如果确认输入数据的时间戳单调递增，使用快捷方法assignAscendingTimeStamps设置timestamp和水印。</p></li><li><p>如果数据乱序到达，使用BoundedOutOfOrdernessTimeStampExtractor设置timestamp和水印。</p></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="间断性水印"></a><del>间断性水印</del><a class="hash-link" href="#间断性水印" title="Direct link to heading">#</a></h3><p>间断性水印的生成由输入数据的某些属性确定，AssignerWithPunctuatedWatermarks接口定义了checkAndGetNextWatermark()方法，该方法在每次的extractTimestamp()调用后执行，如下所示代码在id包含&quot;sensor_1&quot;时产生水印：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class SensorTimeAssigner implements AssignerWithPunctuatedWatermarks&lt;SensorReading&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Nullable</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Watermark checkAndGetNextWatermark(SensorReading lastElement, long extractedTimestamp) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(&quot;sensor_1&quot;.equals(lastElement.id)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new Watermark(extractedTimestamp - 60*1000);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public long extractTimestamp(SensorReading element, long recordTimestamp) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return element.timestamp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</h5></div><div class="admonition-content"><p>AssignerWithPeriodicWatermarks和AssignerWithPunctuatedWatermarks接口已经过时，使用WatermarkStrategy代替。</p></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="水印延迟和完整度"></a>水印，延迟和完整度<a class="hash-link" href="#水印延迟和完整度" title="Direct link to heading">#</a></h3><p>水印用于调整延迟和结果完整度的平衡，即算子在等待多久后触发计算。现实中无法设置完美的水印，因为网络等各种因素影响着结果。水印设置过大，等待时间增加，状态变量增大，但结果更准确。水印设置过小，等待时间缩减但结果不准确。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="处理函数"></a>处理函数<a class="hash-link" href="#处理函数" title="Direct link to heading">#</a></h2><p>DataStream API提供了比转换函数更底层的处理函数(Process Function)，其功能更加丰富，比如可以访问timestamp和水印。Flink提供的处理函数有：</p><ul><li>ProcessFunction</li><li>KeyedProcessFunction</li><li>CoProcessFunction</li><li>ProcessJoinFunction</li><li>BroadcastProcessFunction</li><li>KeyedBroadcastProcessFunction</li><li>ProcessWindowFunction</li></ul><p>由于这些接口类似，以KeyedProcessFunction为例介绍，该接口提供如下方法：</p><ol><li><code>processElement(I value, Context ctx, Collector&lt;O&gt; out)</code>：处理流上的每个记录value，将结果输出到out。Context对象提供timestamp和TimerService。</li><li><code>onTimer(long timestamp, OnTimerContext ctx, Collector&lt;O&gt; out)</code>：设置定时器的回调方法。</li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="timerservice和timer"></a>TimerService和Timer<a class="hash-link" href="#timerservice和timer" title="Direct link to heading">#</a></h3><p>Context和OnTimerContext都包含TimerService对象，它提供如下方法：</p><ul><li><code>long currentProcessingTime()</code>：返回当前处理时间</li><li><code>long currentWatermark()</code>：返回当前水印</li><li><code>void registerProcessingTimeTimer(long time)</code>：注册一个处理时间定时器</li><li><code>void registerEventTimeTimer(long time)</code>：注册一个事件时间定时器</li><li><code>void deleteProcessingTimeTimer(long timestamp)</code>：删除一个处理时间定时器，如果不存在则什么也不做</li><li><code>void deleteEventTimeTimer(long timestamp)</code>：删除一个事件时间定时器，如果不存在则什么也不做</li></ul><p>定时器触发后执行<code>onTimer()</code>回调，它和<code>processElement()</code>是同步的，避免并发访问状态。定时器会和其他状态一起被检查点保存。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="发送到side-outputs"></a>发送到Side Outputs<a class="hash-link" href="#发送到side-outputs" title="Direct link to heading">#</a></h3><p>通常情况下DataStream API中算子只输出单个流，只有split算子输出多个流(且基本类型不变)。但处理函数特殊之处在于它们有侧输出(Side Output)，并且基本类型可变，如下所示：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">DataStream&lt;SensorReading&gt; monitoredReadings = readings.process(new FreezingMonitor());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// 获取侧输出流并打印</span></span><span class="token-line" style="color:#393A34"><span class="token plain">monitorReadings.getSideOutput(new OutputTag&lt;String&gt;(&quot;freezing-alarms&quot;)).print();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public static class FreezingMonitor extends ProcessFunction&lt;SensorReading, SensorReading&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    OutputTag&lt;String&gt; freezingAlarmOutput = new OutputTag&lt;&gt;(&quot;freezing-alarms&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void processElement(SensorReading value, Context ctx, Collector&lt;SensorReading&gt; out) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(value.temperature &lt; 32.0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ctx.output(freezingAlarmOutput, &quot;Freezing Alarm for &quot; + value.id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        out.collect(value);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>在processElement方法中通过Context.output()发送侧输出数据，侧输出由OutputTag对象标记识别。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="coprocessfunction"></a>CoProcessFunction<a class="hash-link" href="#coprocessfunction" title="Direct link to heading">#</a></h3><p>对于处理2个流的底层操作，DataStream API提供CoProcessFunction。和CoMapFunction类似，它提供processElement1()和processElement2()两个方法分别处理每个流的输入。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="窗口操作"></a>窗口操作<a class="hash-link" href="#窗口操作" title="Direct link to heading">#</a></h2><p>窗口操作使得在无界的流上进行聚合函数计算称为可能，本节介绍如何定义窗口算子、内置窗口类型、窗口可用函数和如何自定义窗口逻辑。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="定义窗口算子"></a>定义窗口算子<a class="hash-link" href="#定义窗口算子" title="Direct link to heading">#</a></h3><p>KeyedStream或者非KeyedStream都可以使用窗口算子，创建窗口算子需要指定如下两个组件：</p><ol><li><p>Window Assigner：决定元素如何组成窗口，即生成WindowedStream或者AllWindowedStream(在非KeyedStream上)。</p></li><li><p>Window Function：处理WindowedStream或者AllWindowedStream的元素</p></li></ol><p>如下所示为窗口操作和窗口函数使用的伪代码：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">// define a keyed window operator</span></span><span class="token-line" style="color:#393A34"><span class="token plain">stream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  .keyBy(...)                 </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  .window(...)                   // specify the window assigner</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  .reduce/aggregate/process(...) // specify the window function</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// define a nonkeyed window-all operator</span></span><span class="token-line" style="color:#393A34"><span class="token plain">stream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  .windowAll(...)                // specify the window assigner</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  .reduce/aggregate/process(...) // specify the window function</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="内置window-assigner"></a>内置Window Assigner<a class="hash-link" href="#内置window-assigner" title="Direct link to heading">#</a></h3><p>Flink内置了许多Window Assigner满足不同使用场景，本节讨论基于时间的窗口操作(基于计数的窗口操作结果不准确)。每个窗口都有一个开始时间和一个结束时间，窗口的范围是<strong>左闭右开</strong>。以下介绍内置的开窗算子：</p><ul><li>滚动窗口</li></ul><p>滚动窗口算子将元素分为固定大小，互不重叠的窗口，如下图所示：</p><img style="width:80%;height:80%" src="/img/doc/Stream-Processing-with-Apache-Flink/chap06/A-Tumbling-Window-Assigner-Example.png" title="A Tumbling Window Assigner Example"><p>对于事件时间语义和处理时间语义，DataStream API分别提供TumblingEventTimeWindows和TumblingProcessingTimeWindows。使用其静态方法<code>of(Time size, Time offset)</code>指定窗口大小和偏移量，代码如下所示：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">sensorData.keyBy(r -&gt; r.id)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // timeWindow(Time.seconds(1))已过时，它实际上是下面代码的封装</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          .window(TumblingEventTimeWindows.of(Time.hours(1), Time.minutes(15)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          .process(new TemperatureAverager());</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>滚动窗口默认和1970-01-01 00:00:00对齐，以上示例代码定义了[00:15:00-01:15:00)，[00:15:00-02:15:00)...窗口。</p><ul><li>滑动窗口</li></ul><p>滑动窗口算子将元素分为固定大小，偏移指定大小的窗口，如下图所示：</p><img style="width:80%;height:80%" src="/img/doc/Stream-Processing-with-Apache-Flink/chap06/A-Sliding-Window-Assigner-Example.png" title="A Sliding Window Assigner Example"><p>滚动窗口需要指定窗口大小size和滑动步长slide。<strong>如果slide小于size，那么会有一些元素属于两个窗口，如果slide大于size，那么会有一些元素没有包含在窗口中。</strong>如下代码演示大小为1个小时，步长为15分钟的滑动窗口操作：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">sensorData.keyBy(r -&gt; r.id)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          .window(SlidingEventTimeWindows.of(Time.hours(1), Time.minutes(15)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          .process(new TemperatureAverager());</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/docs/tags/stream-processing">Stream Processing</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/docs/tags/apache-flink">Apache Flink</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/docs/tags/reading-notes">ReadingNotes</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/kayhaw/kayhaw.github.io/edit/master/website/docs/Stream Processing with Apache Flink/Stream-Processing-with-Apache-Flink-Chap06.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/Stream Processing with Apache Flink/Stream-Processing-with-Apache-Flink-Chap05"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« DataStream API(v.14.0)</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/Stream Processing with Apache Flink/drift"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">drift »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#设置时间语义" class="table-of-contents__link">设置时间语义</a></li><li><a href="#指定timestamp和生成水印" class="table-of-contents__link">指定timestamp和生成水印</a><ul><li><a href="#周期性水印" class="table-of-contents__link"><del>周期性水印</del></a></li><li><a href="#间断性水印" class="table-of-contents__link"><del>间断性水印</del></a></li><li><a href="#水印延迟和完整度" class="table-of-contents__link">水印，延迟和完整度</a></li></ul></li><li><a href="#处理函数" class="table-of-contents__link">处理函数</a><ul><li><a href="#timerservice和timer" class="table-of-contents__link">TimerService和Timer</a></li><li><a href="#发送到side-outputs" class="table-of-contents__link">发送到Side Outputs</a></li><li><a href="#coprocessfunction" class="table-of-contents__link">CoProcessFunction</a></li></ul></li><li><a href="#窗口操作" class="table-of-contents__link">窗口操作</a><ul><li><a href="#定义窗口算子" class="table-of-contents__link">定义窗口算子</a></li><li><a href="#内置window-assigner" class="table-of-contents__link">内置Window Assigner</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">读书笔记</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://www.zhihu.com/people/xiao-ke-dou-7" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>知乎<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/kayhaw" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://gitee.com/kayhaw" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 何轲(Kay Haw). Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.7b33080d.js"></script>
<script src="/assets/js/main.9bda434a.js"></script>
</body>
</html>