<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Kay Haw&#39;s Blog Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Kay Haw&#39;s Blog Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"><title data-react-helmet="true">运维Flink和流应用 | Kay Haw&#x27;s Blog</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://kayhaw.github.io/docs/Stream-Processing-with-Apache-Flink/Chap10"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="运维Flink和流应用 | Kay Haw&#x27;s Blog"><meta data-react-helmet="true" name="description" content="Stream Processing with Apache Flink 第10章读书笔记"><meta data-react-helmet="true" property="og:description" content="Stream Processing with Apache Flink 第10章读书笔记"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://kayhaw.github.io/docs/Stream-Processing-with-Apache-Flink/Chap10"><link data-react-helmet="true" rel="alternate" href="https://kayhaw.github.io/docs/Stream-Processing-with-Apache-Flink/Chap10" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://kayhaw.github.io/docs/Stream-Processing-with-Apache-Flink/Chap10" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.0138175c.css">
<link rel="preload" href="/assets/js/runtime~main.ed6f7924.js" as="script">
<link rel="preload" href="/assets/js/main.87f14a62.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Kay Haw&#x27;s Blog" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Kay Haw&#x27;s Blog" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Kay Haw&#x27;s Blog</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro">读书笔记</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/kayhaw" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/intro">读书笔记</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">C++PrimerPlus</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">EffectiveC++</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Learning Akka</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Stream Processing with Apache Flink</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream-Processing-with-Apache-Flink/Chap01">状态流处理简介</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream-Processing-with-Apache-Flink/Chap02">流处理基础</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream-Processing-with-Apache-Flink/Chap03">Apache Flink架构</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream-Processing-with-Apache-Flink/Chap04">Apache Flink开发环境搭建</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream-Processing-with-Apache-Flink/Chap05">DataStream API(v.14.0)</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream-Processing-with-Apache-Flink/Chap06">Time-Based and Window Operators</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream-Processing-with-Apache-Flink/Chap07">Stateful Operators and Applications</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream-Processing-with-Apache-Flink/Chap08">读写外部系统</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream-Processing-with-Apache-Flink/Chap09">部署Flink环境</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Stream-Processing-with-Apache-Flink/Chap10">运维Flink和流应用</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream-Processing-with-Apache-Flink/Chap11">何去何从</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream Processing with Apache Flink/drift">drift</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Java并发编程实战</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">深入理解Java虚拟机</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">高性能MySQL</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>运维Flink和流应用</h1></header><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p><em>Stream Processing with Apache Flink</em> 第10章读书笔记</p></div></div><p>本章介绍如何使用Flink提供的工具运维长期运行的流引用，包括如何收集运行指标、监控应用、更新应用等。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="流应用的运行和管理"></a>流应用的运行和管理<a class="hash-link" href="#流应用的运行和管理" title="Direct link to heading">#</a></h2><p>流处理应用的维护比批处理应用更加复杂。由于周期性运行，批处理只要在运行间隔内进行应用的重配置、缩放和更新。而流处理持续运行，这些操作更加具有挑战性，但Flink提供了如下接口来简化流处理的运行和管理：</p><ol><li>一个命令行客户端工具，用于提交和控制应用；</li><li>Web UI，提供Flink集群和运行应用的信息，也能用于提交和管理应用；</li><li>REST API，客户端和Web UI所使用的底层接口，提供所有指标信息和应用提交、管理的端点。</li></ol><p>本节介绍保存点的使用方面，以及如何通过以上接口来启动、终止、暂停/恢复、缩放和升级流应用。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="保存点"></a>保存点<a class="hash-link" href="#保存点" title="Direct link to heading">#</a></h3><p>保存点基本等同于检查点，只是两者生命周期不同。检查点由Flink自动生成、故障时加载和删除，而保存点必须由用户手动或者外部服务触发，并且用于不会被Flink自动删除。</p><p>从文件系统上看，保存点就是一个目录，它的子目录包含所有任务的状态和一个包含所有数据文件绝对路径的二进制元数据文件。由于元数据保存的是绝对路径，因此挪动保存点目录就会导致其失效。保存点的路径格式和含义如下表所示：</p><table><thead><tr><th>路径</th><th>含义</th></tr></thead><tbody><tr><td><code>/savepoints/</code></td><td>检查点根路径</td></tr><tr><td><code>/savepoints/savepoint-:shortjobid-:savepointid/</code></td><td>某个检查点路径</td></tr><tr><td><code>/savepoints/savepoint-:shortjobid-:savepointid/_metadata</code></td><td>某个检查点的元数据文件</td></tr><tr><td><code>/savepoints/savepoint-:shortjobid-:savepointid/:xxx</code></td><td>算子状态检查点路径</td></tr></tbody></table><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="使用命令行管理应用"></a>使用命令行管理应用<a class="hash-link" href="#使用命令行管理应用" title="Direct link to heading">#</a></h3><p>Flink的命令行客户端<code>${FLINK_HOME}/bin/flink</code>从<code>${FLINK_HOME}/conf/flink-conf.yaml</code>文件读取集群配置，并提供启动、终止和管理应用的功能。以下命令均默认当前工作目录为Flink根目录。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="启动应用"></a>启动应用<a class="hash-link" href="#启动应用" title="Direct link to heading">#</a></h4><p>启动应用所使用的命令参数及其含义如下表所示：</p><table><thead><tr><th>命令示例</th><th>含义</th></tr></thead><tbody><tr><td><code>./bin/flink run ~/myApp.jar</code></td><td>以jar包中META-INF/MANIFEST.MF文件中的program-class属性指定类名的main方法为入口运行应用</td></tr><tr><td><code>./bin/flink run ~/myApp.jar my-arg1 my-arg2 my-arg3</code></td><td>追加应用运行参数</td></tr><tr><td><code>./bin/flink run -d ~/myApp.jar</code></td><td>选项<code>-d</code>表示detached模式运行，此时不会等待应用结束而是返回JobID</td></tr><tr><td><code>./bin/flink run -p 16 ~/myApp.jar</code></td><td>选项<code>-p</code>指定默认并行度为16</td></tr><tr><td><code>./bin/flink run -c my.app.MainClass ~/myApp.jar</code></td><td>选项<code>-c</code>指定入口类</td></tr><tr><td><code>./bin/flink run -m myMasterHost:9876 ~/myApp.jar</code></td><td>选项<code>-m</code>指定Flink master进程，默认使用<code>conf/flink-conf.yaml</code>指定值</td></tr></tbody></table><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="列出运行应用"></a>列出运行应用<a class="hash-link" href="#列出运行应用" title="Direct link to heading">#</a></h4><p>所有对于运行应用的操作都需要提供JobID，它可以从Web UI或者命令行获得，使用<code>./bin/flink list -r</code>列出所有运行应用。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="保存点操作"></a>保存点操作<a class="hash-link" href="#保存点操作" title="Direct link to heading">#</a></h4><p>使用<code>./bin/flink savepoint &lt;jobId&gt; [savepointPath]</code>存储一个保存点。由于保存点会占用大量空间且不会被Flink自动删除，通过<code>./bin/flink savepoint -d &lt;savepointPath&gt;</code>删除保存点。</p><div class="admonition admonition-danger alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>小心</h5></div><div class="admonition-content"><p>必须在另一个检查点或者保存点完成后才能删除保存点，否则故障恢复失败。</p></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="取消应用"></a>取消应用<a class="hash-link" href="#取消应用" title="Direct link to heading">#</a></h4><p>取消应用可以选择是否进行一次保存点操作，命令如下所示。通过<code>-s</code>区分是否进行保存点操作，如果未指定保存点路径则使用flink-conf.yaml中的参数值。<strong>如果保存点失败则应用继续进行，需要再次尝试取消应用。</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">./bin/flink cancel </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">jobId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 不带保存点取消应用</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">./bin/flink cancel -s </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">savepointPath</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">jobId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># 带保存点取消应用</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="从保存点中启动应用"></a>从保存点中启动应用<a class="hash-link" href="#从保存点中启动应用" title="Direct link to heading">#</a></h4><p>命令格式为<code>./bin/flink run -s &lt;savepointPath&gt; [options] &lt;jobJar&gt; [arguments]</code>。应该确保应用的每个算子使用<code>uid()</code>设置了唯一id，当应用修改后存在如下3中兼容型情况：</p><ol><li>添加状态，该状态初始化为空；</li><li>删除状态，Flink为了安全不会启动应用，通过<code>-n</code>选项强制启动；</li><li>改变状态原语或者状态数据类型，应用启动失败。</li></ol><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="缩放应用"></a>缩放应用<a class="hash-link" href="#缩放应用" title="Direct link to heading">#</a></h4><p>如果应用算子的并行度是硬编码在应用中与默认并行度无关，缩放应用分为保存点、取消应用、以新并行度重启3个步骤。如果应用算子的并行度依赖于默认并行度，缩放应用可以简单地通过<code>./bin/flink modify &lt;jobId&gt; -p &lt;newParallelism&gt;</code>命令实现。具体细节见<a href="/docs/Stream-Processing-with-Apache-Flink/Chap03/#%E7%BC%A9%E6%94%BE%E7%8A%B6%E6%80%81%E7%AE%97%E5%AD%90">缩放状态算子</a>。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="通过rest-api管理应用"></a>通过REST API管理应用<a class="hash-link" href="#通过rest-api管理应用" title="Direct link to heading">#</a></h3><p>Dispatcher进程中运行的web服务器同时提供REST API和Web UI服务，默认端口为8081，在flink-conf.yaml文件中通过<code>rest.port</code>参数修改，指定值-1将会禁用REST API和Web UI。通常使用curl工具与REST API交互，使用格式如下：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -X </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">HTTP-Method</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">-d </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">parameters</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> http://hostname:port/v1/</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">REST-point</span><span class="token operator" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>接下来介绍Flink提供的一些重要REST接口，完整列表见<a href="https://nightlies.apache.org/flink/flink-docs-release-1.14/docs/ops/rest_api/" target="_blank" rel="noopener noreferrer">REST API</a></p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="管理和监控flink集群"></a>管理和监控Flink集群<a class="hash-link" href="#管理和监控flink集群" title="Direct link to heading">#</a></h4><table><thead><tr><th>请求方式</th><th>请求路径</th><th>功能</th></tr></thead><tbody><tr><td>GET</td><td>/overview</td><td>Flink集群概览</td></tr><tr><td>GET</td><td>/jobmanager/config</td><td>返回集群配置</td></tr><tr><td>GET</td><td>/taskmanagers</td><td>返回所有taskmanager概览</td></tr><tr><td>GET</td><td>/jobmanager/metrics</td><td>返回jobmanager上的统计指标，通过<code>get</code>参数指定具体指标</td></tr><tr><td>GET</td><td>/taskmanagers/&lt;tmId&gt;/metrics</td><td>返回某个TaskManager上的统计指标，通过<code>get</code>参数指定具体指标</td></tr><tr><td>DELETE</td><td>/cluster</td><td>关闭集群，<strong>在standalone模式下master终止但是worker进程继续运行</strong></td></tr></tbody></table><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="管理和监控flink应用"></a>管理和监控Flink应用<a class="hash-link" href="#管理和监控flink应用" title="Direct link to heading">#</a></h4><table><thead><tr><th>请求方式</th><th>请求路径</th><th>功能</th></tr></thead><tbody><tr><td>POST</td><td>/jars/upload</td><td>上传应用jar包，成功则返回存储路径</td></tr><tr><td>GET</td><td>/jars</td><td>查看所有jar包信息，包含id、上传时文件名、上传时间等</td></tr><tr><td>DELETE</td><td>/jars/&lt;jarId&gt;</td><td>删除指定id jar包</td></tr><tr><td>POST</td><td>/jars/&lt;jarId&gt;/run</td><td>指定jar包运行，返回job id</td></tr><tr><td>GET</td><td>/jobs</td><td>获取所有job id</td></tr><tr><td>GET</td><td>/jobs/&lt;jobId&gt;</td><td>获取指定id的作业运行信息</td></tr><tr><td>PATCH</td><td>/jobs/&lt;jobId&gt;</td><td>取消应用</td></tr><tr><td>POST</td><td>/jobs/&lt;jobId&gt;/savepoints</td><td>对指定应用进行保存点操作，需要传入json描述保存点位置和是否取消任务。返回一个请求id，用于检查保存是否成功</td></tr><tr><td>POST</td><td>/savepoint-disposal</td><td>查看检查点处理情况，请求体包含request-id</td></tr><tr><td>PATCH</td><td>/jobs/&lt;jobId&gt;/rescaling</td><td>修改应用并行度，会进行保存点、取消然后重启应用，请求参数parallelism设置新的并行度</td></tr></tbody></table><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="以容器形式绑定和部署应用"></a>以容器形式绑定和部署应用<a class="hash-link" href="#以容器形式绑定和部署应用" title="Direct link to heading">#</a></h3><p>Flink的<a href="/docs/Stream-Processing-with-Apache-Flink/Chap03/#%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2">应用部署</a>有2种方式：提交给集群的framework模式和应用与容器绑定的library模式。目前为止启动应用的方式都是framework模式。</p><p>Library模式下应用与Flink Docker镜像绑定，然后以JobManager或者TaskManager形式启动。当镜像作为JobManager启动，容器会启动Flink master进程然后立即执行绑定的应用；当镜像作为TaskManager启动，它会将其登记到JobManager下，等slot充足后JobManager执行绑定应用。本节介绍如何构建应用绑定的Docker镜像并将其部署在K8S上。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="构建应用特定的flink-docker镜像"></a>构建应用特定的Flink Docker镜像<a class="hash-link" href="#构建应用特定的flink-docker镜像" title="Direct link to heading">#</a></h4><p>Flink提供了一个构建特定应用的Docker镜像脚本，它位于源码仓库(<code>${repository_dir}/flink-container/docker/build.sh</code>)而不包含在二进制发行版本中。脚本使用示例如下：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> ./flink-container/docker</span></span><span class="token-line" style="color:#393A34"><span class="token plain">./build.sh </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --from-archive </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">path-to-Flink-1.14.0-archive</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --job-jar </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">path-to-example-apps-JAR-file</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    --image-name kayhaw</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>该脚本所需3个参数依次为Flink二进制包、应用jar包和打包镜像名，构建成功后运行<code>docker images</code>命令可以看到名为<code>kayhaw</code>的镜像。除了build.sh外该目录也包含了<code>docker-compose.yml</code>文件，结合<code>docker-compose</code>用于部署Flink应用，使用示例如下：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">FLINK_DOCKER_IMAGE_NAME</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">flink-book-jobs </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">FLINK_JOB</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">io.github.streamingwithflink.chapter1.AverageSensorReadings </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">DEFAULT_PARALLELISM</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  docker-compose up -d</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="在k8s上运行应用特定的docker镜像"></a>在K8S上运行应用特定的Docker镜像<a class="hash-link" href="#在k8s上运行应用特定的docker镜像" title="Direct link to heading">#</a></h4><p>在K8S上运行应用特定的Flink Docker镜像和在<a href="/docs/Stream-Processing-with-Apache-Flink/Chap09/#Kubernetes">K8S</a>启动集群的操作类似，只需要修改下yaml文件即可。Flink源码也提供了yaml文件模板(<code>${repository_dir}flink-container/kubernetes</code>目录下)，分别是配置master容器的<em>job-cluster-job.yaml.template</em>文件和配置worker容器的<em>task-manager-deployment.yaml.template</em>文件。</p><p>使用该模板文件时需要为3个参数设置值，分别是<code>${FLINK_IMAGE_NAME}</code>(镜像名称，比如上一小节生成的<code>kayhaw</code>)、<code>${FLINK_JOB}</code>(入口类名)和<code>${FLINK_JOB_PARALLELISM}</code>(任务并发度，也是worker容器数量)。可以看到这3个参数和上一小节使用docker-compose命令时一样，另外在kubernetes目录下也提供了定义K8S service的<em>job-cluster-service.yaml</em>文件。当所有模板文件都配置好后，使用<code>kubectl</code>命令启动服务：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create -f job-cluster-service.yaml</span></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create -f job-cluster-job.yaml</span></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create -f task-manager-deployment.yaml</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="控制任务调度"></a>控制任务调度<a class="hash-link" href="#控制任务调度" title="Direct link to heading">#</a></h2><p>Flink应用的性能依赖于任务调度：task分配给哪个worker进程、task之间配合关系、task实例数等都影响着应用性能。</p><p>在<a href="/docs/Stream-Processing-with-Apache-Flink/Chap03/#%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C">任务执行</a>中介绍Flink如何给task分配slot以及利用task chaining减少数据交换开销。本节介绍如何调整默认行为以及控制task chaining、任务分配来改善应用性能。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="控制task-chaining"></a>控制Task Chaining<a class="hash-link" href="#控制task-chaining" title="Direct link to heading">#</a></h3><p>Flink默认开启task chaining机制，它将多个算子的并行任务融合为单个任务并以线程运行。融合任务之间通过方法调用实现数据交换，因此免去了通信开销。</p><p>但是task chaining并不是对所有应用都有好处，比如运行开销高的函数就应该在不同slot上进行。此时可以通过如下代码禁用应用的task chaining：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">StreamExecutionEnvironment.disableOperatorChaining()</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>如果需要更细粒度的控制task chaining，可以在特定算子上调用<code>disableChaining()</code>方法，此时该算子不会和其前置、后继节点融合为chain。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">DataStream&lt;Y&gt; result = input</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  .filter(new Filter1())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  .map(new Map1())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // disable chaining for Map2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  .map(new Map2()).disableChaining()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  .filter(new Filter2())</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>通过<code>startNewChain()</code>方法开启新task chain，此时节点与其后继节点融合为一个新chain：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">DataStream&lt;Y&gt; result = input</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  .filter(new Filter1())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  .map(new Map1())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // start a new chain for Map2 and Filter2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  .map(new Map2()).startNewChain()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  .filter(new Filter2())</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="定义slot共享组"></a>定义slot共享组<a class="hash-link" href="#定义slot共享组" title="Direct link to heading">#</a></h3><p>Flink默认的任务调度策略是将程序的一个slice分配给一个slot，每个slice包含程序算子最多一个示例任务。这种默认策略可能会使某个slot负荷过大，Flink提供slot共享组机制能让用户手动的控制任务分配。</p><p>Slot共享组与算子一一对应，同一共享组内的算子任务使用同一个slot。在Slot共享组内，每个slot只分配算子的一个task示例，因此<strong>一个slot共享组所需的slot数量等于算子的最大并行度</strong>。</p><p>每个算子默认分配到<em>default</em>共享组，算子可以通过<code>slotSharingGroup(String)</code>显式指定共享组，如下代码所示。一个算子从其前置算子继承相同的共享组，否则是<em>default</em>组。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">// a设置slot共享组green</span></span><span class="token-line" style="color:#393A34"><span class="token plain">DataStream&lt;A&gt; a = env.createInput(...)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  .slotSharingGroup(&quot;green&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  .setParallelism(4)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">DataStream&lt;B&gt; b = a.map(...)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// b从a继承slot共享组green</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  .setParallelism(4)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// c设置slot共享组yellow</span></span><span class="token-line" style="color:#393A34"><span class="token plain">val c: DataStream[C] = env.createInput(...)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  .slotSharingGroup(&quot;yellow&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  .setParallelism(2)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// d设置slot共享组blue</span></span><span class="token-line" style="color:#393A34"><span class="token plain">val d: DataStream[D] = b.connect(c.broadcast(...)).process(...)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  .slotSharingGroup(&quot;blue&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  .setParallelism(4)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">val e = d.addSink()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// e从d继承共享组blue</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  .setParallelism(2)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>如上代码对应的物理流图如下所示，一共需要10个slot(4+4+2)。</p><img style="width:80%;height:80%" src="/img/doc/Stream-Processing-with-Apache-Flink/chap10/Controlling-Task-Scheduling-with-Slot-Sharing-Groups.png" title="Controlling Task Scheduling with Slot-sharing Groups"><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="调整检查点和故障恢复"></a>调整检查点和故障恢复<a class="hash-link" href="#调整检查点和故障恢复" title="Direct link to heading">#</a></h2><p>Flink通过周期性检查点确保容错性，但是检查点每次对状态进行快照的开销巨大。增加检查点间隔可以减少开销，但是也增加了程序恢复时处理的数据量。本节介绍如何通过Flink提供的参数调优检查点和状态后端性能。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="配置检查点"></a>配置检查点<a class="hash-link" href="#配置检查点" title="Direct link to heading">#</a></h3><p>首先在开启检查点的同时需要指定运行间隔，如下代码所示：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">StreamExecutionEnvironment env = ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// 开启间隔为10s的检查点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">env.enableCheckpointing(10000);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>通过CheckpointConfig对象可以设置检查点的更多选项，它从StreamExecutionEnvironment中获取：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">CheckpointConfig cpConfig = env.getCheckpointConfig();</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>默认检查点提供精准一次性保证，也可以设置为至少一次，如下代码所示：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">// 设置检查点模式为至少一次</span></span><span class="token-line" style="color:#393A34"><span class="token plain">cpConfig.setCheckpointingMode(CheckpointingMode.AT_LEAST_ONCE);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>检查点可能会花费几分钟时间完成，这往往大于设置的间隔时间。默认情况下，Flink只允许一个检查点在保存，因此只有当上一个检查点结束后下一个检查点才会开始。为了确保不会有大量进程在进行检查点操作而不是计算，可以指定两个检查点之前的最小间隔，代码如下所示：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">// 设置检查点的最小间隔时间30s</span></span><span class="token-line" style="color:#393A34"><span class="token plain">cpConfig.setMinPauseBetweenCheckpoints(30000);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>有些情况下还是希望检查点按照指定间隔进行，即使它们花费时间大于间隔时间。比如外部数据流延迟高，导致检查点花费时间久但是消耗资源少。此时可以通过配置并发检查点的数量：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">// 允许最多3个检查点同时进行</span></span><span class="token-line" style="color:#393A34"><span class="token plain">cpConfig.setMaxConcurrentCheckpoints(3);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>保存点不受检查点影响</h5></div><div class="admonition-content"><p>保存点和检查点同步进行，由于显式触发，保存点不会因为检查点而被延迟。</p></div></div><p>为了避免检查点长时间运行，可以配置超时时间(默认10s)，如下所示：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">// 检查点必须在5分钟内完成，否则取消</span></span><span class="token-line" style="color:#393A34"><span class="token plain">cpConfig.setCheckpointTimeout(300000);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>最后，可以设置检查点失败后是否抛出异常终止任务，默认为true。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">// 检查点失败后应用继续运行</span></span><span class="token-line" style="color:#393A34"><span class="token plain">cpConfig.setFailOnCheckpointingErrors(false);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="开启检查点压缩"></a>开启检查点压缩<a class="hash-link" href="#开启检查点压缩" title="Direct link to heading">#</a></h4><p>Flink支持对检查点和保存点进行压缩，目前还只支持Snappy压缩算法，通过如下代码开启：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// 开启检查点压缩</span></span><span class="token-line" style="color:#393A34"><span class="token plain">env.getConfig.setUseSnapshotCompression(true)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</h5></div><div class="admonition-content"><p>压缩对增量式检查点没有作用，因为增量检查点使用RocksDB内部格式，使用现成的snappy压缩。</p></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="在应用停止后保存检查点"></a>在应用停止后保存检查点<a class="hash-link" href="#在应用停止后保存检查点" title="Direct link to heading">#</a></h4><p>检查点用于应用故障时恢复，因此在应用失败或者取消时会清除检查点。此时可以通过<strong>外部检查点(Externalized Checkpoints)</strong>来继续保留检查点：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">// 开启检查点外部化</span></span><span class="token-line" style="color:#393A34"><span class="token plain">cpConfig.enableExternalizedCheckpoints(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>检查点外部化有两种策略：</p><ol><li><strong>RETAIN_ON_CANCELLATION</strong>：在应用完全失败或者取消时保留检查点</li><li><strong>DELETE_ON_CANCELLATION</strong>：只有在应用完全失败后才保留检查点，如果应用取消则删除检查点</li></ol><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>小贴士</h5></div><div class="admonition-content"><p>外部化检查点并不是用来取代保存点，外部化检查点依赖状态后端并且不支持缩放。因此相比于保存点，外部化检查点恢复应用更加高效，但是没有那么灵活。</p></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="配置状态后端"></a>配置状态后端<a class="hash-link" href="#配置状态后端" title="Direct link to heading">#</a></h3><p><a href="/docs/Stream-Processing-with-Apache-Flink/Chap07#%E9%80%89%E6%8B%A9%E7%8A%B6%E6%80%81%E5%90%8E%E7%AB%AF">状态后端</a>负责维护本地状态、执行检查点和保存点、应用恢复。Flink默认状态后端是MemoryStateBackend，它适用于本地部署Flink而不是生产环境。</p><p><a href="/docs/Stream-Processing-with-Apache-Flink/Chap09/#%E6%A3%80%E6%9F%A5%E7%82%B9%E5%92%8C%E7%8A%B6%E6%80%81%E5%90%8E%E7%AB%AF">检查点和状态后端</a>介绍如何在flink-conf.yaml中指定使用的状态后端，也可以通过代码为某个应用指定：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">StreamExecutionEnvironment env = StreamExecutionEnvironment.ExecutionEnvironment();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">StateBackend memBackend = new MemoryStateBackend();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">StateBackend fsBackend = new FsStateBackend(&quot;file:///tmp/ckp&quot;, true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">StateBackend rocksBackend = new RocksDBStateBackend(&quot;file:///tmp/ckp&quot;, true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">env.setStateBackend(memBackend);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>同样地，也可以在代码中状态后端的各种参数：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">// Flink内置的状态后端都是可配置的</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ConfigurableStateBackend backend = ...;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">val sbConfig = new Configuration()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">sbConfig.setBoolean(&quot;state.backend.async&quot;, true)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">sbConfig.setString(&quot;state.savepoints.dir&quot;, &quot;file:///tmp/svp&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">val configuredBackend = backend.configure(sbConfig)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="应用恢复配置"></a>应用恢复配置<a class="hash-link" href="#应用恢复配置" title="Direct link to heading">#</a></h3><p>当开启检查点的应用故障后，将会重启任务、恢复状态然后继续执行。由于故障期间源端数据累计，应用需要以更高速率处理数据流。因此，应用重启后需要更多资源来赶上速度，这也意味着应用平常处理时不能100%消耗资源。除了考虑资源使用外，接下来介绍应用恢复的另外两个重点：重启策略和本地恢复。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="重启策略"></a>重启策略<a class="hash-link" href="#重启策略" title="Direct link to heading">#</a></h4><p>为了避免应用在恢复时循环重启，Flink提供如下3种重启策略：</p><ul><li><strong>Fixed-delay</strong>：重启固定次数，等待设置间隔后再次尝试</li><li><strong>Failure-rate</strong>：不超过设置频率下重启</li><li><strong>No-restart</strong>：不重启，直接报错</li></ul><p>设置重启策略代码如下所示，<strong>默认重启策略为fixed-delay(尝试次数Integer.MAX_VALUE，间隔10s)。</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">val env = StreamExecutionEnvironment.getExecutionEnvironment</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">env.setRestartStrategy(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  RestartStrategies.fixedDelayRestart(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    5,                            // 重启尝试次数</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Time.of(30, TimeUnit.SECONDS) // 尝试间隔</span></span><span class="token-line" style="color:#393A34"><span class="token plain">))</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="本地恢复"></a>本地恢复<a class="hash-link" href="#本地恢复" title="Direct link to heading">#</a></h4><p>除了MemoryStateBackend，Flink的状态后端都将保存点放在远程文件系统，这样一是保存状态二是在工作节点失效时重新分配。但是远程恢复并不高效，<em>尤其是在同一个工作节点上恢复。</em></p><p>当应用在同一个机器上重启时，Flink提供<strong>本地恢复(Local Recovery)</strong>机制来加速应用恢复。当开启本地恢复时，状态后端除了将状态数据保存到远程系统，也会在本地磁盘保存一份。当应用重启，Flink试着在原来节点上运行任务，如果成功则从本地磁盘加载检查点数据，否则从远程存储获取。本地恢复失败则从远程获取，也相当于加了一层保险。但是任务只会承认远程写完成才算检查点成功。</p><p>本地恢复可以在flink-conf.yaml中设置或者在应用代码中单独设置：</p><ul><li><strong>state.backend.local-recovery</strong>：是否开启本地恢复，默认false</li><li><strong>taskmanager.state.local.root-dirs</strong>：状态在本地存放路径</li></ul><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</h5></div><div class="admonition-content"><p>本地恢复只对键控状态有效，算子状态不会被本地存储，同时也不支持MemoryStateBackend。</p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="监控flink集群和应用"></a>监控Flink集群和应用<a class="hash-link" href="#监控flink集群和应用" title="Direct link to heading">#</a></h2><p>Flink在运行时提供一套预定义的指标，并且也提供框架让用户能够自定义指标。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="flink-web-ui"></a>Flink Web UI<a class="hash-link" href="#flink-web-ui" title="Direct link to heading">#</a></h3><p>通过<code>http://&lt;jobmanager-hostname&gt;:8081</code>即可访问Flink Web UI。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="指标系统"></a>指标系统<a class="hash-link" href="#指标系统" title="Direct link to heading">#</a></h3><p>Flink收集统计了应用和系统的一些指标，比如集群等级指标包括运行作业数、可用资源，作业指标包括运行时、重试次数和检查点信息，IO指标包括交互记录数，水印信息，连接器特定指标等。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="注册并使用指标"></a>注册并使用指标<a class="hash-link" href="#注册并使用指标" title="Direct link to heading">#</a></h4><p>要注册指标首先得获取一个MetricGroup，它通过RuntimeContext的getMetrics()方法获得，代码如下所示：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public static class PositiveFilter extends RichFilterFunction&lt;Integer&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Counter counter;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void open(Configuration parameters) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        counter = getRuntimeContext().getMetricGroup().counter(&quot;droppedElements&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean filter(Integer value) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (value &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            counter.inc();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="指标组"></a>指标组<a class="hash-link" href="#指标组" title="Direct link to heading">#</a></h4><p>Flink指标通过MetricGroup接口来登记和访问，指标组提供如下指标类型：</p><ul><li><strong>Counter</strong>：统计数量指标，提供增加和减少的方法；</li><li><strong>Gauge</strong>：统计某个时间点的指标，指标可以是任意类型，示例代码如下所示：</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class WatermarkGauge implements Gauge&lt;Long&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private long currentWatermark = Long.MIN_VALUE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void setCurrentWatermark(long watermark) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.currentWatermark = watermark;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public Long getValue() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return currentWatermark;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="admonition admonition-danger alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>小心</h5></div><div class="admonition-content"><p>指标值会以String类型对外暴露，因此确保指标类型实现toString()方法。</p></div></div><ul><li><strong>Histogram</strong>：统计数值指标分布的直方图，可以计算总数量、最大/最小值、方差、平均值等；此外还可以结合DropWizard使用，需要引入依赖。</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly xml"><pre tabindex="0" class="prism-code language-xml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.flink</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">flink-metrics-dropwizard</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${flink-version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">// create and register histogram</span></span><span class="token-line" style="color:#393A34"><span class="token plain">DropwizardHistogramWrapper histogramWrapper = </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  new DropwizardHistogramWrapper(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    new com.codahale.metrics.Histogram(new SlidingWindowReservoir(500)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">metricGroup.histogram(&quot;myHistogram&quot;, histogramWrapper)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// update histogram</span></span><span class="token-line" style="color:#393A34"><span class="token plain">histogramWrapper.update(value)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li><strong>Meter</strong>：统计事件发生频率，也可以和DropWizard结合使用。</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="指标作用域和格式化"></a>指标作用域和格式化<a class="hash-link" href="#指标作用域和格式化" title="Direct link to heading">#</a></h4><p>指标的作用域(scope)可以是系统级或者用户级，访问指标的标志符包含3部分：指标名、可选的用户作用域、系统作用域。例如指标名myCounter、用户作用域MyMetrics、系统作用域localhost.taskmanager.512组成最后的标识是<code>localhost.taskmanager.512.MyMetrics.myCounter.</code>，分隔符可以通过<code>metrics.scope.delimiter</code>参数修改。</p><p>系统作用域标识该指标对应的系统组件和上下文信息，比如JobManager、TaskManager、作业、算子和任务。可以在flink-conf.yaml文件中配置指标包含的上下文信息，如下所示：</p><table><thead><tr><th>作用域</th><th>配置参数</th><th>默认值</th></tr></thead><tbody><tr><td>JobManager</td><td>metrics.scope.jm</td><td>&lt;host&gt;.jobmanager</td></tr><tr><td>JobManager和Job</td><td>metrics.scope.jm.job</td><td>&lt;host&gt;.jobmanager.&lt;job_name&gt;</td></tr><tr><td>TaskManager</td><td>metrics.scope.tm</td><td>&lt;host&gt;.taskmanager.&lt;tm_id&gt;</td></tr><tr><td>TaskManager和Job</td><td>metrics.scope.tm.job</td><td>&lt;host&gt;.taskmana​​ger.&lt;tm_id&gt;.&lt;job_name&gt;</td></tr><tr><td>Task</td><td>metrics.scope.task</td><td>&lt;host&gt;.taskmanager.&lt;tm_id&gt;.&lt;job_name&gt;.&lt;task_name&gt;.&lt;subtask_index&gt;</td></tr><tr><td>Operator</td><td>metrics.scope.operator</td><td>&lt;host&gt;.taskmanager.&lt;tm_id&gt;.&lt;job_name&gt;.&lt;operator_name&gt;.&lt;subtask_index&gt;</td></tr></tbody></table><p>配置参数值由常量字符串(如“jobmanager”、“taskmanager”)和变量字符串(使用尖括号表示)组成，在运行时会替换为真实值。比如TaskManager的指标标志符就可能是localhost.taskmanager.512，512是TaskManager的id。如下表所示为不同作用域可以设置的变量：</p><table><thead><tr><th>作用域</th><th>可用变量</th></tr></thead><tbody><tr><td>JobManager</td><td>&lt;host&gt;</td></tr><tr><td>TaskManager</td><td>&lt;host&gt;, &lt;tm_id&gt;</td></tr><tr><td>Job</td><td>&lt;job_id&gt;, &lt;job_name&gt;</td></tr><tr><td>Task</td><td>&lt;task_id&gt;, &lt;task_name&gt;, &lt;task_attempt_id&gt;, &lt;task_attempt_num&gt;, &lt;subtask_index&gt;</td></tr><tr><td>Operator</td><td>&lt;operator_id&gt;, &lt;operator_name&gt;, &lt;subtask_index&gt;</td></tr></tbody></table><div class="admonition admonition-danger alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>小心</h5></div><div class="admonition-content"><p>可能多个相同Job同时运行，为了避免指标标识符重叠，使用包含&lt;job_id&gt;的标识符。</p></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="暴露指标"></a>暴露指标<a class="hash-link" href="#暴露指标" title="Direct link to heading">#</a></h4><p>Flink通过Reporter暴露指标，内置如下实现类：</p><table><thead><tr><th>Reporter</th><th>实现类</th></tr></thead><tbody><tr><td>JMX</td><td>org.apache.flink.metrics.jmx.JMXReporter</td></tr><tr><td>Graphite</td><td>org.apache.flink.metrics.graphite.GraphiteReporter</td></tr><tr><td>Prometheus</td><td>org.apache.flink.metrics.prometheus.PrometheusReporter</td></tr><tr><td>PrometheusPushGateway</td><td>org.apache.flink.metrics.prometheus.PrometheusPushGatewayReporter</td></tr><tr><td>StatsD</td><td>org.apache.flink.metrics.statsd.StatsDReporter</td></tr><tr><td>Datadog</td><td>org.apache.flink.metrics.datadog.DatadogHttpReporter</td></tr><tr><td>Slf4j</td><td>org.apache.flink.metrics.slf4j.Slf4jReporter</td></tr></tbody></table><p>如果没有想要的实现类，通过实现接口<code>org.apache.flink.metrics.reporter.MetricReporter</code>来自定义Reporter。Reporter需要在flink-conf.yaml文件中配置才能生效：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">metrics.reporters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my_reporter</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">Metrics.reporter.my_jmx_reporter.class</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> org.apache.flink.metrics.jmx.JMXReporter</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metrics.reporter.my_jmx_reporter.port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 9020</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">9040</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="监控延迟"></a>监控延迟<a class="hash-link" href="#监控延迟" title="Direct link to heading">#</a></h3><p><a href="/docs/Stream-Processing-with-Apache-Flink/Chap02/#%E5%BB%B6%E8%BF%9F%E5%92%8C%E5%90%9E%E5%90%90%E9%87%8F">延迟</a>是监控流应用的首要指标，它定义为事件处理所需的时间。但是现实中精准地统计延迟会带来问题，比如一个事件属于多个窗口，是要反馈第一次处理的延迟还是所有窗口都处理完的延迟呢？</p><p>Flink不严格测量每个事件的延迟，它通过周期性地发送一条特殊记录来大致估算延迟，这条特殊记录称之为延迟标记(Latency Marker)。通过如下代码设置延迟标记的间隔：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">// 每个500毫秒发送一个延迟标记</span></span><span class="token-line" style="color:#393A34"><span class="token plain">env.getConfig.setLatencyTrackingInterval(500L)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>当接收到延迟标记，除sink算子外的所有算子<strong>直接将其发送到下游</strong>。延迟标记可以反映记录等待处理的时间，但是不能测量出记录处理时间或者在窗口缓冲区的等待时间。统计sink算子出的延迟标记可以估算出记录在数据流中遍历的时长，如果想要自定义延迟标记在算子处的行为，可以重写processLatencyMarker()方法。</p><div class="admonition admonition-danger alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>小心</h5></div><div class="admonition-content"><ol><li>开启延迟指标会显著影响Flink集群性能，最好仅用于调试目的</li><li>开启延迟需要Flink集群所有机器时钟同步(比如使用NTP)，否则延迟估算不可靠</li></ol></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="日志配置"></a>日志配置<a class="hash-link" href="#日志配置" title="Direct link to heading">#</a></h2><p><a href="https://nightlies.apache.org/flink/flink-docs-release-1.14/docs/deployment/advanced/logging/" target="_blank" rel="noopener noreferrer">Flink日志</a>默认使用slf4j和log4j的组合，使用日志如下代码所示：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.functions.MapFunction;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.LoggerFactory;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.Logger;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyMapFunction extends MapFunction&lt;Integer, String&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  Logger LOG = LoggerFactory.getLogger(MyMapFunction.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  String map(Integer value) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG.info(&quot;Converting value {} to string.&quot;, value)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return value.toString();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>修改log4j日志行为，对应的配置文件为<code>${FLINK_HOME}/conf/log4j.properties</code>，通过JVM参数<code>-Dlog4j.configuration=xxx</code>来指定一个配置文件。在conf目录下，还提供<code>log4j-cli.properties</code>文件配置命令行客户端日志，以及<code>log4j-yarn-session.properties</code>文件配置客户端启动YARN session时日志。</p><p>Flink也支持使用logback，此时需要删除lib目录下log4j相关jar包，并加入logback-core和logback-classic的jar包。同样地，Flink在conf目录下提供了logback配置文件。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="总结"></a>总结<a class="hash-link" href="#总结" title="Direct link to heading">#</a></h2><ol><li>保存点是手动开启，对应存储系统上的一个路径；</li><li>/bin/flink脚本的参数和选项使用；</li><li>Flink默认开启task chainging机制，通过disableOperatorChaining()方法禁用，也可以通过slot共享组来控制；</li><li>没有slot共享组，应用所需slot数量等于算子最大并行度；有slot共享组，slot数量等于每个共享组算子最大并行度之和；</li><li>检查点开启及相关配置；</li><li>通过指标信息监控Flink集群和应用；</li><li>如何修改和配置Flink日志。</li></ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/docs/tags/stream-processing">Stream Processing</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/docs/tags/apache-flink">Apache Flink</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/docs/tags/reading-notes">ReadingNotes</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/kayhaw/kayhaw.github.io/edit/master/website/docs/Stream Processing with Apache Flink/Stream-Processing-with-Apache-Flink-Chap10.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/Stream-Processing-with-Apache-Flink/Chap09"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« 部署Flink环境</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/Stream-Processing-with-Apache-Flink/Chap11"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">何去何从 »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#流应用的运行和管理" class="table-of-contents__link">流应用的运行和管理</a><ul><li><a href="#保存点" class="table-of-contents__link">保存点</a></li><li><a href="#使用命令行管理应用" class="table-of-contents__link">使用命令行管理应用</a></li><li><a href="#通过rest-api管理应用" class="table-of-contents__link">通过REST API管理应用</a></li><li><a href="#以容器形式绑定和部署应用" class="table-of-contents__link">以容器形式绑定和部署应用</a></li></ul></li><li><a href="#控制任务调度" class="table-of-contents__link">控制任务调度</a><ul><li><a href="#控制task-chaining" class="table-of-contents__link">控制Task Chaining</a></li><li><a href="#定义slot共享组" class="table-of-contents__link">定义slot共享组</a></li></ul></li><li><a href="#调整检查点和故障恢复" class="table-of-contents__link">调整检查点和故障恢复</a><ul><li><a href="#配置检查点" class="table-of-contents__link">配置检查点</a></li><li><a href="#配置状态后端" class="table-of-contents__link">配置状态后端</a></li><li><a href="#应用恢复配置" class="table-of-contents__link">应用恢复配置</a></li></ul></li><li><a href="#监控flink集群和应用" class="table-of-contents__link">监控Flink集群和应用</a><ul><li><a href="#flink-web-ui" class="table-of-contents__link">Flink Web UI</a></li><li><a href="#指标系统" class="table-of-contents__link">指标系统</a></li><li><a href="#监控延迟" class="table-of-contents__link">监控延迟</a></li></ul></li><li><a href="#日志配置" class="table-of-contents__link">日志配置</a></li><li><a href="#总结" class="table-of-contents__link">总结</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">读书笔记</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://www.zhihu.com/people/xiao-ke-dou-7" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>知乎<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/kayhaw" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://gitee.com/kayhaw" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 何轲(Kay Haw). Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.ed6f7924.js"></script>
<script src="/assets/js/main.87f14a62.js"></script>
</body>
</html>