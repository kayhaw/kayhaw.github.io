<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Stream Processing with Apache Flink/Stream-Processing-with-Apache-Flink-Chap08">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Kay Haw&#39;s Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Kay Haw&#39;s Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"><title data-rh="true">读写外部系统 | Kay Haw&#x27;s Blog</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://kayhaw.github.io/docs/Stream-Processing-with-Apache-Flink/Chap08"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="读写外部系统 | Kay Haw&#x27;s Blog"><meta data-rh="true" name="description" content="Stream Processing with Apache Flink 第8章读书笔记"><meta data-rh="true" property="og:description" content="Stream Processing with Apache Flink 第8章读书笔记"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kayhaw.github.io/docs/Stream-Processing-with-Apache-Flink/Chap08"><link data-rh="true" rel="alternate" href="https://kayhaw.github.io/docs/Stream-Processing-with-Apache-Flink/Chap08" hreflang="en"><link data-rh="true" rel="alternate" href="https://kayhaw.github.io/docs/Stream-Processing-with-Apache-Flink/Chap08" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.fe6337ec.css">
<link rel="preload" href="/assets/js/runtime~main.f054803e.js" as="script">
<link rel="preload" href="/assets/js/main.c6957282.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Kay Haw&#x27;s Blog" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="Kay Haw&#x27;s Blog" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Kay Haw&#x27;s Blog</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro">读书笔记</a><a class="navbar__item navbar__link" href="/notes">学习笔记</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/kayhaw" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_RiAD"><nav class="menu thin-scrollbar menu_izAj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">读书笔记</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/C++PrimerPlus/C++PrimerPlus-Chap04">C++PrimerPlus</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/EffectiveC++/Effective-C++-Chap1">EffectiveC++</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Java并发编程实战/Java-Concurrency-in-Practice-Chap02">Java并发编程实战</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Learning Akka/LearningAkka-Chap01">Learning Akka</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/Stream-Processing-with-Apache-Flink/Chap01">Stream Processing with Apache Flink</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream-Processing-with-Apache-Flink/Chap01">状态流处理简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream-Processing-with-Apache-Flink/Chap02">流处理基础</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream-Processing-with-Apache-Flink/Chap03">Apache Flink架构</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream-Processing-with-Apache-Flink/Chap04">Apache Flink开发环境搭建</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream-Processing-with-Apache-Flink/Chap05">DataStream API(v.14.0)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream-Processing-with-Apache-Flink/Chap06">Time-Based and Window Operators</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream-Processing-with-Apache-Flink/Chap07">Stateful Operators and Applications</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Stream-Processing-with-Apache-Flink/Chap08">读写外部系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream-Processing-with-Apache-Flink/Chap09">部署Flink环境</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream-Processing-with-Apache-Flink/Chap10">运维Flink和流应用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Stream-Processing-with-Apache-Flink/Chap11">何去何从</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/深入理解Java虚拟机/UnderstandJVM-Chap07">深入理解Java虚拟机</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/高性能MySQL/HighPerformanceMySQL-Chap04">高性能MySQL</a></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/">🏠</a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><span class="breadcrumbs__link" itemprop="item name">Stream Processing with Apache Flink</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="item name">读写外部系统</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>读写外部系统</h1></header><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p><em>Stream Processing with Apache Flink</em> 第8章读书笔记</p></div></div><p>本章讨论source和sink如何影响Flink流应用的一致性保证，介绍常用的connector，以及如何实现自定义source和sink。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="应用一致性保证">应用一致性保证<a class="hash-link" href="#应用一致性保证" title="Direct link to heading">​</a></h2><p>在<a href="/docs/Stream-Processing-with-Apache-Flink/Chap03/#%E6%A3%80%E6%9F%A5%E7%82%B9%E4%BF%9D%E5%AD%98%E7%82%B9%E5%92%8C%E7%8A%B6%E6%80%81%E6%81%A2%E5%A4%8D">检查点、保存点和状态恢复</a>一节中提到，Flink使用周期性检查点进行容错恢复。然而，应用的一致性状态还是不够，需要source和sink连接器也集成到Flink的检查点机制中，才能提供有意义的一致性保证。</p><p>为了提供精准一次的一致性状态，source connector应该能重置到上次检查点的位置，否则应用重跑会丢失数据，即只提供最多一次保证。然而，要想实现端到端的精准一次性保证，可重置的source connector还是不够，需要sink connector实现两种特殊的写策略——<strong>幂等写</strong>和<strong>事务写</strong>——<strong>其中之一</strong>。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="幂等写">幂等写<a class="hash-link" href="#幂等写" title="Direct link to heading">​</a></h3><p><strong>幂等写(Idempotent Writes)</strong>：无论写入操作执行多少次，结果都只变化一次，比如向HashMap中多次写入<strong>相同的</strong>键值对。幂等写无论重放多少次都不会改变结果，在一定程度上可以减轻检查点重放的影响。注意依赖幂等写实现精准一次性的应用一定要保证在重放时覆盖之前写的结果，比如写到键值存储时要确切地计算更新或插入(upsert)的键。在重放过程中，消费结果的外部程序会观察到历史结果或者结果不一致，当重放结束后结果将会恢复一致状态。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="事务写">事务写<a class="hash-link" href="#事务写" title="Direct link to heading">​</a></h3><p><strong>事务写(Transactional Writes)</strong>：只写入上一个检查点前保存的结果，即使重置到上一个检查点，在该检查点之后没有结果写入。事务写消除了幂等写重放带来的不一致性，但是增加了最终结果的延迟。Flink内置了<strong>写前日志(Write-Ahead-Log, WAL)</strong>和<strong>两阶段提交(Two-Phase-Commit, 2PC)</strong>来实现事务写。</p><p>WAL将结果保存在应用状态中，当接收到检查点完成的通知后将结果写入。优点是<strong>适用于任何sink系统</strong>，缺点是不能提供完备的(bulletproof)精准一次性保证、增加应用状态大小以及sink系统需要处理尖峰式的(spiky)写入模式。</p><p>2PC要求sink系统提供事务指定或者至少暴露模拟支持的模块。对于每个检查点，sink开启一个事务然后写入结果，当接收到检查点完成的通知后提交事务。2PC依赖于Flink的检查点机制：检查点屏障(barrier)是开启事务的通知，而JobManager发送所有检查点完成的通知即提交事务的指令。和WAL相比，2PC依赖于sink系统和sink自身实现精准一次性保证，并且连续地写入结果而不是想WAL一样尖峰式地写入。</p><p>下表展示了不同类型source和sink能够达到的端到端一致性保证：</p><table><thead><tr><th>sink类型</th><th>不可重置source</th><th>可重置source</th></tr></thead><tbody><tr><td>任意sink</td><td>至多一次</td><td>至少一次</td></tr><tr><td>幂等sink</td><td>至多一次</td><td>精准一次</td></tr><tr><td>WAL sink</td><td>至多一次</td><td>至少一次</td></tr><tr><td>2PC sink</td><td>至多一次</td><td>精准一次</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_mojV" id="内置连接器">内置连接器<a class="hash-link" href="#内置连接器" title="Direct link to heading">​</a></h2><p>Flink内置多种数据存储系统的连接器(connector)：Apache Kafka、RabbitMQ、Apache Nifi、Cassandra、ElasticSearch和JDBC等。此外，<a href="https://bahir.apache.org/" target="_blank" rel="noopener noreferrer">Apache Bahir项目</a>提供额外的连接器：ActiveMQ、Akka、Flume、Netty和Redis等。为了使用内置连接器，需要工程引入依赖，详见<a href="/docs/Stream-Processing-with-Apache-Flink/Chap05#%E6%B7%BB%E5%8A%A0%E5%BA%94%E7%94%A8%E4%BE%9D%E8%B5%96">添加应用依赖</a>，接下来介绍几个常用连接器。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="kafka-source连接器">Kafka Source连接器<a class="hash-link" href="#kafka-source连接器" title="Direct link to heading">​</a></h3><p>Apache Kafka是分布式消息队列，以发布-订阅的模式接收和发送消息。Kafka按照主题(topic)划分消息流，确保每个topic的消息按照其写入顺序发送，并通过分区(partition)分布式地读写topic。Kakka的消息顺序保证只限于同一个分区，当从不同分区读取topic时并不确保有序性，分区的读取位置称为偏移量(offset)。</p><p>Kafka source 连接器从各分区并行地读取事件消息，source任务会记录偏移量并保存为状态，用于故障恢复时使用，而不依赖Kafka提供偏移量跟踪机制(基于消费者组)，如下图所示：</p><img loading="lazy" style="width:80%;height:80%" src="/img/doc/Stream-Processing-with-Apache-Flink/chap08/Read-Offset-of-Kafka-Topic-Partitions.png" title="Read Offset of Kafka Topic Partitions" class="img_E7b_"><p>Flink提供一个通用版本的Kafka连接器，适用于Kafka 0.11及其以上版本，也有特定版本的连接器。以通用版本为例，引入如下依赖：</p><div class="codeBlockContainer_I0IT language-xml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-xml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.flink</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">flink-connector-kafka_${scala.binary.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${flink.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>如下所示代码创建一个Kafka source连接器，构造器需要3个参数，依次为topic名称、反序列化器和连接参数。</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token class-name">Properties</span><span class="token plain"> properties </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Properties</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">properties</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setProperty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;bootstrap.servers&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;localhost:9092&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">properties</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setProperty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;group.id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;test&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">FlinkKafkaConsumer</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> kafkaSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">FlinkKafkaConsumer</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;topicName&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">SimpleStringSchema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> properties</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 设置水印</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kafkaSource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">assignTimestampsAndWatermarks</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">DataStreamSource</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> kafkaSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kafkaSource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>自0.10.0版本起Kafka支持消息时间戳，此时FlinkKafkaConsumer会自动将消息时间戳设置为事件时间，但还是要手动设置水印。此外，还可以通过如下方法设置读取分区的偏移量：</p><ul><li>FlinkKafkaConsumer.setStartFromGroupOffsets()：<strong>默认行为</strong>，以消费者组上一次的读取位置作为偏移量，消费者组由连接参数<code>group.id</code>配置。</li><li>FlinkKafkaConsumer.setStartFromEarliest()：每个分区最早的偏移量。</li><li>FlinkKafkaConsumer.setStartFromLatest()：每个分区最后的偏移量。</li><li>FlinkKafkaConsumer.setStartFromTimestamp(long)：读取大于给定时间戳的记录，需要Kafka 0.10.0+</li><li>FlinkKafkaConsumer.setStartFromSpecificOffsets(Map)：从Map对象获取偏移地址</li></ul><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>小贴士</h5></div><div class="admonition-content"><p>以上指定偏移量方法仅适用于Flink应用第1次读取，当从故障恢复或者保存点恢复时，应用从检查点/保存点中的保存偏移量开始读取。</p></div></div><p>Kafka source连接器还可以配置自动发现新topic和topic下的新partition，在Property对象中添加<code>flink.partition-discovery.interval-millis</code>属性开启。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="kafka-sink连接器">Kafka Sink连接器<a class="hash-link" href="#kafka-sink连接器" title="Direct link to heading">​</a></h3><p>自Flink 0.8起提供Kafka所有版本(0.8+)的特定sink连接器，也提供一个通用版本(Kafka 0.11+)的连接器。以通用版本为例，依赖引入同Kafka Source连接器，示例代码如下：</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token class-name">SinkFunction</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> kafkaSink </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">FlinkKafkaProducer</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;localhost:9092&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;topic_name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">SimpleStringSchema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addSink</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kafkaSink</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>示例代码的构造器接收3个参数，分别是逗号分隔的Kafka broker地址、topic名称和序列化器。其他重载构造器还接收如下类型参数：</p><ul><li>Properties：连接Kafka的配置，例如broker地址列表通过<code>bootstrap.servers</code>设置</li><li>FlinkKafkaPartitioner：配置记录如何映射到Kafka的不同分区</li><li>KeyedSerializationSchema：将记录序列化为key和value两个字节数组</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="kafka-sink的至少一次保证">Kafka Sink的至少一次保证<a class="hash-link" href="#kafka-sink的至少一次保证" title="Direct link to heading">​</a></h4><p>Flink Kafka sink在如下情况提供至少一次保证：</p><ul><li>应用开启检查点，所有source都是可重置的。</li><li>默认情况写入失败会抛出异常使应用重置，也可以配置<code>retries</code>进行重写，或者调用<code>setLogFailuresOnly(true)</code>在写入失败后不抛出异常而是记录日志。</li><li>默认情况下sink连接器等待Kafka确认所有记录后完成其检查点，通过调用<code>setFlushOnCheckpoint(false)</code>禁用等待操作。</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="kafka-sink的精准一次保证">Kafka Sink的精准一次保证<a class="hash-link" href="#kafka-sink的精准一次保证" title="Direct link to heading">​</a></h4><p>Kafka 0.11开始支持事务写，通过Kafka sink连接器参数配置，在开启检查点和source可重置下实现精准一次保证。FlinkKafkaProducer构造器通过Semantic参数设置Kafka sink的语义，有以下枚举值：</p><ul><li><strong>Semantic.NONE</strong>：没有保证，可能写丢失或者重复写</li><li><strong>Semantic.AT_LEAST_ONCE</strong>：默认配置，至少一次保证</li><li><strong>Semantic.EXACTLY_ONCE</strong>：建立在Kafka事务写之上提供精准一次性保证</li></ul><p>Kafka的事务机制：在分区日志追加消息，并将这些消息标记为未提交的，消费者通过配置隔离级别(通过<code>isolation.level</code>属性)来设置是否能够读取到未提交的记录(read_uncommitted<!-- -->[默认]<!-- -->/read_uncommitted)。如果配置为读已提交的，那么消费者在遇到未提交消息后会停止读取直到其改为已提交。因此，开启事务会导致消费者阻塞并引入显著的延迟。为此，Kafka提供<code>transaction.timeout.ms</code>属性配置(默认1个小时)，在超时后关闭未提交的事务。</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>检查你的Kafka配置</h5></div><div class="admonition-content"><p>Kafka默认配置可能会导致数据丢失，需要注意的配置有：<code>acks</code>，<code>log.flush.interval.messages</code>，<code>log.flush.interval.ms</code>，<code>log.flush.*</code>，详见Kafka官方文档。</p></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="自定义分区和写消息时间戳">自定义分区和写消息时间戳<a class="hash-link" href="#自定义分区和写消息时间戳" title="Direct link to heading">​</a></h4><p>Flink Kafka sink的一些构造器接受FlinkKafkaPartitioner参数，用于指定消息写入的分区。默认分区映射是将一个sink task的结果写入到同一个Kafka分区，如果task个数大于分区个数，可能会出现某个分区包含多个sink任务的结果；如果分区个数大于task个数， 默认配置下会有些分区为空，此时Flink应用在事件时间语义下消费空分区会出现问题。</p><p>除了FlinkKafkaPartitioner指定分区外，还可以根据消息key指定分区，这需要提供KeyedSerializationSchema参数并将FlinkKafkaPartitioner置为空。最后，Flink Kafka Sink可以配置成自动写入消息时间戳(Kafka 0.10+），调用<code>setWriteTimestampToKafka(true)</code>即可。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="filesystem-source连接器">Filesystem Source连接器<a class="hash-link" href="#filesystem-source连接器" title="Direct link to heading">​</a></h3><p>文件系统以合算(cost-efficient)的方式存储大量数据，Flink支持不同类型的文件系统：HDFS、S3以及OpenStack Swift FS等。文件系统source是flink-streaming-java模块的一部分，因此不需要引入依赖，如下所示代码从hdfs文件读取流：</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token class-name">TextInputFormat</span><span class="token plain"> lineReader </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">TextInputFormat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">DataStreamSource</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> lineStream </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lineReader</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;hdfs://path/to/data&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">FileProcessingMode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PROCESS_CONTINUOUSLY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">30_000L</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>StreamExecutionEnvironment.readFile()方法包含4个参数，依次为：</p><ul><li>FileInputFormat：用于读取文件内容，示例代码设置为null表示路径另外设置。FileInputFormat读取文件分为2步：<ul><li>第一步，扫描文件路径然后将所有匹配文件划分为input split，每个split通过offset和length定义一个文件上的一个内容范围，将split分发到所有source task用于并行读取文件。根据文件编码格式，可能只划分出一个split；</li><li>第二步，接收一个input split然后读取其定义的文件内容。</li></ul></li></ul><p>在数据流应用中，FileInputFormat对象也应该实现CheckpointableInputFormat接口，否则只提供至少一次保证，该接口定义了读取split时如何设置和恢复检查点。Flink内置实现了CheckpointableInputFormat接口并继承FileInputFormat抽象类的有TextInputFormat(及其子类CsvInputFormat、AvroInputFormat)。</p><ul><li>读取路径，若为目录则读取所有文件。</li><li>读取模式，有以下枚举值：<ul><li>PROCESS_ONCE：<strong>只扫描一遍路径</strong>然后读取所有匹配文件，split创建后不会保存检查点；</li><li>PROCESS_CONTINUOUSLY：<strong>周期性</strong>扫描路径然后读取匹配文件，因此会不停地读取新增和修改文件。新增和修改文件通过文件修改时间戳区分，这意味着向一个文件追加写就会导致该文件重头被处理一次。因此，一种常见技术是将追加内容写入到非读取路径下的临时文件，写入完成后将临时文件挪回读取路径。</li></ul></li><li>扫描间隔，和PROCESS_CONTINUOUSLY读取模式搭配使用，PROCESS_ONCE模式下忽略该参数。</li></ul><p>由于input split由单个进程生成并按照修改时间排序然后轮流分发到各个task，在使用事件时间语义的应用中，为了生成合适的水印时，需要推断task接收记录的最小时间戳。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="filesystem-sink连接器">Filesystem Sink连接器<a class="hash-link" href="#filesystem-sink连接器" title="Direct link to heading">​</a></h3><p>Flink提供StreamingFileSink用于写入结果，它和文件系统source连接器一样包含在flink-streaming-java模块中，不需要额外引入依赖。示例代码如下：</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token class-name">StreamingFileSink</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> fileSink </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">StreamingFileSink</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forRowFormat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Path</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/base/path&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">SimpleStringEncoder</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UTF_8</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">withBucketAssigner</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lineStream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addSink</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fileSink</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>当StreamingFileSink收到一条记录后，将其分配到一个桶(bucket)中。一个桶是StreamingFileSink构造器中path路径(如示例代码中的<code>/bash/path</code>)下的子文件夹，通过withBucketAssigner传入一个实现BucketAssigner接口的对象，该接口给出一条记录对应的BucketId，通过BucketId确定记录写入哪个子文件夹。如果没有指定BucketAssigner，默认使用DateTimeBucketAssigner，它以小时为单位创建bucket。</p><p>每个bucket包含多个<strong>块文件(part file)</strong>，它们由StreamingFileSink的多个实例并行写入，并且每个实例将输出写到多个块文件，<strong>命名格式为<code>[base-path]/[bucket-path]/part-[task-idx]-[id]</code></strong>。</p><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>块文件ID不一定会连续</h5></div><div class="admonition-content"><p>不相邻的id并不意味着有数据缺失，StreamingFileSink仅确保id单调增加，当丢弃挂起文件(⭐)时不会复用其id。</p></div></div><p>此外，还可以通过withRollingPolicy()方法传入RollingPolicy参数来设置task何时创建新的块文件。默认使用DefaultRollingPolicy，当写入数据超过128MB或者写入时间超过60s时创建新的块文件。StreamingFileSink支持以下2种写入模式:</p><ul><li><strong>行编码(Row Encoding)</strong>：每条记录单独编码追加到块文件</li><li><strong>块编码(Bulk Encoding)</strong>：多条记录分批收集和写入</li></ul><p>Apache Parquet文件格式就是以块编码写入，如下代码所示，块编码写入调用forBulkFormat()方法，它需要一个BulkWriter.Factory参数，通过实现BulkWriter.Factory接口来自定义写入格式。</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token class-name">StreamingFileSink</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> sink </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">StreamingFileSink</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forBulkFormat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Path</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/base/path&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">ParquetAvroWriters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forSpecificRecord</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">AvroPojo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</h5></div><div class="admonition-content"><p>当以块编码模式写入时，不能选择RollingPolicy而只能是OnCheckpointRollingPolicy。</p></div></div><p>StreamingFileSink支持精准一次保证，它将文件写入分为不同阶段(状态转换通过重命名实现)：</p><ol><li><strong>正写入(In Progress)</strong>：sink开始写块文件A，将该文件标记为in-progress状态；</li><li><strong>挂起(Pending)</strong>⭐：根据RollingPolicy设置条件触发写入另一个块文件B时，A关闭然后标记为pending状态；</li><li><strong>完成(Finished)</strong>：检查点完成后将A标记为finished状态。</li></ol><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</h5></div><div class="admonition-content"><p>某些情况下，pending文件可能永远不会被提交，StreamingFileSink确保没有数据丢失但是不会自动清理这些未提交的文件。如果发现与pending文件的task id相同但是id更高的finished文件，可以手动删除该pending文件。</p></div></div><p>当遇到故障后，sink task重置in-progress文件的写入位置到上一次检查点时位置，通常使用文件系统truncate操作实现。</p><div class="admonition admonition-danger alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>小心</h5></div><div class="admonition-content"><p>如果应用没有开启检查点，StreamingFileSink永远不会将文件由pending状态改为finished状态。</p></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="cassandra-sink连接器">Cassandra Sink连接器<a class="hash-link" href="#cassandra-sink连接器" title="Direct link to heading">​</a></h3><p>Apache Cassandra是一种可扩展、高可用的列式存储数据库系统，提供类SQL语言CQL读写记录。使用Flink Cassandra Sink连接器需要引入如下依赖：</p><div class="codeBlockContainer_I0IT language-xml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-xml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.flink</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">flink-connector-cassandra_${scala.binary.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${flink.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>为了演示Cassandra Sink连接器的使用，通过如下CQL创建键空间example和表sensors：</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> KEYSPACE </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> example</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">replication</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> {</span><span class="token string" style="color:#e3116c">&#x27;class&#x27;</span><span class="token plain">: </span><span class="token string" style="color:#e3116c">&#x27;SimpleStrategy&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;replication_factor&#x27;</span><span class="token plain">: </span><span class="token string" style="color:#e3116c">&#x27;1&#x27;</span><span class="token plain">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sensors </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sensorId </span><span class="token keyword" style="color:#00009f">VARCHAR</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  temperature </span><span class="token keyword" style="color:#00009f">FLOAT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sensorId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>当写入类型为Tuple或者Row时，需要指定一条CQL插入语句，如下代码所示。执行时按照tuple或者row的元素顺序依次插入到占位符中。</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token class-name">CassandraSink</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Tuple2</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Double</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> cassandraSink </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">CassandraSink</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addSink</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">readings</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setHost</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;localhost&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setQuery</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;INSERT INTO example.sensors(sensorId, temperature) VALUES (?, ?);&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>当写入类型为POJO时，由于其字段没有顺序，需要在POJO类上添加Cassandra注解，如下代码所示：</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Table</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">keyspace </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;example&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sensors&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">SensorReadings</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Column</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sensorId&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Column</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;temperature&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">Float</span><span class="token plain"> temperature</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">SensorReadings</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 不需要设置CQL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">DataStream</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">SensorReadings</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> readings </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">CassandraSink</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addSink</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">readings</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setHost</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;localhost&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Cassandra Sink连接器提供如下配置方法：</p><ul><li>setClusterBuilder(ClusterBuilder)：参数ClusterBuilder设置Cassandra集群管理连接</li><li>setHost(String, <!-- -->[Int]<!-- -->)：设置Cassandra地址和端口号，端口没配默认9042</li><li>setQuery(String)：写入数据类型为Tuple、Row时使用，数据类型为POJO时不能配置</li><li>setMapperOptions(MapperOptions)：Cassandra对象映射器配置，比如TTL、null字段处理等，写入类型为Tuple、Row时忽略该配置</li><li>enableWriteAheadLog(<!-- -->[CheckpointCommitter]<!-- -->)：开启WAL以提供精准一次保证，CheckpointCommitter用于存储完成的检查点信息，如果没有则将检查点信息写入到特定的Cassandra表中，详见<!-- -->[事务型sink连接器]</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="实现自定义source函数">实现自定义Source函数<a class="hash-link" href="#实现自定义source函数" title="Direct link to heading">​</a></h2><p>DataSteam API提供2种接口来实现source连接器(每种接口派生RichFunction抽象类)：</p><ol><li>SourceFunction和RichSourceFunction：定义非并行化的source连接器，只在一个task上运行；</li><li>ParallelSourceFunction和RichParallelSourceFunction：定义在多个并行任务上执行的source连接器。</li></ol><p>和处理函数一样，RichSourceFunction和RichParallelSourceFunction的子类可以重写open()和close()方法，并获取RuntimeContext参数，改参数能够提供并行任务的个数和当前任务示例的编号等信息。除此之外，这2个类还定义了如下2个方法：</p><ol><li><code>void run(SourceContext&lt;T&gt; ctx)</code>：基于源端存储系统以push或pull的方式获取记录并发送到Flink应用。run()方法被Flink调用一次，然后在while循环中不断执行，可以被中断取消或者终止。</li><li><code>void cancel()</code>：当应用取消或者停止时调用。</li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="可重置source函数">可重置Source函数<a class="hash-link" href="#可重置source函数" title="Direct link to heading">​</a></h3><p>可重置Source函数是Flink应用实现一致性保证的必要条件，它需要支持重放并在检查点保存读取位置。当应用重启时source函数从保存的读取位置重新读取，如果第一次启动没有保存状态，需要提供默认读取位置。</p><p>从代码实现上看，可重置source函数一定要实现CheckpointedFunction接口，并将读取位置等元信息保存在算子list状态或者算子union list状态(两种状态的区别见<a href="/docs/Stream-Processing-with-Apache-Flink/Chap03/#%E7%BC%A9%E6%94%BE%E7%8A%B6%E6%80%81%E7%AE%97%E5%AD%90">缩放状态算子</a>)。</p><p>为了确保执行CheckpointedFunction.snapshotState()的线程和执行SourceFunction.run()的线程不会同时进行，使用SourceContext.getCheckpointLock()获得的对象锁来同步两者，示例代码见<code>ResettableCountSource.java</code>。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="source函数时间戳和水印">Source函数、时间戳和水印<a class="hash-link" href="#source函数时间戳和水印" title="Direct link to heading">​</a></h3><p>时间戳和水印既可以通过TimestampAssigner分配，也可以在source函数中产生并分配，通过run()方法的SourceContext参数对象分配时间戳和产生水印，SourceContext提供如下方法：</p><ul><li>void collectWithTimestamp(T element, long timestamp)：发送带有时间戳的记录</li><li>void emitWatermark(Watermark watermark)：发送水印</li></ul><p>SourceFunction内置时间戳和水印除了免去额外的算子外，在source算子并行运行时也有好处。例如一个source函数从有6个分区的Kafka topic中以2个并行度读取记录，每个source示例会读取3个分区，这种多路复用就会导致额外的乱序性，导致更多延迟记录。为了避免这种情况，可以让source函数为每个分区流单独创建一个水印，并只发送最小水印。</p><p>Source函数需要处理的另一种情况是某个source任务示例不在产生数据，导致水印不再增加进而整个应用停止。Flink通过将source函数标记为<em>暂时空闲(Temporarily Idle)</em>，此时根据水印传播机制会忽略由其产生的水印，如果source函数又重新开始发送数据，则又自动标记为<em>活跃(Active)</em>。Source函数通过调用<code>SourceContext.markAsTemporarilyIdle()</code>来标记自己为空闲状态。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="实现自定义sink函数">实现自定义Sink函数<a class="hash-link" href="#实现自定义sink函数" title="Direct link to heading">​</a></h2><p>在DataStream API中，数据可以发送到任意外部系统或应用，不一定都流向sink算子。Flink使用SinkFunctioin接口(对应富函数为RichSinkFunction)表示sink算子，该接口只有一个方法：</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">invoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">IN</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Context</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Context参数可以提供处理时间、水印和时间戳等信息。示例代码<code>SimpleSocketSink.java</code>演示如何将传感器数据写到socket中。</p><p>正如之前讨论的，要实现端到端的一致性保证，sink函数需要实现幂等写或者事务写。由于socket只能追加的特性，不可能实现幂等写，而socket没有内置事务机制，所以只能通过WAL机制的事务写来完成。以下介绍如何实现幂等写和事务写连接器。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="幂等写sink连接器">幂等写sink连接器<a class="hash-link" href="#幂等写sink连接器" title="Direct link to heading">​</a></h3><p>当满足如下两个条件，只需要SinkFunction就可以实现幂等写：</p><ol><li>数据结果有一个确定的key，可以进行幂等更新</li><li>外部系统支持根据key更新，比如关系型数据库库和K-V存储系统</li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="事务写sink连接器">事务写sink连接器<a class="hash-link" href="#事务写sink连接器" title="Direct link to heading">​</a></h3><p>事务写需要开启检查点机制，因为所有检查点完成后才会提交事务。为了快速实现事务写，DataStream API提供了2个事务写抽象类作为模板，它们都实现了CheckpointListener接口来获取JobManager发送的检查点完成通知：</p><ul><li><strong>GenericWriteAheadSink</strong>：将输出结果保存在算子状态中，当收到检查点完成通知后写入结果；</li><li><strong>TwoPhaseCommitSinkFunction</strong>：利用外部系统的事务特性，当检查点完成后开启新事务并提交上一个事务。</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="genericwriteaheadsink">GenericWriteAheadSink<a class="hash-link" href="#genericwriteaheadsink" title="Direct link to heading">​</a></h4><p>GenericWriteAheadSink与检查点机制配合实现精准一次性保证，但实际上它不能提供完美的精准一次保证而只能提供至少一次保证。</p><p>GenericWriteAheadSink将收到的数据追加到日志中(WAL)，该日志由检查点分段并保存在算子状态中。当接收到检查点完成的通知，发送WAL中对应的记录并提交检查点。</p><p>检查点提交分为2步：第一步，sink函数保存检查点已经提交的信息；第二步，从WAL中删除记录。由于状态不是持久化并且在发生故障时会重置，不能将提交信息保存在状态中，因此GenericWriteAheadSink依赖于CheckpointCommitter组件来保存和查找提交的检查点信息。</p><p>扩展GenericWriteAheadSink的算子需要提供3个构造参数，如下代码所示：CheckpointCommitter用于保存检查点提交信息、TypeSerializer用于序列化输入记录、jobId</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">GenericWriteAheadSink</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">CheckpointCommitter</span><span class="token plain"> committer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">TypeSerializer</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">IN</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> serializer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> jobID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">Exception</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">committer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Preconditions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">checkNotNull</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">committer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">serializer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Preconditions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">checkNotNull</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">serializer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> UUID</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">randomUUID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">committer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setJobId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">jobID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">committer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createResource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sendValues</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Iterable</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">IN</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> values</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> chkpntId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>除此之外，还需要实现sendValues()方法将记录写到外部系统。当所有记录写入成功返回true，否则返回false。</p><p>:::cuation 注意
GenericWriteAheadSink没有实现SinkFunction接口，因此不能使用DataStream.addSink()添加，但是可以作为DataStream.transform()方法。
:::</p><p>代码<code>StdOutWriteAheadSink.java</code>演示输出到文件的sink函数。GenericWriteAheadSink之所以不能提供完美的精准一次性保证，有以下2个原因：</p><ol><li>当执行sendValues()方法时程序故障，有些记录已经输出但是其他没有，由于检查点没有提交，故障恢复重放所有记录，导致部分记录重复写入；</li><li>sendValues()执行成功并返回true，但是在调用CheckpointCommitter提交检查点之前应用故障或者调用时发生故障，故障恢复也会导致部分记录重复写入。</li></ol><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>以上故障场景并不影响Cassandra Sink连接器的精准一次性保证，因为Cassandra执行UPSERT写操作(存在则更新，不存在插入)⭐。</p></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="twophasecommitsinkfunction">TwoPhaseCommitSinkFunction<a class="hash-link" href="#twophasecommitsinkfunction" title="Direct link to heading">​</a></h4><p>两阶段提交顾名思义，分为如下2个阶段：</p><p>阶段1（Voting Phase）：sink任务开启事务A，在事务A上下文中发送记录。当接收到JobManager发出的检查点barrier，sink任务保存状态并返回一条响应信息。</p><p>阶段2：sink任务返回给JM一条响应信息后不会马上提交事务，因为不能保证此时其他算子也完成检查点保存。相反，sink任务会开始新事务B，在B上下文中发送记录。当JM接收到所有算子的检查点消息后，它会向所有“感兴趣”的算子(实现CheckpointedListener接口)发送一条检查点完成通知，此时sink任务提交所有历史检查点中仍在开放的事务。</p><p>总结两阶段提交需要外部sink系统满足的条件有：</p><ol><li>提供事务机制或者模拟事务的机制；</li><li>在检查点间隔期能够维持事务打开状态并接收记录；</li><li>事务必须等待提交，直到收到检查点完成通知；</li><li>支持sink任务回滚事务；</li><li>提交事务是幂等操作，即sink或者外部系统能够感知事务已经提交或者重复提交事务没有效果。</li></ol><p>代码<code>TransactionalFileSink.java</code>演示一个写入文件系统的TwoPhaseCommitSinkFunction，它是BucketingFileSink的简化版本。</p><p>TwoPhaseCommitSinkFunction泛型类有3个类型参数：</p><ul><li>IN：输入数据类型；</li><li>TXN：定义事务id的类型，故障恢复时用；</li><li>CONTEXT：可选的自定义上下文类型，示例代码不需要，设置为Void</li></ul><p>TwoPhaseCommitSinkFunction构造器需要2个TypeSerializer，分别用于TXN和CONTEXT。最后该类定义了5个需要实现的方法：</p><ol><li><strong>TXN beginTransaction()</strong>：开启新事务并返回事务id，示例代码以文件名作为事务id；</li><li><strong>void invoke(TXN transaction, IN value, Context context)</strong>：向当前事务写记录；</li><li><strong>void preCommit(TXN txn)</strong>：预提交事务，此后事务不能再接收记录；</li><li><strong>void commit(TXN transaction)</strong>：提交事务，必须具有幂等性，即多次提交数据还是只写入一次；</li><li><strong>void abort(TXN transaction)</strong>：丢弃事务，可以在一次事务中调用2次。</li></ol><p>Flink内置Kafka Sink连接器也实现了TwoPhaseCommitSinkFunction接口，但是在超时导致事务回滚的情况下，也会出现数据丢失，因此也不能提供最佳的精准一次性保证。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="异步访问外部系统">异步访问外部系统<a class="hash-link" href="#异步访问外部系统" title="Direct link to heading">​</a></h2><p>除了从外部系统吸收和发送数据流外，另一种常用使用场景是访问外部系统丰富数据流。比如Yahoo!流处理benchmark，它将一个广告点击数据流丰富为包含广告活动的数据流。</p><p>一种常见的实现方式是使用MapFunction，该函数为每条记录创建一个同步查询并等待返回结果。显然这种方法MapFunction主要时间花费在等待查询结果上。</p><p>Flink提供AsyncFunction来减缓远程I/O调用的延迟，它并发地发送多条查询并异步地处理结果。为了减少延迟，AsyncFunction可以配置其按照发送查询的顺序返回结果或者按照结果顺序原样返回。另外它也集成了检查点机制，并且确保即使使用了乱序结果，水印也不会被记录超过，因此能正确地处理事件时间语义。</p><p>为了充分利用AsyncFunction，外部系统应该提供支持异步调用的客户端。如果只有同步客户端，可以通过多线程异步发送请求来处理。AsyncFunction接口如下：</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">AsyncFunction</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">IN</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> OUT</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">Function</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Serializable</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">asyncInvoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">IN</span><span class="token plain"> input</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">ResultFuture</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">OUT</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> resultFuture</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">Exception</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>通过AsyncDataStream的静态方法orderedWait()或unorderedWait()使用 AsyncFunction，前者按照接收记录的顺序返回对应的结果，而后者仅保证检查点barrier和水印对齐，示例代码见<code>DerbyAsyncFunctionDemo.java</code>。</p><p>需要指出的是，AsyncFunction按照每个输入记录<strong>顺序调用</strong>而不是以多线程方式调用，因此asyncInvoke()应该在发送异步请求后立即返回，通过回调处理结果，需要避免的常见反例有：</p><ul><li>发送阻塞asyncInvoke()方法的同步请求</li><li>发送异步请求但是在asyncInvoke()方法内部等待请求完成</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="总结">总结<a class="hash-link" href="#总结" title="Direct link to heading">​</a></h2><ol><li>精准一次=可重置source+有状态算子，端到端精准一次=精准一次+(幂等写OR事务写)</li></ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/docs/tags/stream-processing">Stream Processing</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/docs/tags/apache-flink">Apache Flink</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/docs/tags/reading-notes">ReadingNotes</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/kayhaw/kayhaw.github.io/edit/master/website/docs/Stream Processing with Apache Flink/Stream-Processing-with-Apache-Flink-Chap08.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/Stream-Processing-with-Apache-Flink/Chap07"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Stateful Operators and Applications</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/Stream-Processing-with-Apache-Flink/Chap09"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">部署Flink环境</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#应用一致性保证" class="table-of-contents__link toc-highlight">应用一致性保证</a><ul><li><a href="#幂等写" class="table-of-contents__link toc-highlight">幂等写</a></li><li><a href="#事务写" class="table-of-contents__link toc-highlight">事务写</a></li></ul></li><li><a href="#内置连接器" class="table-of-contents__link toc-highlight">内置连接器</a><ul><li><a href="#kafka-source连接器" class="table-of-contents__link toc-highlight">Kafka Source连接器</a></li><li><a href="#kafka-sink连接器" class="table-of-contents__link toc-highlight">Kafka Sink连接器</a></li><li><a href="#filesystem-source连接器" class="table-of-contents__link toc-highlight">Filesystem Source连接器</a></li><li><a href="#filesystem-sink连接器" class="table-of-contents__link toc-highlight">Filesystem Sink连接器</a></li><li><a href="#cassandra-sink连接器" class="table-of-contents__link toc-highlight">Cassandra Sink连接器</a></li></ul></li><li><a href="#实现自定义source函数" class="table-of-contents__link toc-highlight">实现自定义Source函数</a><ul><li><a href="#可重置source函数" class="table-of-contents__link toc-highlight">可重置Source函数</a></li><li><a href="#source函数时间戳和水印" class="table-of-contents__link toc-highlight">Source函数、时间戳和水印</a></li></ul></li><li><a href="#实现自定义sink函数" class="table-of-contents__link toc-highlight">实现自定义Sink函数</a><ul><li><a href="#幂等写sink连接器" class="table-of-contents__link toc-highlight">幂等写sink连接器</a></li><li><a href="#事务写sink连接器" class="table-of-contents__link toc-highlight">事务写sink连接器</a></li></ul></li><li><a href="#异步访问外部系统" class="table-of-contents__link toc-highlight">异步访问外部系统</a></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">读书笔记</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://www.zhihu.com/people/xiao-ke-dou-7" target="_blank" rel="noopener noreferrer" class="footer__link-item">知乎<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/kayhaw" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gitee.com/kayhaw" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 何轲(Kay Haw). Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.f054803e.js"></script>
<script src="/assets/js/main.c6957282.js"></script>
</body>
</html>