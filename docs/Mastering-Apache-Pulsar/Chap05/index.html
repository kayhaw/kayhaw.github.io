<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Mastering Apache Pulsar/Mastering-Apache-Pulsar-Chap05">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.20">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Kay Haw&#39;s Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Kay Haw&#39;s Blog Atom Feed">




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"><title data-rh="true">消费者 | Kay Haw&#x27;s Blog</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://kayhaw.github.io/docs/Mastering-Apache-Pulsar/Chap05"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="消费者 | Kay Haw&#x27;s Blog"><meta data-rh="true" name="description" content="Mastering Apache Pulsar 第5章读书笔记"><meta data-rh="true" property="og:description" content="Mastering Apache Pulsar 第5章读书笔记"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kayhaw.github.io/docs/Mastering-Apache-Pulsar/Chap05"><link data-rh="true" rel="alternate" href="https://kayhaw.github.io/docs/Mastering-Apache-Pulsar/Chap05" hreflang="en"><link data-rh="true" rel="alternate" href="https://kayhaw.github.io/docs/Mastering-Apache-Pulsar/Chap05" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.932307e8.css">
<link rel="preload" href="/assets/js/runtime~main.a8170a08.js" as="script">
<link rel="preload" href="/assets/js/main.1794f536.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Kay Haw&#x27;s Blog" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="Kay Haw&#x27;s Blog" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title text--truncate">Kay Haw&#x27;s Blog</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro">读书笔记</a><a class="navbar__item navbar__link" href="/notes">学习笔记</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/kayhaw" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_dLyj"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_mKqt"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><div class="docPage_ualW"><aside class="theme-doc-sidebar-container docSidebarContainer_UQUJ"><div class="sidebar_RiAD"><nav class="menu thin-scrollbar menu_izAj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">读书笔记</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/C++PrimerPlus/C++PrimerPlus-Chap04">C++PrimerPlus</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/EffectiveC++/Effective-C++-Chap1">EffectiveC++</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Java并发编程实战/Java-Concurrency-in-Practice-Chap02">Java并发编程实战</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/Learning-Akka/">Learning Akka</a><button aria-label="Toggle the collapsible sidebar category &#x27;Learning Akka&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/Mastering-Apache-Pulsar/">Mastering Apache Pulsar</a><button aria-label="Toggle the collapsible sidebar category &#x27;Mastering Apache Pulsar&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Mastering-Apache-Pulsar/Chap02">事件流和事件代理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Mastering-Apache-Pulsar/Chap03">Pulsar</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Mastering-Apache-Pulsar/Chap04">Pulsar组件</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Mastering-Apache-Pulsar/Chap05">消费者</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Mastering-Apache-Pulsar/Chap06">生产者</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Mastering-Apache-Pulsar/Chap07">Pulsar IO</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Mastering-Apache-Pulsar/Chap08">Pulsar Functions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Mastering-Apache-Pulsar/Chap09">分层存储</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Mastering-Apache-Pulsar/Chap10">Pulsar SQL</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/Stream-Processing-with-Apache-Flink/">Stream Processing with Apache Flink</a><button aria-label="Toggle the collapsible sidebar category &#x27;Stream Processing with Apache Flink&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/深入理解Java虚拟机/UnderstandJVM-Chap07">深入理解Java虚拟机</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/高性能MySQL/HighPerformanceMySQL-Chap04">高性能MySQL</a></div></li></ul></nav></div></aside><main class="docMainContainer_uL0j"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_kU5B"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/Mastering-Apache-Pulsar/"><span itemprop="name">Mastering Apache Pulsar</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">消费者</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_bZGK theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_l22C">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>消费者</h1></header><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p><em>Mastering Apache Pulsar</em> 第5章读书笔记</p></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="消费者意味着什么">消费者意味着什么?<a class="hash-link" href="#消费者意味着什么" title="Direct link to heading">​</a></h2><p>Pulsar topic是不可变的日志文件，该日志由生产者提供由消费者获取。Pulasr提供订阅(subscription)机制规定消费者获取topic的规则。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="订阅">订阅<a class="hash-link" href="#订阅" title="Direct link to heading">​</a></h2><p>订阅机制是Pulsar为消费者提供的抽象和配置，如下图所示有4个topic，生产者添加消息后又broker将消息路由到对应的消费者。具体地，订阅机制包含如下几点元数据：</p><ul><li>topic名称或者topic分区名；</li><li>订阅名称；</li><li>有关订阅的到期信息；</li><li>订阅游标：标记消费者获取日志的偏移量。</li></ul><p>尽管broker是无状态的，但游标是有状态的。Pulsar将游标信息保存在BookKeeper中，如下图所示，游标保存在ledger中，随着ledger的更新而更新。接下来介绍Pulsar对订阅的分类。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="独家订阅">独家订阅<a class="hash-link" href="#独家订阅" title="Direct link to heading">​</a></h3><p>独家(Exclusive)订阅指消费者和订阅之间是一对一关系，注意订阅和topic是互相独立的概念，因此在一个topic上可以存在多个独家订阅。</p><div class="language-java codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-java codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token class-name">Consumer</span><span class="token plain"> consumer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;my-topic&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscriptionName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;my-subscription&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ackTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">TimeUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SECONDS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscriptionType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">SubscriptionType</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Exclusive</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// 订阅类型，可选项</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果另一个消费者试图加入已有消费者的独家订阅，那它将会被拒绝，如下图所示：</p><p><img loading="lazy" alt="Exclusive Subscription" src="/assets/images/error-on-exclusive-subscription-76d654d0ec8193d073a68f1cbb33e52e.png" width="1425" height="228" class="img_E7b_"></p><p>独家订阅的意义：操作简单(易于调试)、<strong>保证消息有序</strong>。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="共享订阅">共享订阅<a class="hash-link" href="#共享订阅" title="Direct link to heading">​</a></h3><p>共享(Shared)订阅指消费者和订阅之间是多对一关系，如下图所示，多个消费者将会按照轮询的方式接收消息。</p><p><img loading="lazy" alt="Shared Subscription" src="/assets/images/round-robin-shared-subscription-813a51b123d0a936a956bcbaf9e25846.png" width="1425" height="324" class="img_E7b_"></p><div class="language-java codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-java codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token class-name">Consumer</span><span class="token plain"> consumer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;my-topic&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscriptionName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;my-subscription&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ackTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">TimeUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SECONDS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscriptionType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">SubscriptionType</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Shared</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>共享订阅的局限：</p><ul><li>不能保证消息有序性：消费者和topic之间没有顺序的概念，不能保证有序性。幸运地是大部分应用不需要有序性。</li><li>一套确定模式(Acknowledgment Schemas)：共享订阅下一次发送一条消息，那消费者每次都要响应一次，消耗时间和网络带宽。</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="key_shared订阅">Key_Shared订阅<a class="hash-link" href="#key_shared订阅" title="Direct link to heading">​</a></h3><p>Key_Shared订阅类类似共享订阅，但粒度更细，消费者只能订阅某个主键的消息(主键是消息的一个字段或者多个字段的组合)，如下图所示：</p><p><img loading="lazy" alt="Key_Shared Subscription" src="/assets/images/key_shared_subscription-aefbe012f5d1d1ac408c64923c7be034.png" width="1425" height="324" class="img_E7b_"></p><p>共享订阅难以保证消息有序性，因为消息时轮询发送给消费者。而key_shared按照主键划分确保一组消息都由同一个消费者获取，改善了顺序保证性。由于消费者按照主键分类获取消息，因此在定义Key_Shared订阅时，除了给出订阅类型外，还需要给出划分策略。</p><p>Pulsar提供2种划分策略：自动哈希和粘性(sticky)哈希。前者使用一致性哈希确保消费者上线、掉线时的负载平衡；后者是客户端手动设置，所有在某个范围内的哈希都会分配到同一个消费者。</p><div class="language-java codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-java codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token class-name">Consumer</span><span class="token plain"> </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics"> </span><span class="token generics class-name">String</span><span class="token generics"> </span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> consumer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Schema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">JSON</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscriptionMode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">SubscriptionMode</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Durable</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;our-topic&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">consumerName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;auto-hashed-consumer&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscriptionName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;auto-hashed&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscriptionType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">SubscriptionType</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Key_Shared</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">keySharedPolicy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">KeySharedPolicy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">autoSplitHashRange</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">consumer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Schema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">STRING</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscriptionMode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">SubscriptionMode</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Durable</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;persistent://public/default/sticky&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">consumerName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;my-consumer&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscriptionName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;sticky-sub&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscriptionType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">SubscriptionType</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Key_Shared</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">keySharedPolicy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">KeySharedPolicy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">stickyHashRange</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ranges</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">range</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="failover订阅">Failover订阅<a class="hash-link" href="#failover订阅" title="Direct link to heading">​</a></h3><p>Failover订阅允许多个消费者连接topic，但是broker只会选择一个消费者(通常是第一个订阅的消费者)作为leader，消息将只通过该消费者传递，如下图所示。</p><p><img loading="lazy" alt="Failover Subscription" src="/assets/images/failover-subscription-284f5a3f57eb9fb68fb373ea0cd7501b.png" width="1425" height="211" class="img_E7b_"></p><div class="language-java codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-java codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token class-name">Consumer</span><span class="token plain"> consumer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;my-topic&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscriptionName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;my-subscription&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ackTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">TimeUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SECONDS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscriptionType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">SubscriptionType</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Failover</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Failover订阅在确保有序性的同时，还确保消息处理的性能。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="ack响应">ACK响应<a class="hash-link" href="#ack响应" title="Direct link to heading">​</a></h2><p>ACK响应指由消费者发送给broker的应答，收到该应答即意味着一组消息已经被消费(broker可以选择删除消息)。Pulsar支持2种ACK：单个ACK和累计ACK。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="单个ack">单个ACK<a class="hash-link" href="#单个ack" title="Direct link to heading">​</a></h3><p>默认情况下，topic的每条消息都对应一个ACK，所有订阅模式都支持单个ACK(Individual Ack)。</p><p><img loading="lazy" alt="Individual Ack" src="data:image/png;base64,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" width="357" height="135" class="img_E7b_"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="累计ack">累计ACK<a class="hash-link" href="#累计ack" title="Direct link to heading">​</a></h3><p>累计ACK是某个偏移位置消息的答应，意味着该消息之前的所有消息都已成功处理(批量应答)，所有订阅模式都支持累计ACK(Cumulative Ack)。</p><p><img loading="lazy" alt="Cumulative Ack" src="/assets/images/cumulative-ack-15820aee0b2b3125f3b8e98c5a0ebfc0.png" width="526" height="220" class="img_E7b_"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="模式">模式<a class="hash-link" href="#模式" title="Direct link to heading">​</a></h2><p>模式(schema)是Pulsar生态中可选但是颇具影响的部分，本节介绍消费者与模式的交互部分。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="消费者模式管理">消费者模式管理<a class="hash-link" href="#消费者模式管理" title="Direct link to heading">​</a></h3><p>消费者和模式的交互有2种：</p><ol><li>当topic设置了schema，消费者只需要按照schema解码消息(schema随着消息一块发送)；</li><li>当topic没有设置schema，消费者自行注册schema。</li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="消费模式">消费模式<a class="hash-link" href="#消费模式" title="Direct link to heading">​</a></h2><p>一个一个串行地消费消息可能是最好的，但Pulsar提供额外的消费模式。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="批处理">批处理<a class="hash-link" href="#批处理" title="Direct link to heading">​</a></h3><p>批处理(Batching)模式对消费者没有什么重大影响，只不过消费者会对整批的消息响应ACK。在Pulsar 2.8版本之前，如果消费者在处理最后几条消息时挂掉，批处理模式下需要重头开始处理。但自Pulsar 2.8起，引入批索引(batch index)准确地指出上一个批处理的结束位置。</p><p><img loading="lazy" alt="Batching Consumption" src="/assets/images/batching-consumption-fd224c509ed295503090d29c2a29e1e8.png" width="982" height="153" class="img_E7b_"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="块处理">块处理<a class="hash-link" href="#块处理" title="Direct link to heading">​</a></h3><p>块处理模式下消费者接收带有元数据消息块，将其拼接完整后回复ACK，如下图所示：</p><p><img loading="lazy" alt="Chunk Consumption" src="/assets/images/chunk-consumption-f729fe5871ffc619d6c0ead6b129c75d.png" width="952" height="129" class="img_E7b_"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="高级设置">高级设置<a class="hash-link" href="#高级设置" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="延迟消息">延迟消息<a class="hash-link" href="#延迟消息" title="Direct link to heading">​</a></h3><p>延迟消息指延迟发送消息，<strong>只能</strong>在共享订阅下使用。如下图所示，当消费者获取topic中的延迟消息，由DelayedDeliveryTracker配置超时时间后才发送消息给消费者。</p><p><img loading="lazy" alt="Delayed Messages" src="/assets/images/delayed-messages-e6d176c9d7a00086e9fcc48751425585.png" width="1425" height="214" class="img_E7b_"></p><div class="language-java codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-java codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">producer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">deliverAfter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">TimeUnit</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Minute</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Hello Moto!&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="保留策略">保留策略<a class="hash-link" href="#保留策略" title="Direct link to heading">​</a></h3><p>Pulsar提供2个参数来配置<strong>已响应消息</strong>的保留策略：保留时间、保留大小。如下所示通过Pulsar Admin命令行工具设置消息保留时间为3小时，保留大小为10GB：</p><div class="language-bash codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-bash codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">pulsar-admin namespaces set-retention </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my-tenant/new-namespace </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --size 10G </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --time 3h</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><table><thead><tr><th>保留时间</th><th>保留大小</th><th>保留策略</th></tr></thead><tbody><tr><td>-1</td><td>-1</td><td>永久保留</td></tr><tr><td>-1</td><td>&gt;0</td><td>达到指定大小后不再保</td></tr><tr><td>0</td><td>-1</td><td>达到指定时间后不再保留</td></tr><tr><td>0</td><td>0</td><td>禁用保留</td></tr><tr><td>0</td><td>&gt;0</td><td>无效值</td></tr><tr><td>&gt;0</td><td>0</td><td>无效值</td></tr><tr><td>&gt;0</td><td>&gt;0</td><td>达到指定时间或大小后不再保留</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_mojV" id="积压配额">积压配额<a class="hash-link" href="#积压配额" title="Direct link to heading">​</a></h3><p>默认情况下，Pulsar保存所有<strong>未响应消息</strong>，通过积压配额(Backlog Quotas)设置未响应消息的保留策略：</p><div class="language-bash codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-bash codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">pulsar-admin namespaces set-backlog-quota my-tenant/my-namespace </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --limit 2G </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --limitTime </span><span class="token number" style="color:#36acaa">36000</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --policy producer_request_hold</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当未响应消息达到积压配额后，通过<code>policy</code>参数设置接下来的行为：</p><ul><li><strong>producer_request_hold</strong>：broker不再保留消息；</li><li><strong>producer_exception</strong>：broker断开连接并抛出异常；</li><li><strong>consumer_backlog_eviction</strong>：broker删除积压消息。</li></ul><p>此外，还可以设置消息TTL：</p><div class="language-bash codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-bash codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">pulsar-admin namespaces set-message-ttl my-tenant/my-namespace </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --messageTTL </span><span class="token number" style="color:#36acaa">120</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 单位秒</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>积压配额和保留策略异同</h5></div><div class="admonition-content"><p>相同点：</p><ul><li>提供时间、体积2种配置参数</li><li>设置级别为namespace</li></ul><p>不同点：</p><ul><li>保留策略直接删除，积压配额行为由设置决定</li><li>保留策略针对已响应消息，积压配额针对未响应消息</li></ul></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="消费者配置">消费者配置<a class="hash-link" href="#消费者配置" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="replay">Replay<a class="hash-link" href="#replay" title="Direct link to heading">​</a></h3><p>重放消息(replay)指从头开始读取topic中的消息，Pulsar提供3种方式：</p><ul><li>代码重置游标：</li></ul><div class="language-java codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-java codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">org</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">apache</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">pulsar</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">client</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">api</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">MessageId</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">org</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">apache</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">pulsar</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">client</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">api</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">Reader</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Reader</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> reader </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pulsarClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newReader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;read-from-topic&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">startMessageId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MessageId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">earliest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// get data at earliest offset</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Message</span><span class="token plain"> message </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> reader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readNext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Get messages after this point</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="Replay" src="/assets/images/replay-9e1878b063541db8aa8e0d5d852c50e0.png" width="813" height="479" class="img_E7b_"></p><ul><li>设置negative ACK：</li></ul><div class="language-java codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-java codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token class-name">Consumer</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> consumer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Client</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscriptionType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">SubscriptionType</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Key_Shared</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscriptionName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;abc-sub&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;abbc&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Message</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> message </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> consumer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">receive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">TimeUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MILLISECONDS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    consumer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">negativeAcknowledge</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="Negative ACK" src="/assets/images/negative-ack-ff29bc2c69879a0535770802c742e900.png" width="1190" height="115" class="img_E7b_"></p><ul><li>命令行重置游标：</li></ul><div class="language-bash codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-bash codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">pulsar-admin topics reset-cursor topic a --subscription my-subscription</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POST/admin/persistent/:tenant/:namespace/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    :destination/subscription/:subName/resetcursor</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="dead-letter-topics">Dead Letter Topics<a class="hash-link" href="#dead-letter-topics" title="Direct link to heading">​</a></h3><p>当遇到不能被处理的消息(模式校验失败、消费者不能及时处理、消费者处理时故障)时，可设置Dead Letter Topic保存失败消息，在Pulsar中消息失败表现为2种：negative ACK、ACK超时。通过如下代码设置订阅的Dead Letter Topic:</p><div class="language-java codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-java codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token class-name">Consumer</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> consumer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pulsarClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Schema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BYTES</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">topic</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscriptionName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;hello-moto&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscriptionType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">SubscriptionType</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Shared</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">deadLetterPolicy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">DeadLetterPolicy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">maxRedeliverCount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">maxRedeliveryCount</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">deadLetterTopic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;hello-moto-dlq&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 设置dead letter topic名称</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>默认dead letter topic的名称为<code>&lt;topicname&gt;-&lt;subscriptionname&gt;-DLQ</code>，也可以代码设置。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="retry-letter-topic">Retry Letter Topic<a class="hash-link" href="#retry-letter-topic" title="Direct link to heading">​</a></h3><p>Retry letter topic用于消费者重新获取消息：</p><div class="language-java codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-java codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token class-name">Consumer</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> consumer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pulsarClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Schema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BYTES</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">topic</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscriptionName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;scary-hours&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscriptionType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">SubscriptionType</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Shared</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">enableRetry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">receiverQueueSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">deadLetterPolicy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">DeadLetterPolicy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">maxRedeliverCount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">maxRedeliveryCount</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">retryLetterTopic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;persistent://my-property/my-ns/scary-hours-retry-Retry&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscriptionInitialPosition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">SubscriptionInitialPosition</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Earliest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="总结">总结<a class="hash-link" href="#总结" title="Direct link to heading">​</a></h2><ol><li>Pular将消费者和topic之间的交互配置抽象为订阅(subscription)，分为如下4种：<ol><li>独家订阅：一对一关系；</li><li>共享订阅：一对多关系；</li><li>Key_Shared：共享订阅的一种特殊情况；</li><li>Failvoer订阅：类似消费者组。</li></ol></li><li>消息者接收到topic消息后给broker回复ACK，分为单个ACK和累计ACK两种；</li><li>除了逐个消费外，Pulsar还有批处理和块处理两种模式；</li><li>生产者可以设置消息延迟，只适用于共享订阅；</li><li>已响应消息处理由保留策略决定，未响应消息处理由积压配额决定；</li><li>消费者设置选择replay消息，当处理消息失败时设置dead letter topic保存失败消息。</li></ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/docs/tags/apache-pulsar">Apache Pulsar</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/docs/tags/reading-notes">ReadingNotes</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/kayhaw/kayhaw.github.io/edit/master/website/docs/Mastering Apache Pulsar/04-Mastering-Apache-Pulsar-Chap05.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Mastering-Apache-Pulsar/Chap04"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Pulsar组件</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Mastering-Apache-Pulsar/Chap06"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">生产者</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#消费者意味着什么" class="table-of-contents__link toc-highlight">消费者意味着什么?</a></li><li><a href="#订阅" class="table-of-contents__link toc-highlight">订阅</a><ul><li><a href="#独家订阅" class="table-of-contents__link toc-highlight">独家订阅</a></li><li><a href="#共享订阅" class="table-of-contents__link toc-highlight">共享订阅</a></li><li><a href="#key_shared订阅" class="table-of-contents__link toc-highlight">Key_Shared订阅</a></li><li><a href="#failover订阅" class="table-of-contents__link toc-highlight">Failover订阅</a></li></ul></li><li><a href="#ack响应" class="table-of-contents__link toc-highlight">ACK响应</a><ul><li><a href="#单个ack" class="table-of-contents__link toc-highlight">单个ACK</a></li><li><a href="#累计ack" class="table-of-contents__link toc-highlight">累计ACK</a></li></ul></li><li><a href="#模式" class="table-of-contents__link toc-highlight">模式</a><ul><li><a href="#消费者模式管理" class="table-of-contents__link toc-highlight">消费者模式管理</a></li></ul></li><li><a href="#消费模式" class="table-of-contents__link toc-highlight">消费模式</a><ul><li><a href="#批处理" class="table-of-contents__link toc-highlight">批处理</a></li><li><a href="#块处理" class="table-of-contents__link toc-highlight">块处理</a></li></ul></li><li><a href="#高级设置" class="table-of-contents__link toc-highlight">高级设置</a><ul><li><a href="#延迟消息" class="table-of-contents__link toc-highlight">延迟消息</a></li><li><a href="#保留策略" class="table-of-contents__link toc-highlight">保留策略</a></li><li><a href="#积压配额" class="table-of-contents__link toc-highlight">积压配额</a></li></ul></li><li><a href="#消费者配置" class="table-of-contents__link toc-highlight">消费者配置</a><ul><li><a href="#replay" class="table-of-contents__link toc-highlight">Replay</a></li><li><a href="#dead-letter-topics" class="table-of-contents__link toc-highlight">Dead Letter Topics</a></li><li><a href="#retry-letter-topic" class="table-of-contents__link toc-highlight">Retry Letter Topic</a></li></ul></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">读书笔记</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.zhihu.com/people/xiao-ke-dou-7" target="_blank" rel="noopener noreferrer" class="footer__link-item">知乎<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/kayhaw" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gitee.com/kayhaw" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 何轲(Kay Haw). Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.a8170a08.js"></script>
<script src="/assets/js/main.1794f536.js"></script>
</body>
</html>