<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Kay Haw&#39;s Blog Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Kay Haw&#39;s Blog Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"><title data-react-helmet="true">å–æ¶ˆä¸å…³é—­ | Kay Haw&#x27;s Blog</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://kayhaw.github.io/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap07"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="å–æ¶ˆä¸å…³é—­ | Kay Haw&#x27;s Blog"><meta data-react-helmet="true" name="description" content="ã€ŠJavaå¹¶å‘ç¼–ç¨‹ã€‹ç¬¬ä¸ƒç« è¯»ä¹¦ç¬”è®°"><meta data-react-helmet="true" property="og:description" content="ã€ŠJavaå¹¶å‘ç¼–ç¨‹ã€‹ç¬¬ä¸ƒç« è¯»ä¹¦ç¬”è®°"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://kayhaw.github.io/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap07"><link data-react-helmet="true" rel="alternate" href="https://kayhaw.github.io/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap07" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://kayhaw.github.io/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap07" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.0138175c.css">
<link rel="preload" href="/assets/js/runtime~main.7b33080d.js" as="script">
<link rel="preload" href="/assets/js/main.9bda434a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Kay Haw&#x27;s Blog" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Kay Haw&#x27;s Blog" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Kay Haw&#x27;s Blog</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro">è¯»ä¹¦ç¬”è®°</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/kayhaw" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ğŸŒ</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/intro">è¯»ä¹¦ç¬”è®°</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">C++PrimerPlus</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">EffectiveC++</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Learning Akka</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Stream Processing with Apache Flink</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap02">çº¿ç¨‹å®‰å…¨æ€§</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap03">å¯¹è±¡çš„å…±äº«</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap04">å¯¹è±¡çš„ç»„åˆ</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap05">åŸºç¡€æ„å»ºæ¨¡å—</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap06">ä»»åŠ¡æ‰§è¡Œ</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap07">å–æ¶ˆä¸å…³é—­</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap08">çº¿ç¨‹æ± çš„ä½¿ç”¨</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap10">é¿å…æ´»è·ƒæ€§å±é™©</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap13">æ˜¾å¼é”</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap14">æ„å»ºè‡ªå®šä¹‰çš„åŒæ­¥å·¥å…·</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap15">åŸå­å˜é‡ä¸éé˜»å¡åŒæ­¥æœºåˆ¶</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap16">Javaå†…å­˜æ¨¡å‹</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">é«˜æ€§èƒ½MySQL</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>å–æ¶ˆä¸å…³é—­</h1></header><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>ã€ŠJavaå¹¶å‘ç¼–ç¨‹ã€‹ç¬¬ä¸ƒç« è¯»ä¹¦ç¬”è®°</p></div></div><p>ç¬¬6ç« ä»‹ç»äº†ä»»åŠ¡çš„åˆ›å»ºå’Œå¯åŠ¨ï¼Œç»å¤§å¤šæ•°æƒ…å†µä¸‹ä»»åŠ¡ä¼šä¸€ç›´è¿è¡Œåˆ°ç»“æŸã€‚ç„¶è€Œï¼Œæœ‰äº›æ—¶å€™å¸Œæœ›æå‰ç»“æŸä»»åŠ¡(ç”¨æˆ·ç‚¹å‡»å–æ¶ˆã€åº”ç”¨ç¨‹åºè¢«å…³é—­)ï¼Œä¸€ä¸ªè¡Œä¸ºè‰¯å¥½çš„ç¨‹åºåº”è¯¥èƒ½å¤Ÿå®Œå–„åœ°å¤„ç†è¿™äº›å¤±è´¥ã€å…³é—­å’Œå–æ¶ˆç­‰æ“ä½œï¼Œæœ¬ç« è®¨è®ºå¦‚ä½•å®ç°ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="ä»»åŠ¡å–æ¶ˆ"></a>ä»»åŠ¡å–æ¶ˆ<a class="hash-link" href="#ä»»åŠ¡å–æ¶ˆ" title="Direct link to heading">#</a></h2><p><strong>å¯å–æ¶ˆçš„(Cancellable)</strong>ï¼šå¤–éƒ¨ä»£ç èƒ½å¤Ÿåœ¨æŸä¸ªæ“ä½œæ­£å¸¸å®Œæˆå‰å°†å…¶ç½®ä¸ºâ€œå®Œæˆâ€çŠ¶æ€ã€‚å–æ¶ˆæ“ä½œçš„åŸå› ï¼š</p><ul><li>ç”¨æˆ·è¯·æ±‚ï¼šç”¨æˆ·ç‚¹å‡»å–æ¶ˆæŒ‰é’®</li><li>æ—¶é—´é™åˆ¶ï¼šè¶…æ—¶åå–æ¶ˆè¿è¡Œä»»åŠ¡</li><li>ç¨‹åºäº‹ä»¶ï¼šå­ä»»åŠ¡æ‰¾åˆ°ç­”æ¡ˆï¼Œå–æ¶ˆå…¶ä»–ä»»åŠ¡</li><li>ç¨‹åºé”™è¯¯ï¼šçˆ¬è™«ä»»åŠ¡é‡åˆ°ç£ç›˜å·²æ»¡ï¼Œå–æ¶ˆå…¶ä»–ä»»åŠ¡</li><li>ç¨‹åºå…³é—­</li></ul><p>Javaå¹¶æ²¡æœ‰æä¾›å®‰å…¨çš„æŠ¢å æ–¹æ³•æ¥åœæ­¢çº¿ç¨‹(stopã€suspendå­˜åœ¨é—®é¢˜)ï¼Œä½†å­˜åœ¨ä¸€äº›åä½œå¼æœºåˆ¶æ¥å–æ¶ˆçº¿ç¨‹ï¼Œä¾‹å¦‚ä½¿ç”¨volatileå˜é‡ä½œä¸ºâ€œå·²è¯·æ±‚å–æ¶ˆâ€çš„æ ‡å¿—ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class PrimeGenerator implements Runnable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static ExecutorService exec = Executors.newCachedThreadPool();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final List&lt;BigInteger&gt; primes = new ArrayList&lt;BigInteger&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private volatile boolean cancelled;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        BigInteger p = BigInteger.ONE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (!cancelled) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            p = p.nextProbablePrime();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            synchronized (this) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                primes.add(p);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void cancel() { cancelled = true; }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized List&lt;BigInteger&gt; get() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ArrayList&lt;BigInteger&gt;(primes);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static List&lt;BigInteger&gt; aSecondOfPrimes() throws InterruptedException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PrimeGenerator generator = new PrimeGenerator();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exec.execute(generator);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SECONDS.sleep(1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            generator.cancel();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return generator.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>PrimeGeneratoræ˜¯ä¸€ä¸ªç´ æ•°ç”Ÿæˆï¼Œé€šè¿‡cancelledæ ‡å¿—ç¡®å®šæ˜¯å¦ç»§ç»­ç”Ÿæˆä¸‹ä¸€ä¸ªç´ æ•°ã€‚aSecondOfPrimesæ–¹æ³•æäº¤ä»»åŠ¡ï¼Œå¹¶åœ¨æ‰§è¡Œ1ç§’åå–æ¶ˆã€‚</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>å–æ¶ˆç­–ç•¥</h5></div><div class="admonition-content"><p>ä¸€ä¸ªä»»åŠ¡å¿…é¡»æ‹¥æœ‰å–æ¶ˆç­–ç•¥ï¼šè¯¦ç»†å®šä¹‰å–æ¶ˆæ“ä½œçš„Howã€Whatã€Whenè¦ç´ ï¼Œå³å…¶ä»–ä»£ç æ€ä¹ˆ(how)å–æ¶ˆè¯¥ä»»åŠ¡</p></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ä¸­æ–­"></a>ä¸­æ–­<a class="hash-link" href="#ä¸­æ–­" title="Direct link to heading">#</a></h3><p>ç®€å•åœ°ä½¿ç”¨volatileä½œä¸ºå–æ¶ˆæ ‡å¿—ä¹Ÿå­˜åœ¨é—®é¢˜ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">class BrokenPrimeProducer extends Thread {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final BlockingQueue&lt;BigInteger&gt; queue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private volatile boolean cancelled = false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    BrokenPrimeProducer(BlockingQueue&lt;BigInteger&gt; queue) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.queue = queue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            BigInteger p = BigInteger.ONE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (!cancelled)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                queue.put(p = p.nextProbablePrime());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (InterruptedException consumed) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void cancel() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        cancelled = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>å½“ç”Ÿäº§è€…åœ¨putæ–¹æ³•ä¸­é˜»å¡æ—¶ï¼Œæ¶ˆè´¹è€…è°ƒç”¨cancelæ–¹æ³•ï¼Œä½†æ­¤æ—¶ç”Ÿäº§è€…æ°¸è¿œæ— æ³•æ£€æµ‹åˆ°cancelledæ ‡å¿—ä¸ºfalseã€‚æ­¤æ—¶ï¼Œå¯ä»¥é€‰æ‹©ä¸­æ–­æ¥å®ç°å–æ¶ˆæ“ä½œï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class PrimeProducer extends Thread {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final BlockingQueue&lt;BigInteger&gt; queue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    PrimeProducer(BlockingQueue&lt;BigInteger&gt; queue) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.queue = queue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            BigInteger p = BigInteger.ONE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (!Thread.currentThread().isInterrupted())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                queue.put(p = p.nextProbablePrime());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (InterruptedException consumed) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            /* Allow thread to exit */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å°†interruptæ–¹æ³•å°è£…åœ¨cancelä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void cancel() { interrupt(); }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>çº¿ç¨‹ä¸­æ–­æ˜¯ä¸€ç§åä½œæœºåˆ¶ï¼Œå®ƒé€šçŸ¥çº¿ç¨‹åœ¨åˆé€‚æƒ…å†µä¸‹åœæ­¢å½“å‰å·¥ä½œï¼ŒThreadç±»æä¾›äº†å¦‚ä¸‹ä¸‰ç§æ–¹æ³•ï¼š</p><ol><li>public void interrupt()ï¼šä¸­æ–­ç›®æ ‡çº¿ç¨‹</li><li>public boolean isInterrupted()ï¼šè¿”å›ç›®æ ‡çº¿ç¨‹ä¸­æ–­çŠ¶æ€</li><li>public static boolean interrupted()ï¼šæ¸…é™¤å½“å‰çº¿ç¨‹ä¸­æ–­çŠ¶æ€(è®¾ç½®ä¸ºfalse)å¹¶è¿”å›ä¹‹å‰çš„çŠ¶æ€ï¼Œè¿™æ˜¯æ¸…é™¤ä¸­æ–­çŠ¶æ€çš„å”¯ä¸€æ–¹æ³•</li></ol><p>è°ƒç”¨interruptæ–¹æ³•å¹¶ä¸æ˜¯æ„å‘³ç€ç«‹å³åœæ­¢è¿è¡Œçº¿ç¨‹ï¼Œåªæ˜¯ä¼ é€’ä¸­æ–­è¯·æ±‚æ¶ˆæ¯ã€‚è®¾è®¡è‰¯å¥½çš„æ–¹æ³•åº”è¯¥å¯¹ä¸­æ–­è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œè®¾è®¡ç³Ÿç³•çš„æ–¹æ³•å¿½ç•¥ä¸­æ–­è¯·æ±‚ï¼Œå¯¼è‡´å…¶ä»–ä»£ç æ— æ³•å¯¹ä¸­æ–­è¯·æ±‚è¿›è¡Œå“åº”ã€‚</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>é€šå¸¸ï¼Œä¸­æ–­æ˜¯å®ç°å–æ¶ˆçš„æœ€åˆç†æ–¹å¼</p></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ä¸­æ–­ç­–ç•¥"></a>ä¸­æ–­ç­–ç•¥<a class="hash-link" href="#ä¸­æ–­ç­–ç•¥" title="Direct link to heading">#</a></h3><p>ä»»åŠ¡åº”è¯¥åŒ…å«å–æ¶ˆç­–ç•¥ï¼Œé‚£å¯¹åº”çº¿ç¨‹ä¹Ÿè¦åŒ…å«ä¸­æ–­ç­–ç•¥ã€‚åˆç†çš„ä¸­æ–­ç­–ç•¥æ˜¯å°½å¿«é€€å‡ºï¼Œåœ¨å¿…è¦æ—¶è¿›è¡Œæ¸…ç†ï¼Œé€šçŸ¥æŸä¸ªçº¿ç¨‹æ‰€æœ‰è€…å·²ç»é€€å‡ºã€‚ä»»åŠ¡ä¸ä¼šåœ¨è‡ªå·±æ‹¥æœ‰çš„çº¿ç¨‹ä¸­è¿è¡Œï¼Œåº”è¯¥å°å¿ƒåœ°ä¿å­˜ä¸­æ–­çŠ¶æ€ï¼Œè¿™æ ·æ‹¥æœ‰çº¿ç¨‹çš„ä»£ç æ‰èƒ½å“åº”ä¸­æ–­ã€‚æ£€æŸ¥åˆ°ä¸­æ–­è¯·æ±‚åï¼Œä»»åŠ¡ä¸éœ€è¦ç«‹å³æ”¾å¼ƒæ‰€æœ‰æ“ä½œï¼Œå¯ä»¥åœ¨å®Œæˆå½“å‰ä»»åŠ¡åæŠ›å‡ºInterruptedExceptionï¼Œå¹¶ä¸”è°ƒç”¨Thread.currentThread().interrupt()æ–¹æ³•æ¢å¤ä¸­æ–­çŠ¶æ€ã€‚</p><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</h5></div><div class="admonition-content"><p>æ¯ä¸ªçº¿ç¨‹æœ‰å„è‡ªçš„ä¸­æ–­ç­–ç•¥ï¼Œåˆ«è½»æ˜“ä¸­æ–­çº¿ç¨‹</p></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="å“åº”ä¸­æ–­"></a>å“åº”ä¸­æ–­<a class="hash-link" href="#å“åº”ä¸­æ–­" title="Direct link to heading">#</a></h3><p>å¤„ç†ä¸­æ–­æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ol><li>ä¼ é€’ä¸­æ–­å¼‚å¸¸ï¼šåœ¨æ–¹æ³•ç­¾åä¸ŠåŠ ä¸Šthrows InterruptedExceptionï¼Œè‡ªå·±ä»€ä¹ˆéƒ½ä¸å¤„ç†</li><li>æ¢å¤ä¸­æ–­çŠ¶æ€ï¼štry-catchæ•è·InterruptedExceptionåï¼Œé‡æ–°è°ƒç”¨Thread.currentThread().interrupt()</li></ol><p>å¯¹äºä½¿ç”¨Runnableå®šä¹‰çš„ä»»åŠ¡ï¼Œæ–¹å¼1ä¸å¯è¡Œï¼Œåªèƒ½é€šè¿‡æ–¹å¼2ï¼Œä¾‹å¦‚ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class NoncancelableTask {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Task getNextTask(BlockingQueue&lt;Task&gt; queue) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean interrupted = false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (true) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return queue.take();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (InterruptedException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    interrupted = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // é‡æ–°å°è¯•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (interrupted)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Thread.currentThread().interrupt();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ç¤ºä¾‹è®¡æ—¶è¿è¡Œ"></a>ç¤ºä¾‹ï¼šè®¡æ—¶è¿è¡Œ<a class="hash-link" href="#ç¤ºä¾‹è®¡æ—¶è¿è¡Œ" title="Direct link to heading">#</a></h3><p>å›é¡¾PrimeGeneratorçš„ä»£ç ï¼Œé™æ€æ–¹æ³•aSecondOfPrimeså¯åŠ¨ä¸€ä¸ªPrimeGenertorçº¿ç¨‹ï¼Œè¿è¡Œ1ç§’ååœæ­¢ï¼Œè¯¥ä»£ç å­˜åœ¨çš„é—®é¢˜æ˜¯PrimeGeneratorè¿è¡ŒæŠ›å‡ºçš„å¼‚å¸¸ä¼šè¢«å¿½ç•¥ã€‚ä¸ºäº†è§£å†³å¼‚å¸¸æœªæ•è·çš„é—®é¢˜ï¼Œå¦‚ä¸‹ä»£ç ç»™å‡ºäº†åœ¨æŒ‡å®šæ—¶é—´å†…è¿è¡Œä»»æ„ä¸€ä¸ªrunnableçš„ç¤ºä¾‹ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class TimedRun1 {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ScheduledExecutorService cancelExec = Executors.newScheduledThreadPool(1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void timedRun(Runnable r, long timeout, TimeUnit unit) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Thread taskThread = Thread.currentThread();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¾ç½®ä¸€ä¸ªå–æ¶ˆå®šæ—¶ä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        cancelExec.schedule(new Runnable() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                taskThread.interrupt();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }, timeout, unit);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        r.run();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>è¯¥ç¤ºä¾‹ç›´æ¥æ‰§è¡Œä»»åŠ¡rï¼Œå¹¶è®¾ç½®äº†ä¸€ä¸ªå–æ¶ˆä»»åŠ¡ï¼Œè¯¥å–æ¶ˆä»»åŠ¡åœ¨æŒ‡å®šæ—¶é—´åä¸­æ–­ä»»åŠ¡æ‰§è¡Œã€‚åœ¨æ»¡è¶³å®šæ—¶è¿è¡Œçš„è¦æ±‚ï¼Œä»»åŠ¡æŠ›å‡ºçš„å¼‚å¸¸å¯ä»¥è¢«timedRunæ–¹æ³•æ•è·ã€‚è¿™ç§æ–¹æ³•ååˆ†ç®€å•ï¼Œä½†æ˜¯ç ´åäº†è§„åˆ™ï¼š<strong>åœ¨ä¸­æ–­çº¿ç¨‹å‰ï¼Œåº”è¯¥äº†è§£å®ƒçš„ä¸­æ–­ç­–ç•¥</strong>ã€‚å¦‚æœr.run()åœ¨timeoutå‰å°±å®Œæˆï¼Œé‚£ä¹ˆå–æ¶ˆä»»åŠ¡å°†ä¼šåœ¨timedRunè¿”å›ä¹‹åè§¦å‘ï¼Œè¿™ç§è¡Œä¸ºçš„åæœæ˜¯æœªçŸ¥çš„(å°½ç®¡ç”¨scheduleæ–¹æ³•è¿”å›çš„ScheduleFutureæ¥å–æ¶ˆä»»åŠ¡ï¼Œä½†æ˜¯è¿‡äºå¤æ‚)ã€‚å¹¶ä¸”å¦‚æœrä¸å“åº”ä¸­æ–­ï¼Œé‚£timedRunåœ¨rç»“æŸåè¿”å›ï¼Œæ­¤æ—¶å¯èƒ½å·²ç»è¶…æ—¶æˆ–è€…ä¸ºè¶…æ—¶ï¼Œæ²¡æœ‰è¾¾åˆ°é™æ—¶æ‰§è¡Œçš„è¦æ±‚ã€‚</p><p>å¦‚ä¸‹ä»£ç è§£å†³äº†aSecondOfPrimesçš„å¼‚å¸¸å¤„ç†é—®é¢˜å’ŒTimedRun1çš„é—®é¢˜ã€‚æ‰§è¡Œä»»åŠ¡taskä¸å“åº”ä¸­æ–­ï¼Œå¹¶å°†å…¶å¯èƒ½é‡åˆ°çš„å¼‚å¸¸ä¿å­˜åœ¨tä¸­ï¼ŒtimedRunæ‰§è¡Œé™æ—¶çš„task.join(timeout)æ–¹æ³•ï¼Œå› æ­¤ä¸»çº¿ç¨‹ä¼šå®šæ—¶é˜»å¡åˆ°taskç»“æŸï¼Œè¿™é‡Œæœ‰ä¸¤ç§æƒ…å†µï¼š</p><ol><li>taskåœ¨timeoutå†…ç»“æŸ(æ­£å¸¸ã€å¼‚å¸¸)ï¼Œé€šè¿‡rethrowæ–¹æ³•é‡æ–°æŠ›å‡ºå¯èƒ½é‡åˆ°çš„å¼‚å¸¸</li><li>taskåœ¨timeoutå†…è¿˜æœªç»“æŸï¼Œæ­¤æ—¶ç”±cancelExecè°ƒç”¨task.interrupt()æ¥ä½¿å…¶é€€å‡º</li></ol><p>è¯¥æ–¹æ¡ˆå­˜åœ¨çš„é—®é¢˜ï¼šä¸»çº¿ç¨‹æ‰§è¡Œtask.rethrow()æ—¶ï¼Œä¸èƒ½ç¡®å®štaskæ˜¯æ­£å¸¸é€€å‡ºè€Œè¿”å›è¿˜æ˜¯å› ä¸ºjoinè¶…æ—¶è€Œè¿”å›ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class TimedRun2 {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ScheduledExecutorService cancelExec = newScheduledThreadPool(1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void timedRun(final Runnable r, long timeout, TimeUnit unit) </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    throws InterruptedException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        class RethrowableTask implements Runnable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            private volatile Throwable t;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    r.run();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (Throwable t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    this.t = t;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            void rethrow() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (t != null)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw launderThrowable(t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RethrowableTask task = new RethrowableTask();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Thread taskThread = new Thread(task);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        taskThread.start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        cancelExec.schedule(new Runnable() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                taskThread.interrupt();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }, timeout, unit);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        taskThread.join(unit.toMillis(timeout));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        task.rethrow();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="é€šè¿‡futureæ¥å®ç°å–æ¶ˆ"></a>é€šè¿‡Futureæ¥å®ç°å–æ¶ˆ<a class="hash-link" href="#é€šè¿‡futureæ¥å®ç°å–æ¶ˆ" title="Direct link to heading">#</a></h3><p>å®é™…ä¸ŠFutureå·²ç»æä¾›äº†å–æ¶ˆä»»åŠ¡çš„æ–¹æ³•cancelï¼Œé€šè¿‡Futureæ¥å–æ¶ˆä»»åŠ¡çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class TimedRun {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ExecutorService taskExec = Executors.newCachedThreadPool();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void timedRun(Runnable r, long timeout, TimeUnit unit)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throws InterruptedException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Future&lt;?&gt; task = taskExec.submit(r);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            task.get(timeout, unit);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (TimeoutException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è¿è¡Œè¶…æ—¶ï¼Œåˆ°finallyå—æ‰§è¡Œä»»åŠ¡å–æ¶ˆ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (ExecutionException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è¿è¡Œæœªè¶…æ—¶ä¸­é‡åˆ°å¼‚å¸¸ï¼Œé‡æ–°æŠ›å‡ºå¼‚å¸¸</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw launderThrowable(e.getCause());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è°ƒç”¨cancelï¼Œå³ä½¿ä»»åŠ¡å·²ç»ç»“æŸä¹Ÿä¸ä¼šæœ‰ä»»åŠ¡å½±å“</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å¦‚æœä»»åŠ¡è¿˜åœ¨è¿è¡Œï¼Œå°†ä¼šè¢«ä¸­æ–­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            task.cancel(true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>cancelæ–¹æ³•æ¥å—booleanç±»å‹å‚æ•°mayInterruptIfRunningï¼Œä¸ºtrueè¡¨ç¤ºä¸­æ–­æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œä¸ºfalseè¡¨ç¤ºä¸è¦æ‰§è¡Œè¿˜æœªè¿è¡Œçš„çº¿ç¨‹ã€‚</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>å½“Future.get()æŠ›å‡ºInterruptedExceptionæˆ–è€…TimeoutExceptionæ—¶ï¼Œè‹¥ä¸å†éœ€è¦ç»“æœå¯ä»¥è°ƒç”¨Future.cancelæ¥å–æ¶ˆä»»åŠ¡</p></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="å¤„ç†ä¸å¯ä¸­æ–­çš„é˜»å¡"></a>å¤„ç†ä¸å¯ä¸­æ–­çš„é˜»å¡<a class="hash-link" href="#å¤„ç†ä¸å¯ä¸­æ–­çš„é˜»å¡" title="Direct link to heading">#</a></h3><p>åœ¨Javaåº“ä¸­ï¼Œè®¸å¤šå¯é˜»å¡çš„æ–¹æ³•éƒ½æ˜¯é€šè¿‡æå‰è¿”å›æˆ–è€…æŠ›å‡ºInterruptedExceptionæ¥å“åº”ä¸­æ–­è¯·æ±‚ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨ä¸å¯å“åº”ä¸­æ–­çš„é˜»å¡æ–¹æ³•ï¼š</p><ul><li>Java.ioåŒ…ä¸­çš„åŒæ­¥Socket IO</li><li>Java.ioåŒ…ä¸­çš„åŒæ­¥IO</li><li>Selectorçš„å¼‚æ­¥IO</li><li>è·å–æŸä¸ªé”</li></ul><p>å¦‚ä¸‹ä»£ç ç»™å‡ºå¦‚ä½•å°è£…éæ ‡å‡†çš„å–æ¶ˆæ“ä½œï¼ŒReaderThreadé‡å†™äº†Thread.interrupt()æ–¹æ³•ï¼Œé€šè¿‡å…³é—­socketæ¥ä½¿å¾—æ‰§è¡Œreadæˆ–è€…writeçš„æ–¹æ³•æŠ›å‡ºSocketExceptionã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class ReaderThread extends Thread {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final int BUFSZ = 512;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Socket socket;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final InputStream in;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ReaderThread(Socket socket) throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.socket = socket;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.in = socket.getInputStream();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void interrupt() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            socket.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (IOException ignored) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            super.interrupt();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            byte[] buf = new byte[BUFSZ];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (true) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                int count = in.read(buf);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (count &lt; 0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                else if (count &gt; 0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    processBuffer(buf, count);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (IOException e) { /* Allow thread to exit */ }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void processBuffer(byte[] buf, int count) {}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>é‡å†™çº¿ç¨‹çš„interruptæ–¹æ³•ï¼Œå…³é—­IOæµä½¿é˜»å¡æ–¹æ³•æŠ›å‡ºå¼‚å¸¸ï¼ŒåŒæ—¶è°ƒç”¨super.interruptæ–¹æ³•ä¿è¯åŸæ¥çš„ä¸­æ–­é€»è¾‘ã€‚</p></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ç”¨newtaskforæ¥å°è£…éæ ‡å‡†çš„å–æ¶ˆ"></a>ç”¨newTaskForæ¥å°è£…éæ ‡å‡†çš„å–æ¶ˆ<a class="hash-link" href="#ç”¨newtaskforæ¥å°è£…éæ ‡å‡†çš„å–æ¶ˆ" title="Direct link to heading">#</a></h3><p>è¿˜å¯ä»¥é€šè¿‡é‡å†™newTaskForæ¥è¿›ä¸€æ­¥å°è£…ä¸Šé¢çš„éæ ‡å‡†å–æ¶ˆä»£ç ã€‚å½“æŠŠä¸€ä¸ªCallableé€šè¿‡submitæ–¹æ³•æäº¤ç»™ExecutorServiceæ—¶ï¼Œsubmitæ–¹æ³•é€šè¿‡è°ƒç”¨newTaskForæ–¹æ³•å¾—åˆ°ä¸€ä¸ªFuture(æä¾›å–æ¶ˆæ–¹æ³•cancel)ï¼Œå¹¶å°†å…¶è¿”å›ã€‚å› æ­¤ï¼Œå¯ä»¥é€šè¿‡å®šåˆ¶Futureæ”¹å˜Future.cancelçš„è¡Œä¸ºï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><details class="details_2Ziz alert alert--info details_1VDD" data-collapsed="true"><summary>é€šè¿‡newTaskForå°è£…éæ ‡å‡†çš„å–æ¶ˆæ“ä½œ</summary><div><div class="collapsibleContent_3OHp"><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class SocketUsingTask &lt;T&gt; implements CancellableTask&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Socket socket;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected synchronized void setSocket(Socket s) { socket = s; }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized void cancel() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (socket != null)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                socket.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (IOException ignored) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public RunnableFuture&lt;T&gt; newTask() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FutureTask&lt;T&gt;(this) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public boolean cancel(boolean mayInterruptIfRunning) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SocketUsingTask.this.cancel();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return super.cancel(mayInterruptIfRunning);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">interface CancellableTask &lt;T&gt; extends Callable&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void cancel();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RunnableFuture&lt;T&gt; newTask();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">class CancellingExecutor extends ThreadPoolExecutor {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public CancellingExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public CancellingExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, ThreadFactory threadFactory) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue, threadFactory);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public CancellingExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, RejectedExecutionHandler handler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue, handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public CancellingExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, ThreadFactory threadFactory, RejectedExecutionHandler handler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue, threadFactory, handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected &lt;T&gt; RunnableFuture&lt;T&gt; newTaskFor(Callable&lt;T&gt; callable) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (callable instanceof CancellableTask)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return ((CancellableTask&lt;T&gt;) callable).newTask();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        else</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return super.newTaskFor(callable);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div></div></details><p>SocketUsingTaskå®ç°äº†CancellableTaskæ¥å£ï¼Œå¹¶é‡å†™äº†Future.cancelæ–¹æ³•æ¥å…³é—­socketå’Œè°ƒç”¨super.cancelã€‚é€šè¿‡è°ƒç”¨SocketUsingTaskçš„cancelæ–¹æ³•åŒæ—¶å…³é—­åº•å±‚socketå¹¶ä¸”ä¸­æ–­çº¿ç¨‹ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="åœæ­¢åŸºäºçº¿ç¨‹çš„æœåŠ¡"></a>åœæ­¢åŸºäºçº¿ç¨‹çš„æœåŠ¡<a class="hash-link" href="#åœæ­¢åŸºäºçº¿ç¨‹çš„æœåŠ¡" title="Direct link to heading">#</a></h2><p>å¯¹äºæŒæœ‰çº¿ç¨‹çš„æœåŠ¡ï¼ŒæœåŠ¡çš„å­˜åœ¨æ—¶é—´å¾€å¾€å¤§äºåˆ›å»ºçº¿ç¨‹çš„å­˜åœ¨æ—¶é—´ï¼Œæ­¤æ—¶éœ€è¦æœåŠ¡æä¾›çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ç¤ºä¾‹æ—¥å¿—æœåŠ¡"></a>ç¤ºä¾‹ï¼šæ—¥å¿—æœåŠ¡<a class="hash-link" href="#ç¤ºä¾‹æ—¥å¿—æœåŠ¡" title="Direct link to heading">#</a></h3><p>å¦‚ä¸‹æ‰€ç¤ºä»£ç ç»™å‡ºäº†ä¸€ä¸ªç®€å•çš„æ—¥å¿—æœåŠ¡ç¤ºä¾‹ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¤šç”Ÿäº§è€…å•æ¶ˆè´¹è€…çš„è®¾è®¡æ–¹å¼ã€‚è¦åœæ­¢æ—¥å¿—çº¿ç¨‹ï¼Œä¸€ç§æ–¹å¼æ˜¯åœ¨LoggerThreadçš„runæ–¹æ³•InterruptedExceptionå¤„ç†å—ä¸­é€€å‡ºã€‚ç„¶è€Œï¼Œå¯èƒ½é˜Ÿåˆ—ä¸­æœ‰å‰©ä½™æ—¥å¿—ä¸ä¼šè¢«æ‰“å°ï¼Œå¹¶ä¸”ä»…æ˜¯æ—¥å¿—çº¿ç¨‹ç»ˆæ­¢ï¼Œå…¶ä»–è°ƒç”¨logæ–¹æ³•ç”Ÿäº§æ—¥å¿—çš„çº¿ç¨‹ä¼šè¢«é˜»å¡ã€‚å³<strong>å–æ¶ˆç”Ÿäº§è€…-æ¶ˆè´¹è€…æ“ä½œæ—¶ï¼Œè¦åŒæ—¶å–æ¶ˆç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…</strong>ï¼Œç°åœ¨ä¸­æ–­LoggerThreadçº¿ç¨‹ä¼šå…³é—­æ¶ˆè´¹è€…ï¼Œä½†ç”Ÿäº§è€…å¹¶ä¸æ˜¯ä¸“é—¨çš„çº¿ç¨‹ï¼Œä»»ä½•è·å–LogWriterå¼•ç”¨çš„çº¿ç¨‹éƒ½å¯ä»¥ä½œä¸ºç”Ÿäº§è€…ã€‚ç”±äºä¸ç¡®å®šå°†æ¥ä¼šæœ‰å“ªäº›çº¿ç¨‹æ‰“å°æ—¥å¿—ï¼Œè¦å–æ¶ˆå®ƒä»¬å°†ååˆ†å›°éš¾ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class LogWriter {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final BlockingQueue&lt;String&gt; queue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final LoggerThread logger;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final int CAPACITY = 1000;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public LogWriter(Writer writer) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.queue = new LinkedBlockingQueue&lt;String&gt;(CAPACITY);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.logger = new LoggerThread(writer);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void start() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void log(String msg) throws InterruptedException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        queue.put(msg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private class LoggerThread extends Thread {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final PrintWriter writer;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public LoggerThread(Writer writer) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.writer = new PrintWriter(writer, true); // autoflush</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                while (true)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    writer.println(queue.take());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (InterruptedException ignored) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                writer.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>å¦ä¸€ç§å…³é—­çº¿ç¨‹çš„æ–¹å¼æ˜¯è®¾ç½®â€œå…³é—­æ ‡å¿—â€ï¼Œå½“æ ‡å¿—ä½isShutDownä¸ºtrueå¹¶ä¸”å‰©ä½™æ—¥å¿—ä¸º0æ—¶ï¼Œæ¶ˆè´¹è€…æ‰å¯ä»¥å…³é—­ã€‚æ³¨æ„åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œè¿™ç§â€œå…ˆåˆ¤æ–­åè¿è¡Œâ€çš„å¤åˆæ“ä½œéƒ½éœ€è¦ä½¿ç”¨åŒæ­¥ç¡®ä¿å®‰å…¨ã€‚æœ€ç»ˆä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><details class="details_2Ziz alert alert--info details_1VDD" data-collapsed="true"><summary>å¯é çš„LogWriterå–æ¶ˆæ“ä½œ</summary><div><div class="collapsibleContent_3OHp"><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class LogService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final BlockingQueue&lt;String&gt; queue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final LoggerThread loggerThread;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final PrintWriter writer;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean isShutdown;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int reservations;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public LogService(Writer writer) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.queue = new LinkedBlockingQueue&lt;String&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.loggerThread = new LoggerThread();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.writer = new PrintWriter(writer);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void start() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        loggerThread.start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void stop() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (this) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            isShutdown = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        loggerThread.interrupt();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void log(String msg) throws InterruptedException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (this) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (isShutdown)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new IllegalStateException(/*...*/);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ++reservations;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        queue.put(msg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private class LoggerThread extends Thread {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                while (true) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        synchronized (LogService.this) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if (isShutdown &amp;&amp; reservations == 0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        String msg = queue.take();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        synchronized (LogService.this) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            --reservations;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        writer.println(msg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (InterruptedException e) { /* retry */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                writer.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div></div></details><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="å…³é—­executorservice"></a>å…³é—­ExecutorService<a class="hash-link" href="#å…³é—­executorservice" title="Direct link to heading">#</a></h3><p>åœ¨ä¸Šä¸€èŠ‚æåˆ°ExecutorServiceä¸­çš„shutdownå’ŒshutdownNowæ–¹æ³•å¯ä»¥å…³é—­ä»»åŠ¡ï¼ŒåŸºäºå®ç°çš„æ—¥å¿—ç¨‹åºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class LogService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ExecutorService exec = new SingleThreadExecutor();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final PrintWriter writer;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void start() {}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void stop() throws InterruptedException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exec.shutdown();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exec.awaitTermination(TIMEOUT, UNIT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            writer.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void log(String msg) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exec.execute(new WriterTask(msg));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (RejectedExecutionException ignored) {}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="æ¯’ä¸¸å¯¹è±¡"></a>â€œæ¯’ä¸¸â€å¯¹è±¡<a class="hash-link" href="#æ¯’ä¸¸å¯¹è±¡" title="Direct link to heading">#</a></h3><p>å¦ä¸€ç§å…³é—­ç”Ÿäº§è€…-æ¶ˆè´¹è€…æœåŠ¡çš„æ–¹å¼æ˜¯ä½¿ç”¨â€œæ¯’ä¸¸â€å¯¹è±¡ï¼šå½“ä»é˜Ÿåˆ—ä¸­å–åˆ°è¯¥å¯¹è±¡æ—¶ç«‹å³åœæ­¢ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><details class="details_2Ziz alert alert--info details_1VDD" data-collapsed="true"><summary>ä½¿ç”¨â€œæ¯’ä¸¸â€å¯¹è±¡å…³é—­ä¸€å¯¹ä¸€ç”Ÿäº§è€…-æ¶ˆè´¹è€…æœåŠ¡</summary><div><div class="collapsibleContent_3OHp"><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class IndexingService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final int CAPACITY = 1000;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final File POISON = new File(&quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final IndexerThread consumer = new IndexerThread();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final CrawlerThread producer = new CrawlerThread();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final BlockingQueue&lt;File&gt; queue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final FileFilter fileFilter;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final File root;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    class CrawlerThread extends Thread {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                crawl(root);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (InterruptedException e) { /* fall through */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                while (true) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        queue.put(POISON);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (InterruptedException e1) { /* retry */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private void crawl(File root) throws InterruptedException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            File[] entries = root.listFiles(fileFilter);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (entries != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (File entry : entries) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (entry.isDirectory())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        crawl(entry);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    else if (!alreadyIndexed(entry))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        queue.put(entry);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    class IndexerThread extends Thread {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                while (true) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    File file = queue.take();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (file == POISON)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    else</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        indexFile(file);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (InterruptedException consumed) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void indexFile(File file) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            /*...*/</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void start() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void stop() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.interrupt();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void awaitTermination() throws InterruptedException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.join();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div></div></details><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>æ³¨æ„äº‹é¡¹</h5></div><div class="admonition-content"><ul><li>â€œæ¯’ä¸¸â€å¯¹äºé€‚ç”¨äº1:Næˆ–N:1çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æœåŠ¡ï¼Œå¤šå¯¹å¤šçš„åœºæ™¯å°†éš¾ä»¥ä½¿ç”¨</li><li>åªæœ‰åœ¨æ— ç•Œé˜Ÿåˆ—ä¸­ï¼Œâ€œæ¯’ä¸¸â€å¯¹è±¡æ‰èƒ½å¯é å·¥ä½œ</li></ul></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ç¤ºä¾‹åªæ‰§è¡Œä¸€æ¬¡çš„æœåŠ¡"></a>ç¤ºä¾‹ï¼šåªæ‰§è¡Œä¸€æ¬¡çš„æœåŠ¡<a class="hash-link" href="#ç¤ºä¾‹åªæ‰§è¡Œä¸€æ¬¡çš„æœåŠ¡" title="Direct link to heading">#</a></h3><p>å¦‚æœæŸä¸ªæ–¹æ³•éœ€è¦å¤„ç†ä¸€æ‰¹ä»»åŠ¡ï¼Œå¹¶ä¸”å½“æ‰€æœ‰ä»»åŠ¡å®Œæˆåæ‰è¿”å›ï¼Œæ­¤æ—¶é€šè¿‡ä¸€ä¸ªç»Ÿä¸€çš„Exectuoræ¥ç®€åŒ–æœåŠ¡å‘¨æœŸç®¡ç†ã€‚å¦‚ä¸‹æ‰€ç¤ºä»£ç ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class CheckForMail {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean checkMail(Set&lt;String&gt; hosts, long timeout, TimeUnit unit)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throws InterruptedException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ExecutorService exec = Executors.newCachedThreadPool();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final AtomicBoolean hasNewMail = new AtomicBoolean(false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (final String host : hosts)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                exec.execute(new Runnable() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (checkMail(host))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            hasNewMail.set(true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exec.shutdown();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exec.awaitTermination(timeout, unit);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return hasNewMail.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="shutdownnowçš„å±€é™æ€§"></a>shutdownNowçš„å±€é™æ€§<a class="hash-link" href="#shutdownnowçš„å±€é™æ€§" title="Direct link to heading">#</a></h3><p>shutdownNowæ–¹æ³•å°è¯•å–æ¶ˆæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶è¿”å›æ‰€æœ‰å·²æäº¤ä½†æœªæ‰§è¡Œçš„ä»»åŠ¡ï¼Œä½†æ˜¯å®ƒå¹¶ä¸èƒ½è¿”å›å…³é—­æ—¶æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ã€‚å¦‚ä¸‹TrackingExecutorç±»ç»™å‡ºäº†å¦‚ä½•åœ¨å…³é—­æ—¶åˆ¤æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class TrackingExecutor extends AbstractExecutorService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ExecutorService exec;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Set&lt;Runnable&gt; tasksCancelledAtShutdown =</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Collections.synchronizedSet(new HashSet&lt;Runnable&gt;());</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public TrackingExecutor(ExecutorService exec) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.exec = exec;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ... å…¶ä»–æ–¹æ³•å§”æ‰˜ç»™exec</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;Runnable&gt; getCancelledTasks() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!exec.isTerminated())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalStateException(/*...*/);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ArrayList&lt;Runnable&gt;(tasksCancelledAtShutdown);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void execute(final Runnable runnable) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exec.execute(new Runnable() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    runnable.run();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (isShutdown()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &amp;&amp; Thread.currentThread().isInterrupted())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        tasksCancelledAtShutdown.add(runnable);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>åœ¨ä½¿ç”¨TrackingExecutorç±»æ—¶è¦æ³¨æ„æ½œåœ¨çš„è¯¯æŠ¥é—®é¢˜ï¼šä»»åŠ¡æ‰§è¡Œå®Œæœ€åä¸€æ¡æŒ‡ä»¤å’Œçº¿ç¨‹æ± å°†å…¶æ ‡è®°ä¸ºâ€œç»“æŸâ€ä¹‹é—´å…³é—­çº¿ç¨‹æ± æ—¶ï¼Œè¢«è®¤ä¸ºå–æ¶ˆçš„ä»»åŠ¡å®é™…ä¸Šå·²ç»å®Œæˆã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="å¤„ç†éæ­£å¸¸çš„çº¿ç¨‹ç»ˆæ­¢"></a>å¤„ç†éæ­£å¸¸çš„çº¿ç¨‹ç»ˆæ­¢<a class="hash-link" href="#å¤„ç†éæ­£å¸¸çš„çº¿ç¨‹ç»ˆæ­¢" title="Direct link to heading">#</a></h2><p>å¹¶å‘ç¨‹åºçš„æŸä¸ªçº¿ç¨‹å‘ç”Ÿæ•…éšœï¼Œå¼‚å¸¸æŠ¥é”™ä¸æ˜“å‘ç°ï¼Œç¨‹åºå¯èƒ½çœ‹èµ·æ¥ä¾ç„¶åœ¨å·¥ä½œã€‚å¯¼è‡´çº¿ç¨‹æå‰æ­»äº¡çš„æœ€ä¸»è¦å› ç´ æ˜¯RuntimeExceptionï¼Œè¿™äº›å¼‚å¸¸é€šå¸¸ä¸ä¼šè¢«æ•è·ï¼Œä¹Ÿä¸ä¼šåœ¨è°ƒç”¨æ ˆä¸­é€å±‚ä¼ é€’ã€‚åœ¨ä½¿ç”¨RunnableæŠ½è±¡è°ƒç”¨ä»£ç æ—¶ï¼Œå¯ä»¥ä½¿ç”¨try-catchæ¥æ•è·å¼‚å¸¸ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Throwable thrown = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        while(!isInterrupted()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            runTask(getTaskFromWorkQueue());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }catch(Throwable e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            thrown = e;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            threadExited(this, thrown);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>é™¤äº†ä¸»åŠ¨åœ°ä½¿ç”¨try-cathchæ¥æ•è·ä¸ºæ£€æŸ¥å¼‚å¸¸ï¼ŒThread APIä¹Ÿæä¾›äº†UncaughtExceptionHandleræ¥å¤„ç†æœªæ•è·å¼‚å¸¸ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œå¤„ç†æœªæ•è·å¼‚å¸¸çš„æ–¹å¼æ˜¯æ‰“å°åˆ°æ—¥å¿—ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class UEHLogger implements Thread.UncaughtExceptionHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void uncaughtException(Thread t, Throwable e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Logger logger = Logger.getAnonymousLogger();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.log(Level.SEVERE, &quot;Thread terminated with exception: &quot; + t.getName(), e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>åœ¨ThreadPoolExecutorçš„æ„é€ å‡½æ•°ä¸­æä¾›ä¸€ä¸ªThreadFactoryï¼Œå°±å¯ä»¥ä¸ºçº¿ç¨‹æ± çš„æ‰€æœ‰çº¿ç¨‹è®¾ç½®ä¸€ä¸ªUncaughtExceptionHandlerã€‚å¦‚æœéœ€è¦åœ¨ä»»åŠ¡å› å¼‚å¸¸è€Œå¤±è´¥æ—¶æ‰§è¡Œç‰¹å®šæ“ä½œï¼Œå¯ä»¥å°†ä»»åŠ¡å°è£…åœ¨èƒ½æ•è·å¼‚å¸¸çš„Runnableæˆ–Callableä¸­ï¼Œæˆ–è€…æ”¹å†™ThreadPoolExecutorçš„afterExecuteæ–¹æ³•ã€‚</p><div class="admonition admonition-danger alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>å°å¿ƒ</h5></div><div class="admonition-content"><p>åªæœ‰é€šè¿‡executræäº¤çš„ä»»åŠ¡ï¼Œæ‰èƒ½å°†å®ƒæŠ›å‡ºçš„å¼‚å¸¸äº¤ç»™æœªæ•è·å¼‚å¸¸å¤„ç†å™¨ï¼Œè€Œé€šè¿‡submitæäº¤çš„ä»»åŠ¡ï¼Œæ— è®ºæŠ›å‡ºå¼‚å¸¸æ˜¯å¦æ£€æŸ¥ï¼Œä¼šè¢«Future.getå°è£…åœ¨ExecutionExceptionä¸­é‡æ–°æŠ›å‡ºã€‚</p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="jvmå…³é—­"></a>JVMå…³é—­<a class="hash-link" href="#jvmå…³é—­" title="Direct link to heading">#</a></h2><p>JVMå…³é—­çš„æ–¹å¼åŒ…æ‹¬ï¼šæœ€åä¸€ä¸ªéå®ˆæŠ¤çº¿ç¨‹ç»“æŸã€è°ƒç”¨System.exit()ã€å‘é€SIGINTä¿¡å·æˆ–è€…Ctrl-Cï¼Œä¹Ÿå¯ä»¥é€šè¿‡Runtime.haltæˆ–è€…å‘é€SIGKILLæ¥å¼ºè¡Œå…³é—­JVMã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="å…³é—­é’©å­"></a>å…³é—­é’©å­<a class="hash-link" href="#å…³é—­é’©å­" title="Direct link to heading">#</a></h3><p>åœ¨æ­£å¸¸å…³é—­ä¸­ï¼ŒJVMé¦–å…ˆæ‰§è¡Œæ‰€æœ‰æ³¨å†Œçš„å…³é—­é’©å­(Shutdown Hook)ã€‚å…³é—­é’©å­æŒ‡é€šè¿‡Runtime.addShutdownHookæ³¨å†Œä½†<strong>æœªå¼€å§‹</strong>çš„çº¿ç¨‹ï¼ŒJVMä¸ä¿è¯å…³é—­é’©å­çš„æ‰§è¡Œé¡ºåºï¼Œå¦‚æœæœ‰çº¿ç¨‹ä»åœ¨è¿è¡Œï¼Œå…³é—­é’©å­å’Œå®ƒä»¬å¹¶å‘æ‰§è¡Œã€‚å½“å¼ºè¡Œå…³é—­æ—¶ï¼Œåªæ˜¯å…³é—­JVMè€Œä¸ä¼šè¿è¡Œå…³é—­é’©å­ã€‚</p><p>åœ¨ç¼–å†™å…³é—­é’©å­æ—¶è¦æ³¨æ„ç¡®ä¿å…¶æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸åº”è¯¥å¯¹ç¨‹åºçŠ¶æ€å’ŒJVMå…³é—­åŸå› åšå‡ºä»»ä½•å‡è®¾ã€‚æœ€åï¼Œå…³é—­é’©å­å¿…é¡»å°½å¿«é€€å‡ºï¼Œå¦åˆ™JVMé€€å‡ºæ—¶é—´å¤ªé•¿å½±å“ç”¨æˆ·ä½“éªŒã€‚å…³é—­é’©å­å¯ä»¥ç”¨äºå®ç°æœåŠ¡æˆ–åº”ç”¨çš„æ¸…ç†å·¥ä½œï¼Œä¾‹å¦‚åˆ é™¤ä¸´æ—¶æ–‡ä»¶ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="å®ˆæŠ¤çº¿ç¨‹"></a>å®ˆæŠ¤çº¿ç¨‹<a class="hash-link" href="#å®ˆæŠ¤çº¿ç¨‹" title="Direct link to heading">#</a></h3><p>çº¿ç¨‹å¯åˆ†ä¸ºæ™®é€šçº¿ç¨‹å’Œå®ˆæŠ¤çº¿ç¨‹ä¸¤ç§ï¼Œçº¿ç¨‹é€€å‡ºæ—¶JVMä¼šæ£€æŸ¥å…¶ä»–çº¿ç¨‹ï¼Œå¦‚æœåªå‰©å®ˆæŠ¤çº¿ç¨‹JVMä¼šæ­£å¸¸é€€å‡ºï¼Œè¿™äº›å®ˆæŠ¤çº¿ç¨‹éƒ½ä¼šè¢«ç›´æ¥æŠ›å¼ƒã€‚å®ˆæŠ¤çº¿ç¨‹æœ€å¥½ç”¨äºæ‰§è¡Œâ€œå†…éƒ¨â€ä»»åŠ¡ï¼Œä¾‹å¦‚å‘¨æœŸæ€§åœ°ä»å†…å­˜çš„ç¼“å­˜ä¸­ç§»é™¤é€¾æœŸçš„æ•°æ®ã€‚</p><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>æ³¨æ„</h5></div><div class="admonition-content"><p>å®ˆæŠ¤çº¿ç¨‹é€šå¸¸ä¸èƒ½ç”¨äºæ›¿ä»£ç¨‹åºæ¥ç®¡ç†æœåŠ¡çš„ç”Ÿå‘½å‘¨æœŸã€‚</p></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ç»ˆç»“å™¨"></a>ç»ˆç»“å™¨<a class="hash-link" href="#ç»ˆç»“å™¨" title="Direct link to heading">#</a></h3><p>åƒåœ¾å›æ”¶å™¨ä¼šè‡ªåŠ¨æ”¶é›†ä¸éœ€è¦çš„å†…å­˜èµ„æºï¼Œå¯¹äºç‰¹æ®Šçš„èµ„æºï¼Œå¦‚æ–‡ä»¶å¥æŸ„å’Œå¥—æ¥å­—å¥æŸ„ï¼Œè¿˜éœ€è¦æ˜¾å¼åœ°äº¤è¿˜ç»™æ“ä½œç³»ç»Ÿã€‚ä¸ºäº†å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œåƒåœ¾å›æ”¶å™¨åœ¨é‡Šæ”¾å¯¹è±¡åè¿˜ä¼šè°ƒç”¨å®ƒä»¬çš„finalizeæ–¹æ³•(ç»ˆç»“å™¨)ã€‚é€šå¸¸ä½¿ç”¨finallyå—å’Œcloseæ–¹æ³•æ¥é‡Šæ”¾è¿™äº›èµ„æºï¼Œè€Œä¸è¦ä½¿ç”¨ç»ˆç»“å™¨ï¼Œé™¤éèµ„æºæ˜¯é€šè¿‡æœ¬åœ°æ–¹æ³•è·å¾—çš„ã€‚</p><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>æ³¨æ„</h5></div><div class="admonition-content"><p>é¿å…ä½¿ç”¨ç»ˆç»“å™¨</p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="æ€»ç»“"></a>æ€»ç»“<a class="hash-link" href="#æ€»ç»“" title="Direct link to heading">#</a></h2><ul><li>Javaæä¾›åä½œå¼çš„ä¸­æ–­æœºåˆ¶æ¥å–æ¶ˆçº¿ç¨‹</li><li>åŸºäºFutureå’ŒExecutoræ¡†æ¶å¯ä»¥å¿«é€Ÿæ„å»ºå¯å–æ¶ˆçš„ä»»åŠ¡</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/docs/tags/java-concurrency">Java Concurrency</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/docs/tags/reading-notes">ReadingNotes</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/kayhaw/kayhaw.github.io/edit/master/website/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜\Java-Concurrency-in-Practice-Chap07.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap06"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« ä»»åŠ¡æ‰§è¡Œ</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap08"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">çº¿ç¨‹æ± çš„ä½¿ç”¨ Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#ä»»åŠ¡å–æ¶ˆ" class="table-of-contents__link">ä»»åŠ¡å–æ¶ˆ</a><ul><li><a href="#ä¸­æ–­" class="table-of-contents__link">ä¸­æ–­</a></li><li><a href="#ä¸­æ–­ç­–ç•¥" class="table-of-contents__link">ä¸­æ–­ç­–ç•¥</a></li><li><a href="#å“åº”ä¸­æ–­" class="table-of-contents__link">å“åº”ä¸­æ–­</a></li><li><a href="#ç¤ºä¾‹è®¡æ—¶è¿è¡Œ" class="table-of-contents__link">ç¤ºä¾‹ï¼šè®¡æ—¶è¿è¡Œ</a></li><li><a href="#é€šè¿‡futureæ¥å®ç°å–æ¶ˆ" class="table-of-contents__link">é€šè¿‡Futureæ¥å®ç°å–æ¶ˆ</a></li><li><a href="#å¤„ç†ä¸å¯ä¸­æ–­çš„é˜»å¡" class="table-of-contents__link">å¤„ç†ä¸å¯ä¸­æ–­çš„é˜»å¡</a></li><li><a href="#ç”¨newtaskforæ¥å°è£…éæ ‡å‡†çš„å–æ¶ˆ" class="table-of-contents__link">ç”¨newTaskForæ¥å°è£…éæ ‡å‡†çš„å–æ¶ˆ</a></li></ul></li><li><a href="#åœæ­¢åŸºäºçº¿ç¨‹çš„æœåŠ¡" class="table-of-contents__link">åœæ­¢åŸºäºçº¿ç¨‹çš„æœåŠ¡</a><ul><li><a href="#ç¤ºä¾‹æ—¥å¿—æœåŠ¡" class="table-of-contents__link">ç¤ºä¾‹ï¼šæ—¥å¿—æœåŠ¡</a></li><li><a href="#å…³é—­executorservice" class="table-of-contents__link">å…³é—­ExecutorService</a></li><li><a href="#æ¯’ä¸¸å¯¹è±¡" class="table-of-contents__link">â€œæ¯’ä¸¸â€å¯¹è±¡</a></li><li><a href="#ç¤ºä¾‹åªæ‰§è¡Œä¸€æ¬¡çš„æœåŠ¡" class="table-of-contents__link">ç¤ºä¾‹ï¼šåªæ‰§è¡Œä¸€æ¬¡çš„æœåŠ¡</a></li><li><a href="#shutdownnowçš„å±€é™æ€§" class="table-of-contents__link">shutdownNowçš„å±€é™æ€§</a></li></ul></li><li><a href="#å¤„ç†éæ­£å¸¸çš„çº¿ç¨‹ç»ˆæ­¢" class="table-of-contents__link">å¤„ç†éæ­£å¸¸çš„çº¿ç¨‹ç»ˆæ­¢</a></li><li><a href="#jvmå…³é—­" class="table-of-contents__link">JVMå…³é—­</a><ul><li><a href="#å…³é—­é’©å­" class="table-of-contents__link">å…³é—­é’©å­</a></li><li><a href="#å®ˆæŠ¤çº¿ç¨‹" class="table-of-contents__link">å®ˆæŠ¤çº¿ç¨‹</a></li><li><a href="#ç»ˆç»“å™¨" class="table-of-contents__link">ç»ˆç»“å™¨</a></li></ul></li><li><a href="#æ€»ç»“" class="table-of-contents__link">æ€»ç»“</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">è¯»ä¹¦ç¬”è®°</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://www.zhihu.com/people/xiao-ke-dou-7" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>çŸ¥ä¹<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/kayhaw" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://gitee.com/kayhaw" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 ä½•è½²(Kay Haw). Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.7b33080d.js"></script>
<script src="/assets/js/main.9bda434a.js"></script>
</body>
</html>