<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Kay Haw&#39;s Blog Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Kay Haw&#39;s Blog Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"><title data-react-helmet="true">ä»»åŠ¡æ‰§è¡Œ | Kay Haw&#x27;s Blog</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://kayhaw.github.io/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap06"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="ä»»åŠ¡æ‰§è¡Œ | Kay Haw&#x27;s Blog"><meta data-react-helmet="true" name="description" content="ã€ŠJavaå¹¶å‘ç¼–ç¨‹ã€‹ç¬¬å…­ç« è¯»ä¹¦ç¬”è®°"><meta data-react-helmet="true" property="og:description" content="ã€ŠJavaå¹¶å‘ç¼–ç¨‹ã€‹ç¬¬å…­ç« è¯»ä¹¦ç¬”è®°"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://kayhaw.github.io/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap06"><link data-react-helmet="true" rel="alternate" href="https://kayhaw.github.io/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap06" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://kayhaw.github.io/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap06" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.0138175c.css">
<link rel="preload" href="/assets/js/runtime~main.7b33080d.js" as="script">
<link rel="preload" href="/assets/js/main.9bda434a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Kay Haw&#x27;s Blog" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Kay Haw&#x27;s Blog" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Kay Haw&#x27;s Blog</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro">è¯»ä¹¦ç¬”è®°</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/kayhaw" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ğŸŒ</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/intro">è¯»ä¹¦ç¬”è®°</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">C++PrimerPlus</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">EffectiveC++</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Learning Akka</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Stream Processing with Apache Flink</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap02">çº¿ç¨‹å®‰å…¨æ€§</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap03">å¯¹è±¡çš„å…±äº«</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap04">å¯¹è±¡çš„ç»„åˆ</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap05">åŸºç¡€æ„å»ºæ¨¡å—</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap06">ä»»åŠ¡æ‰§è¡Œ</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap07">å–æ¶ˆä¸å…³é—­</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap08">çº¿ç¨‹æ± çš„ä½¿ç”¨</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap10">é¿å…æ´»è·ƒæ€§å±é™©</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap13">æ˜¾å¼é”</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap14">æ„å»ºè‡ªå®šä¹‰çš„åŒæ­¥å·¥å…·</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap15">åŸå­å˜é‡ä¸éé˜»å¡åŒæ­¥æœºåˆ¶</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap16">Javaå†…å­˜æ¨¡å‹</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">é«˜æ€§èƒ½MySQL</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>ä»»åŠ¡æ‰§è¡Œ</h1></header><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>ã€ŠJavaå¹¶å‘ç¼–ç¨‹ã€‹ç¬¬å…­ç« è¯»ä¹¦ç¬”è®°</p></div></div><p>å¹¶å‘åº”ç”¨ç¨‹åºå›´ç»•â€œä»»åŠ¡æ‰§è¡Œâ€æ¥æ„é€ ï¼Œä»»åŠ¡æ˜¯æŠ½è±¡ä¸”<strong>ç¦»æ•£</strong>çš„å·¥ä½œå•å…ƒã€‚æŠŠåº”ç”¨ç¨‹åºåˆ†è§£ä¸ºå¤šä¸ªä»»åŠ¡ï¼Œå¯ä»¥<strong>ç®€åŒ–ç»“æ„ï¼Œæä¾›äº‹åŠ¡è¾¹ç•Œæ¥ä¼˜åŒ–é”™è¯¯æ¢å¤ä»¥åŠæä¾›ä¸€ç§è‡ªç„¶çš„å¹¶è¡Œç»“æ„æ¥æå‡å¹¶å‘æ€§</strong>ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="åœ¨çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡"></a>åœ¨çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡<a class="hash-link" href="#åœ¨çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡" title="Direct link to heading">#</a></h2><p>é¦–å…ˆéœ€è¦ç¡®å®šä»»åŠ¡è¾¹ç•Œï¼Œç†æƒ³æƒ…å†µä¸‹å„ä¸ªä»»åŠ¡ä¹‹é—´æ˜¯ç‹¬ç«‹çš„ï¼šä¸ä¾èµ–å…¶å®ƒä»»åŠ¡çŠ¶æ€ã€ç»“æœæˆ–è€…è¾¹ç•Œæ•ˆåº”ã€‚å¤§å¤šæ•°æœåŠ¡å™¨ä»¥ç‹¬ç«‹çš„å®¢æˆ·è¯·æ±‚ä¸ºè¾¹ç•Œã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ä¸²è¡Œåœ°æ‰§è¡Œä»»åŠ¡"></a>ä¸²è¡Œåœ°æ‰§è¡Œä»»åŠ¡<a class="hash-link" href="#ä¸²è¡Œåœ°æ‰§è¡Œä»»åŠ¡" title="Direct link to heading">#</a></h3><p>ä¸€ç§ç®€å•çš„webæœåŠ¡å™¨å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼Œå®ƒç®€å•åœ°åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¤„ç†è¯·æ±‚ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class SingleThreadWebServer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ServerSocket socket = new ServerSocket(80);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (true) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Socket connection = socket.accept();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleRequest(connection);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static void handleRequest(Socket connection) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // request-handling logic here</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>è¿™æ„å‘³ç€æ‰€æœ‰è¯·æ±‚éƒ½æ˜¯ä¸²è¡Œåœ°è¢«æ‰§è¡Œï¼Œå½“å¤„ç†è¯·æ±‚åŠ¨ä½œåŒ…å«IOæ—¶(å®æ—¶ä¸Šç»å¤§å¤šæ•°è¯·æ±‚éƒ½æ˜¯)ï¼ŒCPUå°†å¤„äºç©ºé—²çŠ¶æ€ï¼Œå¤§å¤§é™ä½äº†æœåŠ¡å™¨èµ„æºåˆ©ç”¨ç‡ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="æ˜¾ç¤ºåœ°ä¸ºä»»åŠ¡åˆ›å»ºçº¿ç¨‹"></a>æ˜¾ç¤ºåœ°ä¸ºä»»åŠ¡åˆ›å»ºçº¿ç¨‹<a class="hash-link" href="#æ˜¾ç¤ºåœ°ä¸ºä»»åŠ¡åˆ›å»ºçº¿ç¨‹" title="Direct link to heading">#</a></h3><p>å¦‚ä¸‹ä»£ç é€šè¿‡ä¸ºæ¯ä¸ªä»»åŠ¡åˆ›å»ºçº¿ç¨‹ï¼Œä»è€Œå®ç°æ›´é«˜çš„å“åº”æ€§ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class ThreadPerTaskWebServer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ServerSocket socket = new ServerSocket(80);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (true) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final Socket connection = socket.accept();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Runnable task = new Runnable() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    handleRequest(connection);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            new Thread(task).start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static void handleRequest(Socket connection) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // request-handling logic here</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿™ç§æ–¹å¼èƒ½æå‡ä¸²è¡Œæ‰§è¡Œçš„æ€§èƒ½ï¼Œä½†é—®é¢˜åœ¨äºå®ƒæ²¡æœ‰é™åˆ¶å¯åˆ›å»ºçº¿ç¨‹çš„æ•°é‡ï¼Œè¯·æ±‚é€Ÿç‡è¿‡é«˜æ—¶ä¼šå‡ºç°å¦‚ä¸‹é—®é¢˜ï¼š</p><ol><li>çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸçš„å¼€é”€éå¸¸é«˜</li><li>èµ„æºæ¶ˆè€—ï¼šæ´»è·ƒçº¿ç¨‹æ¶ˆè€—å†…å­˜ï¼Œç©ºé—²çº¿ç¨‹å ç”¨å†…å­˜ï¼Œæ­¤æ—¶å†åˆ›å»ºçº¿ç¨‹åè€Œé™ä½æ€§èƒ½</li><li>ç¨³å®šæ€§ï¼šå¯åˆ›å»ºçº¿ç¨‹å—JVMå’Œåº•å±‚æ“ä½œç³»ç»Ÿé™åˆ¶ï¼Œç ´åé™åˆ¶ä¼šå¯¼è‡´OOMå¼‚å¸¸</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="executoræ¡†æ¶"></a>Executoræ¡†æ¶<a class="hash-link" href="#executoræ¡†æ¶" title="Direct link to heading">#</a></h2><p>JUCæä¾›Executoræ¡†æ¶ä½œä¸ºçº¿ç¨‹æ± å®ç°ï¼Œç®€åŒ–äº†çº¿ç¨‹çš„ç®¡ç†ï¼Œä»»åŠ¡è¢«æŠ½è±¡ä¸ºExectorè€Œä¸æ˜¯Threadã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public interface Executor{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void execute(Runnable command);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Executoræ¥å£åªæœ‰ä¸€ä¸ªexecuteæ–¹æ³•ï¼Œä½†æ˜¯å…¶å­æ¥å£å’Œå®ç°ç±»è¿˜æä¾›äº†ç”Ÿå‘½å‘¨æœŸæ”¯æŒã€ç»Ÿè®¡ä¿¡æ¯æ”¶é›†å’Œæ€§èƒ½ç›‘è§†ç­‰æœºåˆ¶ã€‚Executoræ¡†æ¶åŸºäºç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼Œæä¾›ä»»åŠ¡çš„çº¿ç¨‹ç›¸å½“äºç”Ÿäº§è€…ï¼Œæ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ç›¸å½“äºæ¶ˆè´¹è€…ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ç¤ºä¾‹åŸºäºexecutorçš„webæœåŠ¡å™¨"></a>ç¤ºä¾‹ï¼šåŸºäºExecutorçš„WebæœåŠ¡å™¨<a class="hash-link" href="#ç¤ºä¾‹åŸºäºexecutorçš„webæœåŠ¡å™¨" title="Direct link to heading">#</a></h3><p>ä½¿ç”¨Executoræ¥æ”¹å†™ä¸Šè¿°æœåŠ¡å™¨ç¨‹åºä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼Œè¿™é‡Œä½¿ç”¨ä¸€ç§æ ‡å‡†Executorå®ç°ï¼Œå³å›ºå®šé•¿åº¦çš„çº¿ç¨‹æ± ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class TaskExecutionWebServer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final int NTHREADS = 100;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Executor exec</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            = Executors.newFixedThreadPool(NTHREADS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ServerSocket socket = new ServerSocket(80);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (true) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final Socket connection = socket.accept();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Runnable task = new Runnable() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    handleRequest(connection);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exec.execute(task);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static void handleRequest(Socket connection) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // request-handling logic here</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>é€šè¿‡Executoræ¥å£è¿˜å¯ä»¥å®ç°å‰ä¸¤ç§çº¿ç¨‹åˆ›å»ºæ¨¡å¼ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class ThreadPerTaskExecutor implements Executor {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void execute(Runnable r) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        new Thread(r).start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class WithinThreadExecutor implements Executor {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void execute(Runnable r) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        r.run();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="æ‰§è¡Œç­–ç•¥"></a>æ‰§è¡Œç­–ç•¥<a class="hash-link" href="#æ‰§è¡Œç­–ç•¥" title="Direct link to heading">#</a></h3><p>Executoræ¡†æ¶å°†ä»»åŠ¡çš„æäº¤ä¸æ‰§è¡Œè§£è€¦ï¼Œè°ƒç”¨executeæ–¹æ³•åªæ˜¯ä»»åŠ¡æäº¤ï¼Œå®é™…æ‰§è¡Œç­–ç•¥ç”±Exectuorç¡®å®šã€‚æ‰§è¡Œç­–ç•¥åŒ…å«å¦‚ä¸‹æ–¹é¢ï¼š</p><ul><li>åœ¨ä»€ä¹ˆçº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Ÿ</li><li>ä»»åŠ¡æŒ‰ç…§ä»€ä¹ˆé¡ºåºæ‰§è¡Œ(FIFOï¼ŒLIFOï¼Œä¼˜å…ˆçº§)ï¼Ÿ</li><li>æœ‰å¤šå°‘ä¸ªä»»åŠ¡èƒ½å¹¶å‘æ‰§è¡Œï¼Ÿ</li><li>åœ¨é˜Ÿåˆ—ä¸­æœ‰å¤šå°‘ä¸ªä»»åŠ¡åœ¨ç­‰å¾…æ‰§è¡Œï¼Ÿ</li><li>å¦‚æœå› ä¸ºç³»ç»Ÿè¿‡è½½åº”è¯¥æ‹’ç»å“ªä¸ªä»»åŠ¡çš„æ‰§è¡Œï¼Ÿå¦‚ä½•é€šçŸ¥åº”ç”¨ç¨‹åºä»»åŠ¡è¢«æ‹’ç»ï¼Ÿ</li><li>åœ¨æ‰§è¡Œä»»åŠ¡å‰ååº”è¯¥æ‰§è¡Œå“ªäº›åŠ¨ä½œï¼Ÿ</li></ul><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>çº¿ç¨‹æ± å—…è§‰</h5></div><div class="admonition-content"><p>æ¯å½“çœ‹åˆ°ç±»ä¼¼<code>new Thread(runnable).start()</code>ä»£ç ï¼Œå¹¶ä¸”éœ€è¦çµæ´»æ‰§è¡Œç­–ç•¥æ—¶ï¼Œè€ƒè™‘ä½¿ç”¨Executoræ¡†æ¶</p></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="çº¿ç¨‹æ± "></a>çº¿ç¨‹æ± <a class="hash-link" href="#çº¿ç¨‹æ± " title="Direct link to heading">#</a></h3><p>çº¿ç¨‹æ± æ˜¯ç®¡ç†ä¸€ç»„åŒæ„å·¥ä½œçº¿ç¨‹çš„èµ„æºæ± ï¼ŒExecutorsæä¾›çš„é™æ€å·¥å‚æ–¹æ³•åˆ›å»ºæ‰§è¡Œç­–ç•¥ä¸åŒçš„çº¿ç¨‹æ± ï¼Œå…·ä½“æœ‰ï¼š</p><ol><li>newFixedThreadPoolï¼šå›ºå®šé•¿åº¦çš„çº¿ç¨‹æ± </li><li>newCachedThreadPoolï¼šçº¿ç¨‹æ± è§„æ¨¡è¶…è¿‡å¤„ç†éœ€æ±‚æ—¶å›æ”¶ç©ºé—²çº¿ç¨‹ï¼Œè¿˜ä¸å¤Ÿå†æ‰©å±•æ–°çº¿ç¨‹ï¼Œä¸é™åˆ¶çº¿ç¨‹ä¸ªæ•°</li><li>newSingleThreadPoolï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œç¡®ä¿æŒ‰ç…§æŸç§é¡ºåº(FIFOã€LIFOã€ä¼˜å…ˆçº§)<strong>ä¸²è¡Œ</strong>æ‰§è¡Œ</li><li>newScheduledThreadPoolï¼šå›ºå®šé•¿åº¦çº¿ç¨‹æ± ï¼Œä»¥å»¶è¿Ÿæˆ–è€…å®šæ—¶çš„æ–¹å¼æ‰§è¡Œä»»åŠ¡</li></ol><p>é™¤äº†å®ç°ä¸åŒçš„æ‰§è¡Œç­–ç•¥å¤–ï¼Œ<strong>çº¿ç¨‹æ± è¿˜æä¾›è°ƒç”¨ã€ç®¡ç†ã€ç›‘è§†ã€æ—¥å¿—ã€é”™è¯¯æŠ¥å‘Š</strong>ç­‰å…¶ä»–åŠŸèƒ½ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="executorçš„ç”Ÿå‘½å‘¨æœŸ"></a>Executorçš„ç”Ÿå‘½å‘¨æœŸ<a class="hash-link" href="#executorçš„ç”Ÿå‘½å‘¨æœŸ" title="Direct link to heading">#</a></h3><p>Executorçš„å®ç°ä¼šåˆ›å»ºçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œè€ŒJVMåªæœ‰åœ¨æ‰€æœ‰éå®ˆæŠ¤çº¿ç¨‹ç»“æŸåæ‰é€€å‡ºï¼Œå› æ­¤è¿˜éœ€è¦æä¾›å…³é—­æ–¹æ³•æ¥ç»“æŸExecutorã€‚ä¸ºäº†è§£å†³æ‰§è¡Œä»»åŠ¡çš„ç”Ÿå‘½å‘¨æœŸé—®é¢˜ï¼ŒExecutorServiceæ¥å£æ‰©å±•äº†Executoræ¥å£ï¼Œæä¾›äº†å¦‚ä¸‹æ–¹æ³•ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public interface ExecutorService extends Executor {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void shutdown();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;Runnable&gt; shutdownNow();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean isShutdown();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean isTerminated();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean awaitTermination(long timeout, TimeUnit unit);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ... // ç”¨äºä»»åŠ¡æäº¤çš„æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ExecutorServiceç”Ÿå‘½å‘¨æœŸæœ‰3ç§ï¼šè¿è¡Œã€å…³é—­å’Œå·²ç»ˆæ­¢ã€‚shutdownæ–¹æ³•æ‰§è¡Œæ¸©å’Œçš„å…³é—­ç­–ç•¥ï¼šä¸å†æ¥æ”¶æ–°ä»»åŠ¡ï¼Œç­‰å¾…æ‰€æœ‰ä»»åŠ¡(è¿è¡Œã€æœªè¿è¡Œ)æ‰§è¡Œå®Œæˆã€‚shutdownNowæ–¹æ³•æ‰§è¡Œæ¿€è¿›çš„å…³é—­ç­–ç•¥ï¼šå°è¯•å–æ¶ˆæ‰€æœ‰è¿è¡Œä¸­ä»»åŠ¡ï¼Œä¸å†å¯åŠ¨æœªæ‰§è¡Œä»»åŠ¡ã€‚ExecutorServiceå…³é—­åï¼Œæäº¤ä»»åŠ¡ç”±æ‹’ç»æ‰§è¡Œå¤„ç†å™¨å¤„ç†ï¼Œå®ƒä¼šæŠ›å¼ƒä»»åŠ¡ï¼Œæˆ–è€…ä½¿executeæ–¹æ³•æŠ›å‡ºæœªæ£€æŸ¥çš„RejectedExecutionExceptionå¼‚å¸¸ã€‚ç­‰æ‰€æœ‰ä»»åŠ¡ç»“æŸåï¼ŒExecutorServiceè¿›å…¥ç»ˆæ­¢çŠ¶æ€ã€‚å¦‚ä¸‹ä»£ç æ‰€ç¤ºæ˜¯åŠ å…¥å£°æ˜å‘¨æœŸç®¡ç†çš„WebæœåŠ¡å™¨ï¼Œå¯ä»¥é€šè¿‡ç›´æ¥è°ƒç”¨stopæ–¹æ³•æˆ–è€…å‘é€ç»ˆæ­¢è¯·æ±‚æ¥å…³é—­WebæœåŠ¡ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class LifecycleWebServer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ExecutorService exec = Executors.newCachedThreadPool();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void start() throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ServerSocket socket = new ServerSocket(80);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (!exec.isShutdown()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                final Socket conn = socket.accept();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                exec.execute(new Runnable() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        handleRequest(conn);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (RejectedExecutionException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!exec.isShutdown())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    log(&quot;task submission rejected&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void stop() { exec.shutdown(); }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void handleRequest(Socket connection) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Request req = readRequest(connection);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (isShutdownRequest(req))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            stop();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        else</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            dispatchRequest(req);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="å»¶è¿Ÿä»»åŠ¡ä¸å‘¨æœŸä»»åŠ¡"></a>å»¶è¿Ÿä»»åŠ¡ä¸å‘¨æœŸä»»åŠ¡<a class="hash-link" href="#å»¶è¿Ÿä»»åŠ¡ä¸å‘¨æœŸä»»åŠ¡" title="Direct link to heading">#</a></h3><p>å°½ç®¡Javaç±»åº“æä¾›Timerç±»æ¥ç®¡ç†å»¶è¿Ÿä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡ï¼Œä½†å®ç°ç›¸åŒåŠŸèƒ½åº”è¯¥ä½¿ç”¨ScheduledThreadPoolExecutoræ¥ä»£æ›¿ã€‚Timerç±»å­˜åœ¨çš„é—®é¢˜ï¼š</p><ul><li>åŸºäºç»å¯¹æ—¶é—´ï¼Œå¯¹ç³»ç»Ÿæ—¶é’Ÿå˜åŒ–æ•æ„Ÿ</li><li>æ‰§è¡Œæ‰€æœ‰å®šæ—¶ä»»åŠ¡åªä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå¦‚æœæŸä¸ªçº¿ç¨‹æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œå°†ç ´åå…¶ä»–çº¿ç¨‹çš„å®šæ—¶å‡†ç¡®æ€§</li><li>ä¸ä¼šæ•è·æœªå—æ£€æŸ¥çš„å¼‚å¸¸</li></ul><p>ç”±äºè¿™äº›é—®é¢˜ï¼Œå¦‚ä¸‹æ‰€ç¤ºTimerä»£ç ä¼šå‡ºç°é—®é¢˜ï¼Œç¨‹åºå¹¶ä¸ä¼šåœ¨6ç§’åé€€å‡ºï¼Œè€Œæ˜¯åœ¨è¿è¡Œ1ç§’åå°±æŠ¥é”™ç»“æŸï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class OutOfTime {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Timer timer = new Timer();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        timer.schedule(new ThrowTask(), 1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SECONDS.sleep(1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        timer.schedule(new ThrowTask(), 1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SECONDS.sleep(5);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class ThrowTask extends TimerTask {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new RuntimeException();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="æ‰¾å‡ºå¯åˆ©ç”¨çš„å¹¶è¡Œæ€§"></a>æ‰¾å‡ºå¯åˆ©ç”¨çš„å¹¶è¡Œæ€§<a class="hash-link" href="#æ‰¾å‡ºå¯åˆ©ç”¨çš„å¹¶è¡Œæ€§" title="Direct link to heading">#</a></h2><p>ä½¿ç”¨Executoréœ€è¦å°†ä»»åŠ¡æŠ½è±¡ä¸ºä¸€ä¸ªRunnableï¼Œç„¶è€Œå¹¶éæ‰€æœ‰ä»»åŠ¡è¾¹ç•Œéƒ½æ˜¯æ˜¾è€Œæ˜“è§ï¼Œæœ¬èŠ‚ä»¥ä¸€ä¸ªæ¸²æŸ“é¡µé¢çš„ç¨‹åºä¸ºä¾‹å±•å¼€è®¨è®ºã€‚è¯¥ç¨‹åºçš„åŠŸèƒ½æ˜¯å°†HTMLé¡µé¢ç»˜åˆ¶åˆ°å›¾åƒç¼“å­˜ä¸­ï¼Œå‡è®¾HTMLåªåŒ…å«æ ‡ç­¾æœ¬æ–‡ã€é¢„å®šä¹‰å¤§å°çš„å›¾ç‰‡å’ŒURLã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ç¤ºä¾‹ä¸²è¡Œçš„é¡µé¢æ¸²æŸ“å™¨"></a>ç¤ºä¾‹ï¼šä¸²è¡Œçš„é¡µé¢æ¸²æŸ“å™¨<a class="hash-link" href="#ç¤ºä¾‹ä¸²è¡Œçš„é¡µé¢æ¸²æŸ“å™¨" title="Direct link to heading">#</a></h3><p>ä¸€ç§ä¸²è¡Œå¤„ç†çš„æ–¹å¼æ˜¯å…ˆç»˜åˆ¶æ–‡æœ¬å…ƒç´ ï¼ŒæœŸé—´ä¸ºå›¾ç‰‡ç•™å‡ºç©ºé—´ï¼Œå¤„ç†å®Œæ–‡æœ¬åä¸‹è½½å›¾ç‰‡å†ç»˜åˆ¶ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class SingleThreadRenderer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void renderPage(CharSequence source) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        renderText(source);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ImageData&gt; imageData = new ArrayList&lt;ImageData&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (ImageInfo imageInfo : scanForImageInfo(source))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            imageData.add(imageInfo.downloadImage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (ImageData data : imageData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            renderImage(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ä¸²è¡Œå¤„ç†çš„ç¼ºç‚¹åœ¨äºä¸‹è½½å›¾ç‰‡æ—¶éƒ½åœ¨ç­‰å¾…IOæ“ä½œå®Œæˆï¼ŒCPUå‡ ä¹æœªå·¥ä½œã€‚ä¸ºäº†è·å¾—æ›´é«˜çš„CPUåˆ©ç”¨ç‡ï¼Œåº”è¯¥å°†é—®é¢˜æ‹†åˆ†ä¸ºå¤šä¸ªç‹¬ç«‹ä»»åŠ¡å¹¶å‘æ‰§è¡Œã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="æºå¸¦ä»»åŠ¡ç»“æœcallableä¸future"></a>æºå¸¦ä»»åŠ¡ç»“æœCallableä¸Future<a class="hash-link" href="#æºå¸¦ä»»åŠ¡ç»“æœcallableä¸future" title="Direct link to heading">#</a></h3><p>ç›¸æ¯”äºRunnableè¡¨ç¤ºæ²¡æœ‰è¿”å›å€¼çš„è®¡ç®—ï¼ŒCallableæ¥å£è¡¨ç¤ºæœ‰è¿”å›å€¼å¹¶ä¸”ä¼šæŠ›å‡ºå¼‚å¸¸çš„è®¡ç®—(<strong>Callable\&lt;Void&gt;è¡¨ç¤ºæ— è¿”å›å€¼</strong>)ï¼Œè€ŒFutureè¡¨ç¤ºä¸€ä¸ªä»»åŠ¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¸¤è€…æ¥å£å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public interface Callable&lt;V&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    V call() throws Exception;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface Future&lt;V&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean cancel(boolean mayInterruptIfRunning);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean isCanceled();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean isDone();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    V get() throws InterruptException, ExecutionException, CancelationException;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    V get(long timeout, TimeUnit unit) throws InterruptException, ExecutionException, CancelationException;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>getæ–¹æ³•è¡Œä¸ºå–å†³äºä»»åŠ¡çŠ¶æ€ï¼š</p><ul><li>ä»»åŠ¡å®Œæˆï¼Œç«‹å³è¿”å›ç»“æœæˆ–è€…å¼‚å¸¸</li><li>ä»»åŠ¡æœªå®Œæˆï¼Œé˜»å¡ç›´åˆ°ä»»åŠ¡å®Œæˆ</li><li>ä»»åŠ¡æŠ›å‡ºå¼‚å¸¸ï¼Œgetå°†å¼‚å¸¸å°è£…ä¸ºExecutionExceptioné‡æ–°æŠ›å‡º</li><li>ä»»åŠ¡è¢«å–æ¶ˆï¼ŒgetæŠ›å‡ºCancelationExceptionå¼‚å¸¸</li></ul><p>ExecutorServiceæ¥å£çš„æ‰€æœ‰submitæ–¹æ³•æ¥æ”¶ä¸€ä¸ªCallable/Runnableå¹¶è¿”å›ä¸€ä¸ªFutureï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼ŒExecutorServiceä½¿ç”¨newTaskForç”ŸæˆFutureå¯¹è±¡ï¼Œé»˜è®¤æ˜¯FutureTaskå¯¹è±¡ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">// ä¸ºæŒ‡å®šè¿”å›ç»“æœçš„Runnableç”ŸæˆFutureTask</span></span><span class="token-line" style="color:#393A34"><span class="token plain">protected &lt;T&gt; RunnableFuture&lt;T&gt; newTaskFor(Runnable runnable, T value) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new FutureTask&lt;T&gt;(runnable, value);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// ä¸ºCallableç”ŸæˆFutureTask</span></span><span class="token-line" style="color:#393A34"><span class="token plain">protected &lt;T&gt; RunnableFuture&lt;T&gt; newTaskFor(Callable&lt;T&gt; callable) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new FutureTask&lt;T&gt;(callable);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// æäº¤Runnableä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public Future&lt;?&gt; submit(Runnable task) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (task == null) throw new NullPointerException();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RunnableFuture&lt;Void&gt; ftask = newTaskFor(task, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    execute(ftask);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ftask;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// æäº¤æŒ‡å®šè¿”å›å€¼çš„Runnableä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public &lt;T&gt; Future&lt;T&gt; submit(Runnable task, T result) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (task == null) throw new NullPointerException();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RunnableFuture&lt;T&gt; ftask = newTaskFor(task, result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    execute(ftask);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ftask;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// æäº¤Callableä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public &lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (task == null) throw new NullPointerException();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RunnableFuture&lt;T&gt; ftask = newTaskFor(task);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    execute(ftask);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ftask;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ç¤ºä¾‹ä½¿ç”¨futureå®ç°é¡µé¢æ¸²æŸ“å™¨"></a>ç¤ºä¾‹ï¼šä½¿ç”¨Futureå®ç°é¡µé¢æ¸²æŸ“å™¨<a class="hash-link" href="#ç¤ºä¾‹ä½¿ç”¨futureå®ç°é¡µé¢æ¸²æŸ“å™¨" title="Direct link to heading">#</a></h3><p>åŸºäºFutureå’ŒCallableï¼Œå°†æ–‡æœ¬æ¸²æŸ“å’Œå›¾ç‰‡ä¸‹è½½åˆ†ä¸ºä¸¤ä¸ªå­ä»»åŠ¡ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class FutureRenderer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ExecutorService executor = Executors.newCachedThreadPool();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void renderPage(CharSequence source) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final List&lt;ImageInfo&gt; imageInfos = scanForImageInfo(source);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Callable&lt;List&lt;ImageData&gt;&gt; task =</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                new Callable&lt;List&lt;ImageData&gt;&gt;() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    public List&lt;ImageData&gt; call() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        List&lt;ImageData&gt; result = new ArrayList&lt;ImageData&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        for (ImageInfo imageInfo : imageInfos)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            result.add(imageInfo.downloadImage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                };</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Future&lt;List&lt;ImageData&gt;&gt; future = executor.submit(task);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        renderText(source);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;ImageData&gt; imageData = future.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (ImageData data : imageData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                renderImage(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (InterruptedException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Re-assert the thread&#x27;s interrupted status</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Thread.currentThread().interrupt();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // We don&#x27;t need the result, so cancel the task too</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            future.cancel(true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (ExecutionException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw launderThrowable(e.getCause());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="åœ¨å¼‚æ„ä»»åŠ¡å¹¶è¡ŒåŒ–ä¸­å­˜åœ¨çš„å±€é™"></a>åœ¨å¼‚æ„ä»»åŠ¡å¹¶è¡ŒåŒ–ä¸­å­˜åœ¨çš„å±€é™<a class="hash-link" href="#åœ¨å¼‚æ„ä»»åŠ¡å¹¶è¡ŒåŒ–ä¸­å­˜åœ¨çš„å±€é™" title="Direct link to heading">#</a></h3><p>é€šè¿‡å¯¹å¼‚æ„ä»»åŠ¡è¿›è¡Œå¹¶è¡ŒåŒ–è·å¾—çš„æ€§èƒ½æå‡æ˜¯æœ‰é™çš„ï¼š</p><ol><li>å¼‚æ„ä»»åŠ¡ä¸èƒ½å‡åŒ€åˆ†é…ç»™çº¿ç¨‹</li><li>ä»»åŠ¡è´Ÿè½½ä¸åŒï¼Œå¯¼è‡´æå‡ä¸æ˜¾è‘—</li><li>åˆ†è§£ä»»åŠ¡éœ€è¦å¼€é”€</li></ol><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>åªæœ‰å½“<strong>å¤§é‡äº’ç›¸ç‹¬ç«‹ä¸”åŒæ„</strong>çš„ä»»åŠ¡å¯ä»¥å¹¶å‘å¤„ç†æ—¶ï¼Œæ‰èƒ½ä½“ç°å‡ºå°†ç¨‹åºè´Ÿè½½åˆ†é…åˆ°å¤šä¸ªä»»åŠ¡ä¸­å¸¦æ¥çš„æ€§èƒ½æå‡</p></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="completionserviceexecutorä¸blockingqueue"></a>CompletionService:Executorä¸BlockingQueue<a class="hash-link" href="#completionserviceexecutorä¸blockingqueue" title="Direct link to heading">#</a></h3><p>å½“å‘Executoræäº¤äº†<strong>ä¸€ç»„</strong>è®¡ç®—ä»»åŠ¡åï¼Œä¸ºäº†è·å¾—ç»“æœï¼Œä¸€ç§åšæ³•æ˜¯ä¿å­˜æ¯ä¸ªä»»åŠ¡çš„Futureï¼Œç„¶ååå¤è°ƒç”¨getæ–¹æ³•ï¼Œå°†timeoutå‚æ•°è®¾ç½®ä¸º0ï¼Œè½®è¯¢åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å®Œæˆï¼Œä¸€ç§æ›´å¥½çš„æ–¹æ¡ˆæ˜¯ç”¨CompletionServiceã€‚</p><p>CompletionServiceæ¥å£èåˆäº†Executorå’ŒBlockingQueueï¼Œæäº¤Callableä»»åŠ¡åä½¿ç”¨takeå’Œpollæ“ä½œæ¥è·å–ç»“æœï¼ŒExecutorCompletionServiceå®ç°äº†CompletionServiceã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ç¤ºä¾‹ä½¿ç”¨completionserviceå®ç°é¡µé¢æ¸²æŸ“å™¨"></a>ç¤ºä¾‹ï¼šä½¿ç”¨CompletionServiceå®ç°é¡µé¢æ¸²æŸ“å™¨<a class="hash-link" href="#ç¤ºä¾‹ä½¿ç”¨completionserviceå®ç°é¡µé¢æ¸²æŸ“å™¨" title="Direct link to heading">#</a></h3><p>é€šè¿‡CompletionServiceï¼Œä¸ºæ¯å¼ å›¾ç‰‡çš„ä¸‹è½½åˆ›å»ºä¸€ä¸ªç‹¬ç«‹ä»»åŠ¡ï¼Œä»è€Œå°†ä¹‹å‰å¤šå¼ å›¾ç‰‡çš„ä¸²è¡Œä¸‹è½½æ”¹ä¸ºå¹¶è¡Œçš„ã€‚ä¹‹åï¼Œä½¿ç”¨takeæ–¹æ³•è®©æ¯å¼ å›¾ç‰‡åœ¨ä¸‹è½½å®Œæ¯•åç«‹å³èƒ½å¤Ÿæ¸²æŸ“å‡ºæ¥ï¼Œè¿›ä¸€æ­¥å‡å°‘äº†å“åº”æ—¶é—´ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class Renderer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ExecutorService executor;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Renderer(ExecutorService executor) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.executor = executor;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void renderPage(CharSequence source) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final List&lt;ImageInfo&gt; info = scanForImageInfo(source);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        CompletionService&lt;ImageData&gt; completionService =</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                new ExecutorCompletionService&lt;ImageData&gt;(executor);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (final ImageInfo imageInfo : info)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            completionService.submit(new Callable&lt;ImageData&gt;() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                public ImageData call() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return imageInfo.downloadImage();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        renderText(source);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (int t = 0, n = info.size(); t &lt; n; t++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Future&lt;ImageData&gt; f = completionService.take();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ImageData imageData = f.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                renderImage(imageData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (InterruptedException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Thread.currentThread().interrupt();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (ExecutionException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw launderThrowable(e.getCause());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>æ­¤å¤–ï¼Œå¤šä¸ªExecutorCompletionServiceå¯ä»¥å…±äº«ä¸€ä¸ªExecutorï¼Œå› æ­¤å¯ä»¥åˆ›å»ºä¸€ä¸ªå¯¹ç‰¹å®šè®¡ç®—ç§æœ‰ï¼Œåˆèƒ½å…±äº«ä¸€ä¸ªåŠŸèƒ½Executorçš„ExecutorCompletionServiceã€‚æ­¤æ—¶ExecutorCompletionServiceç›¸å½“äºä¸€ç»„è®¡ç®—çš„å¥æŸ„ï¼Œå¯ä»¥é€šè¿‡è®°å½•æäº¤ä»»åŠ¡æ•°è·å¾—å·²å®Œæˆä»»åŠ¡æ•°ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ä¸ºä»»åŠ¡è®¾ç½®æ—¶é™"></a>ä¸ºä»»åŠ¡è®¾ç½®æ—¶é™<a class="hash-link" href="#ä¸ºä»»åŠ¡è®¾ç½®æ—¶é™" title="Direct link to heading">#</a></h3><p>æœ‰äº›æ—¶å€™ä»»åŠ¡å¯èƒ½æ— æ³•å®Œæˆï¼Œæ­¤æ—¶ä¸å†éœ€è¦ç»“æœï¼Œæ¯”å¦‚ç½‘ç«™åŠ è½½å¹¿å‘Šè¿‡æ…¢å°±æ˜¾ç¤ºä¸€ä¸ªé»˜è®¤çš„ï¼Œå¯ä»¥é€šè¿‡å¸¦æœ‰æŒ‡å®šè¶…æ—¶æ—¶é—´çš„getæ–¹æ³•å®ç°ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class RenderWithTimeBudget {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Ad DEFAULT_AD = new Ad();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final long TIME_BUDGET = 1000;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ExecutorService exec = Executors.newCachedThreadPool();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Page renderPageWithAd() throws InterruptedException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        long endNanos = System.nanoTime() + TIME_BUDGET;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Future&lt;Ad&gt; f = exec.submit(new FetchAdTask());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Render the page while waiting for the ad</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Page page = renderPageBody();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Ad ad;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Only wait for the remaining time budget</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            long timeLeft = endNanos - System.nanoTime();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ad = f.get(timeLeft, NANOSECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (ExecutionException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ad = DEFAULT_AD;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (TimeoutException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ad = DEFAULT_AD;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            f.cancel(true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        page.setAd(ad);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return page;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ç¤ºä¾‹æ—…è¡Œé¢„è®¢é—¨æˆ·ç½‘ç«™"></a>ç¤ºä¾‹ï¼šæ—…è¡Œé¢„è®¢é—¨æˆ·ç½‘ç«™<a class="hash-link" href="#ç¤ºä¾‹æ—…è¡Œé¢„è®¢é—¨æˆ·ç½‘ç«™" title="Direct link to heading">#</a></h3><p>å‡è®¾æœ‰ä¸€ä¸ªæ—…è¡Œé¢„è®¢é—¨æˆ·ç½‘ç«™ï¼Œç”¨æˆ·è¾“å…¥æ—¥æœŸå’Œå…¶ä»–è¦æ±‚ï¼Œç½‘ç«™ç»™å‡ºå¤šæ¡èˆªçº¿ã€æ—…åº—ç­‰æœåŠ¡å•†çš„æŠ¥ä»·ã€‚å¯ä»¥å°†è·å–ä¸€ä¸ªå…¬å¸çš„æŠ¥ä»·è§†ä¸ºä¸€ä¸ªä»»åŠ¡ï¼Œå°†nä¸ªä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± è·å¾—nä¸ªFutureï¼Œç„¶åä½¿ç”¨é™æ—¶çš„getæ–¹æ³•ä¸²è¡Œè·å–ç»“æœã€‚è¿™ç§æ€è·¯å¾ˆç®€å•ï¼Œä½†è¿˜å¯ä»¥ä½¿ç”¨æ›´ç®€å•çš„invokeAllæ–¹æ³•ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class TimeBudget {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static ExecutorService exec = Executors.newCachedThreadPool();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;TravelQuote&gt; getRankedTravelQuotes(TravelInfo travelInfo, Set&lt;TravelCompany&gt; companies,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                   Comparator&lt;TravelQuote&gt; ranking, long time, TimeUnit unit)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throws InterruptedException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;QuoteTask&gt; tasks = new ArrayList&lt;QuoteTask&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (TravelCompany company : companies)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            tasks.add(new QuoteTask(company, travelInfo));</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Future&lt;TravelQuote&gt;&gt; futures = exec.invokeAll(tasks, time, unit);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;TravelQuote&gt; quotes =</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                new ArrayList&lt;TravelQuote&gt;(tasks.size());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Iterator&lt;QuoteTask&gt; taskIter = tasks.iterator();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Future&lt;TravelQuote&gt; f : futures) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            QuoteTask task = taskIter.next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                quotes.add(f.get());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (ExecutionException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                quotes.add(task.getFailureQuote(e.getCause()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (CancellationException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                quotes.add(task.getTimeoutQuote(e));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collections.sort(quotes, ranking);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return quotes;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>invokeAllæ¥æ”¶ä¸€ç»„ä»»åŠ¡ï¼Œå¹¶è¿”å›ä¸€ç»„Futureã€‚æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆã€è°ƒç”¨çº¿ç¨‹è¢«ä¸­æ–­ã€è¶…è¿‡æŒ‡å®šæ—¶é™æ—¶invokeAllè¿”å›ï¼Œè¶…è¿‡æ—¶é™åæ‰€æœ‰ä¸ºå®Œæˆä»»åŠ¡å°†ä¼šå–æ¶ˆï¼Œå®¢æˆ·ç«¯é€šè¿‡getæˆ–è€…isCancelledæ¥åˆ¤æ–­å…·ä½“æƒ…å†µã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="æ€»ç»“"></a>æ€»ç»“<a class="hash-link" href="#æ€»ç»“" title="Direct link to heading">#</a></h2><ul><li>å°†ç¨‹åºåˆ†è§£ä¸ºç‹¬ç«‹åŒæ„çš„å¤§é‡ä»»åŠ¡ï¼Œä½¿ç”¨å¹¶å‘æ‰èƒ½çœŸæ­£æé«˜ç¨‹åºæ€§èƒ½</li><li>åˆ†è§£ç¨‹åºçš„ç¬¬ä¸€æ­¥æ˜¯æ‰¾åˆ°ä»»åŠ¡çš„è¾¹ç•Œ</li><li>Executoræ¡†æ¶çš„æ„ä¹‰æ˜¯å°†ä»»åŠ¡æäº¤ä¸æ‰§è¡Œç­–ç•¥è§£è€¦ï¼Œå½“éœ€è¦åˆ›å»ºçº¿ç¨‹è¿è¡Œä»»åŠ¡æ—¶å¯ä»¥è€ƒè™‘Executor</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/docs/tags/java-concurrency">Java Concurrency</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/docs/tags/reading-notes">ReadingNotes</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/kayhaw/kayhaw.github.io/edit/master/website/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜\Java-Concurrency-in-Practice-Chap06.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap05"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« åŸºç¡€æ„å»ºæ¨¡å—</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap07"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">å–æ¶ˆä¸å…³é—­ Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#åœ¨çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡" class="table-of-contents__link">åœ¨çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡</a><ul><li><a href="#ä¸²è¡Œåœ°æ‰§è¡Œä»»åŠ¡" class="table-of-contents__link">ä¸²è¡Œåœ°æ‰§è¡Œä»»åŠ¡</a></li><li><a href="#æ˜¾ç¤ºåœ°ä¸ºä»»åŠ¡åˆ›å»ºçº¿ç¨‹" class="table-of-contents__link">æ˜¾ç¤ºåœ°ä¸ºä»»åŠ¡åˆ›å»ºçº¿ç¨‹</a></li></ul></li><li><a href="#executoræ¡†æ¶" class="table-of-contents__link">Executoræ¡†æ¶</a><ul><li><a href="#ç¤ºä¾‹åŸºäºexecutorçš„webæœåŠ¡å™¨" class="table-of-contents__link">ç¤ºä¾‹ï¼šåŸºäºExecutorçš„WebæœåŠ¡å™¨</a></li><li><a href="#æ‰§è¡Œç­–ç•¥" class="table-of-contents__link">æ‰§è¡Œç­–ç•¥</a></li><li><a href="#çº¿ç¨‹æ± " class="table-of-contents__link">çº¿ç¨‹æ± </a></li><li><a href="#executorçš„ç”Ÿå‘½å‘¨æœŸ" class="table-of-contents__link">Executorçš„ç”Ÿå‘½å‘¨æœŸ</a></li><li><a href="#å»¶è¿Ÿä»»åŠ¡ä¸å‘¨æœŸä»»åŠ¡" class="table-of-contents__link">å»¶è¿Ÿä»»åŠ¡ä¸å‘¨æœŸä»»åŠ¡</a></li></ul></li><li><a href="#æ‰¾å‡ºå¯åˆ©ç”¨çš„å¹¶è¡Œæ€§" class="table-of-contents__link">æ‰¾å‡ºå¯åˆ©ç”¨çš„å¹¶è¡Œæ€§</a><ul><li><a href="#ç¤ºä¾‹ä¸²è¡Œçš„é¡µé¢æ¸²æŸ“å™¨" class="table-of-contents__link">ç¤ºä¾‹ï¼šä¸²è¡Œçš„é¡µé¢æ¸²æŸ“å™¨</a></li><li><a href="#æºå¸¦ä»»åŠ¡ç»“æœcallableä¸future" class="table-of-contents__link">æºå¸¦ä»»åŠ¡ç»“æœCallableä¸Future</a></li><li><a href="#ç¤ºä¾‹ä½¿ç”¨futureå®ç°é¡µé¢æ¸²æŸ“å™¨" class="table-of-contents__link">ç¤ºä¾‹ï¼šä½¿ç”¨Futureå®ç°é¡µé¢æ¸²æŸ“å™¨</a></li><li><a href="#åœ¨å¼‚æ„ä»»åŠ¡å¹¶è¡ŒåŒ–ä¸­å­˜åœ¨çš„å±€é™" class="table-of-contents__link">åœ¨å¼‚æ„ä»»åŠ¡å¹¶è¡ŒåŒ–ä¸­å­˜åœ¨çš„å±€é™</a></li><li><a href="#completionserviceexecutorä¸blockingqueue" class="table-of-contents__link">CompletionService:Executorä¸BlockingQueue</a></li><li><a href="#ç¤ºä¾‹ä½¿ç”¨completionserviceå®ç°é¡µé¢æ¸²æŸ“å™¨" class="table-of-contents__link">ç¤ºä¾‹ï¼šä½¿ç”¨CompletionServiceå®ç°é¡µé¢æ¸²æŸ“å™¨</a></li><li><a href="#ä¸ºä»»åŠ¡è®¾ç½®æ—¶é™" class="table-of-contents__link">ä¸ºä»»åŠ¡è®¾ç½®æ—¶é™</a></li><li><a href="#ç¤ºä¾‹æ—…è¡Œé¢„è®¢é—¨æˆ·ç½‘ç«™" class="table-of-contents__link">ç¤ºä¾‹ï¼šæ—…è¡Œé¢„è®¢é—¨æˆ·ç½‘ç«™</a></li></ul></li><li><a href="#æ€»ç»“" class="table-of-contents__link">æ€»ç»“</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">è¯»ä¹¦ç¬”è®°</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://www.zhihu.com/people/xiao-ke-dou-7" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>çŸ¥ä¹<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/kayhaw" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://gitee.com/kayhaw" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 ä½•è½²(Kay Haw). Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.7b33080d.js"></script>
<script src="/assets/js/main.9bda434a.js"></script>
</body>
</html>