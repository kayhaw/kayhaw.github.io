<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.16">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Kay Haw&#39;s Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Kay Haw&#39;s Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"><title data-rh="true">åŸå­å˜é‡ä¸éé˜»å¡åŒæ­¥æœºåˆ¶ | Kay Haw&#x27;s Blog</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://kayhaw.github.io/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap15"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="åŸå­å˜é‡ä¸éé˜»å¡åŒæ­¥æœºåˆ¶ | Kay Haw&#x27;s Blog"><meta data-rh="true" name="description" content="ã€ŠJavaå¹¶å‘ç¼–ç¨‹ã€‹ç¬¬åäº”ç« è¯»ä¹¦ç¬”è®°"><meta data-rh="true" property="og:description" content="ã€ŠJavaå¹¶å‘ç¼–ç¨‹ã€‹ç¬¬åäº”ç« è¯»ä¹¦ç¬”è®°"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kayhaw.github.io/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap15"><link data-rh="true" rel="alternate" href="https://kayhaw.github.io/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap15" hreflang="en"><link data-rh="true" rel="alternate" href="https://kayhaw.github.io/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap15" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.4bafb564.css">
<link rel="preload" href="/assets/js/runtime~main.b8f66f99.js" as="script">
<link rel="preload" href="/assets/js/main.a8d1eeac.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Kay Haw&#x27;s Blog" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="Kay Haw&#x27;s Blog" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Kay Haw&#x27;s Blog</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro">è¯»ä¹¦ç¬”è®°</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/kayhaw" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ğŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ğŸŒ</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode (currently light mode)"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">è¯»ä¹¦ç¬”è®°</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/C++PrimerPlus/C++PrimerPlus-Chap04">C++PrimerPlus</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/EffectiveC++/Effective-C++-Chap1">EffectiveC++</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap02">Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap02">çº¿ç¨‹å®‰å…¨æ€§</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap03">å¯¹è±¡çš„å…±äº«</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap04">å¯¹è±¡çš„ç»„åˆ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap05">åŸºç¡€æ„å»ºæ¨¡å—</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap06">ä»»åŠ¡æ‰§è¡Œ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap07">å–æ¶ˆä¸å…³é—­</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap08">çº¿ç¨‹æ± çš„ä½¿ç”¨</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap10">é¿å…æ´»è·ƒæ€§å±é™©</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap13">æ˜¾å¼é”</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap14">æ„å»ºè‡ªå®šä¹‰çš„åŒæ­¥å·¥å…·</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap15">åŸå­å˜é‡ä¸éé˜»å¡åŒæ­¥æœºåˆ¶</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap16">Javaå†…å­˜æ¨¡å‹</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/Learning Akka/LearningAkka-Chap01">Learning Akka</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/Stream-Processing-with-Apache-Flink/Chap01">Stream Processing with Apache Flink</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº/UnderstandJVM-Chap07">æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/é«˜æ€§èƒ½MySQL/HighPerformanceMySQL-Chap04">é«˜æ€§èƒ½MySQL</a></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/">ğŸ </a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link breadcrumbsItemLink_e5ie">Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap15">åŸå­å˜é‡ä¸éé˜»å¡åŒæ­¥æœºåˆ¶</a></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>åŸå­å˜é‡ä¸éé˜»å¡åŒæ­¥æœºåˆ¶</h1></header><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>ã€ŠJavaå¹¶å‘ç¼–ç¨‹ã€‹ç¬¬åäº”ç« è¯»ä¹¦ç¬”è®°</p></div></div><p>JUCå·¥å…·ç±»æä¾›æ¯”synchronizedæ›´å¥½çš„æ€§èƒ½å’Œå¯ä¼¸ç¼©æ€§ï¼Œæœ¬ç« ä»‹ç»æ€§èƒ½æå‡çš„æ¥æºï¼šåŸå­å˜é‡ä¸éé˜»å¡åŒæ­¥æœºåˆ¶</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="é”çš„åŠ£åŠ¿">é”çš„åŠ£åŠ¿<a class="hash-link" href="#é”çš„åŠ£åŠ¿" title="Direct link to heading">â€‹</a></h2><p>åœ¨å¹¶å‘ç¨‹åºä¸­ï¼Œæœªè·å¾—é”çš„çº¿ç¨‹éœ€è¦ç»å†æŒ‚èµ·å’Œæ¢å¤çš„è¿‡ç¨‹ï¼Œè¿™ç”±JVMå€ŸåŠ©äºæ“ä½œç³»ç»Ÿå®Œæˆã€‚å½“é”å­˜åœ¨ç«äº‰æ¿€çƒˆæ—¶ï¼Œå¤§é‡çš„CPUæ—¶é—´èŠ±è´¹åœ¨çº¿ç¨‹è°ƒåº¦ä¸Šè€Œä¸æ˜¯å®é™…å·¥ä½œã€‚é”è¿˜å­˜åœ¨<strong>ä¼˜å…ˆçº§åè½¬</strong>é—®é¢˜ï¼šæŒæœ‰é”çš„ä½ä¼˜å…ˆçº§çº¿ç¨‹è¢«å»¶è¿Ÿæ‰§è¡Œï¼Œå¯¼è‡´ç­‰å¾…é”çš„é«˜ä¼˜å…ˆçº§çº¿ç¨‹æ— æ³•ç»§ç»­æ‰§è¡Œã€‚å³ä½¿å¿½ç•¥è¿™ä¸ªé—®é¢˜ï¼Œåœ¨ç»†ç²’åº¦æ“ä½œä¸Šä½¿ç”¨é”ä¹Ÿæ˜¯ä¸€ç§é«˜å¼€é”€ï¼Œéœ€è¦ä¸€ç§ç±»ä¼¼volatileå˜é‡çš„æœºåˆ¶æ¥ç®¡ç†çº¿ç¨‹ã€‚</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="ç¡¬ä»¶å¯¹å¹¶å‘çš„æ”¯æŒ">ç¡¬ä»¶å¯¹å¹¶å‘çš„æ”¯æŒ<a class="hash-link" href="#ç¡¬ä»¶å¯¹å¹¶å‘çš„æ”¯æŒ" title="Direct link to heading">â€‹</a></h2><p>ç‹¬å é”æ˜¯ä¸€ç§æ‚²è§‚æŠ€æœ¯ï¼Œå®ƒç¡®ä¿æ²¡æœ‰å…¶ä»–çº¿ç¨‹å¹²æ‰°æ‰æ‰§è¡Œã€‚è€Œå¯¹äºç»†ç²’åº¦æ“ä½œï¼Œä½¿ç”¨å†²çªæ£€æŸ¥æœºåˆ¶çš„ä¹è§‚é”æ›´åŠ é«˜æ•ˆã€‚åœ¨ç°ä»£å¤„ç†å™¨ä¸­æä¾›äº†åŸå­çš„è¯»-æ”¹-å†™æŒ‡ä»¤ï¼Œä¾‹å¦‚æ¯”è¾ƒå¹¶äº¤æ¢(Compare-and-Swap)ã€å…³è”åŠ è½½/æ¡ä»¶å­˜å‚¨(Load-Linked/Store-Conditional)ï¼Œé€šè¿‡è¿™äº›æŒ‡ä»¤ï¼ŒJVMä»ç¡¬ä»¶ä¸Šæ¥å®ç°é”å’Œå¹¶å‘æ•°æ®ç»“æ„ã€‚</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="æ¯”è¾ƒå¹¶äº¤æ¢">æ¯”è¾ƒå¹¶äº¤æ¢<a class="hash-link" href="#æ¯”è¾ƒå¹¶äº¤æ¢" title="Direct link to heading">â€‹</a></h3><p>CASæŒ‡ä»¤åŒ…å«3ä¸ªæ“ä½œæ•°(è¯»å†™å†…å­˜ä½ç½®Vï¼Œæ—§å€¼Aå’Œæ–°å€¼B)ï¼Œå…¶è¯­ä¹‰ä¸ºï¼šå½“ä¸”ä»…å½“Vçš„å€¼ä¸ºAæ—¶å°†å…¶åŸå­æ›´æ–°ä¸ºBï¼Œå¦åˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚å¦‚ä¸‹ä»£ç é€šè¿‡å†…ç½®é”æ¨¡æ‹ŸCASæ“ä½œï¼š</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">SimulatedCAS</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">synchronized</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">synchronized</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">compareAndSwap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> expectedValue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> newValue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> oldValue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldValue </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> expectedValue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> newValue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> oldValue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">synchronized</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">compareAndSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> expectedValue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> newValue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expectedValue </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">compareAndSwap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expectedValue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newValue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>å¤šä¸ªçº¿ç¨‹æ‰§è¡ŒCASæ“ä½œåªæœ‰ä¸€ä¸ªä¼šæˆåŠŸï¼Œä½†æ˜¯å…¶ä»–çº¿ç¨‹ä¸ä¼šè¢«æŒ‚èµ·è€Œæ˜¯ç»§ç»­å°è¯•ï¼Œä»è€Œåœ¨ä¸ç”¨é”çš„æƒ…å†µä¸‹å®ç°åŸå­çš„è¯»-æ”¹-å†™æ“ä½œã€‚</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="éé˜»å¡çš„è®¡æ•°å™¨">éé˜»å¡çš„è®¡æ•°å™¨<a class="hash-link" href="#éé˜»å¡çš„è®¡æ•°å™¨" title="Direct link to heading">â€‹</a></h3><p>å¦‚ä¸‹æ‰€ç¤ºä»£ç é€šè¿‡CASæ“ä½œå®ç°ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨ã€‚å½“çº¿ç¨‹ç«äº‰ç¨‹åº¦ä¸é«˜æ—¶ï¼ŒåŸºäºCASçš„è®¡æ•°å™¨ä¼˜äºåŸºäºé”ï¼Œåœ¨æ²¡æœ‰ç«äº‰æ—¶ç”šè‡³æ›´é«˜ã€‚ä»è¡¨é¢ä»£ç çœ‹ï¼ŒCASä¼¼ä¹æ¯”å†…ç½®é”æ›´å¤æ‚ï¼Œä½†JVMç®¡ç†é”éœ€è¦éå†å¤æ‚çš„ä»£ç é€»è¾‘ï¼Œå¯èƒ½å¯¼è‡´æ“ä½œç³»ç»Ÿçº§çš„é”å®šã€çº¿ç¨‹æŒ‚èµ·å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè€ŒCASä¸éœ€è¦ã€‚CASçš„ä¸»è¦ç¼ºç‚¹æ˜¯è®©è°ƒç”¨è€…å¤„ç†ç«äº‰é—®é¢˜(é‡è¯•ã€å›é€€ã€æ”¾å¼ƒ)ï¼Œè€Œé”æœºåˆ¶ä¼šè‡ªåŠ¨å¤„ç†ã€‚</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">CasCounter</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">SimulatedCAS</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">increment</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            v </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compareAndSwap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> v </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="jvmå¯¹casçš„æ”¯æŒ">JVMå¯¹CASçš„æ”¯æŒ<a class="hash-link" href="#jvmå¯¹casçš„æ”¯æŒ" title="Direct link to heading">â€‹</a></h3><p>è‡ªJava 5.0å¼•å…¥åº•å±‚æ”¯æŒï¼Œç”±JVMç¼–è¯‘ä¸ºåº•å±‚ç¡¬ä»¶æŒ‡ä»¤ï¼Œå¦‚æœåº•å±‚å¹³å°ä¸æ”¯æŒCASå°†ä½¿ç”¨è‡ªæ—‹é”ï¼ŒJUCä¸‹çš„AtomicXxxç±»ä½¿ç”¨äº†è¿™äº›åº•å±‚æ”¯æŒã€‚</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="åŸå­å˜é‡ç±»">åŸå­å˜é‡ç±»<a class="hash-link" href="#åŸå­å˜é‡ç±»" title="Direct link to heading">â€‹</a></h2><p>åŸå­å˜é‡ç±»å°†ç«äº‰ç¼©å°åˆ°å•ä¸ªå˜é‡ä¸Šï¼ŒJUCæä¾›12ä¸ªåŸå­å˜é‡ç±»ï¼Œå¯åˆ†ä¸º4ç»„ï¼šæ ‡é‡ç±»ã€æ›´æ–°å™¨ç±»ã€æ•°ç»„ç±»ä»¥åŠå¤åˆå˜é‡ç±»ã€‚å¸¸ç”¨çš„æ˜¯æ ‡é‡ç±»(AtomicIntegerã€AtomicLongã€AtomicBooleanå’ŒAtomicReference)ï¼Œå…¶ä»–åŸºæœ¬ç±»å‹å¯ä»¥è¿›è¡Œç±»å‹è½¬åŒ–(å¦‚floatToIntBitsã€doubleToLongBits)æ¥å®ç°æ¨¡æ‹Ÿã€‚</p><p>åŸå­æ ‡é‡ç±»æ‰©å±•Numberç±»ï¼Œä½†æ˜¯æ²¡æœ‰æ‰©å±•åŸºæœ¬ç±»å‹çš„åŒ…è£…ç±»ï¼Œå®é™…ä¸Šä¹Ÿæ— æ³•æ‰©å±•ã€‚åŒæ—¶åŸå­å˜é‡ç±»æ²¡æœ‰é‡æ–°å®šä¹‰hashCodeæˆ–è€…equalsæ–¹æ³•ï¼Œå› æ­¤ä¸é€‚åˆä½œä¸ºMapå®¹å™¨çš„é”®å€¼ã€‚</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="åŸå­å˜é‡ç±»æ˜¯ä¸€ç§æ›´å¥½çš„volatile">åŸå­å˜é‡ç±»æ˜¯ä¸€ç§æ›´å¥½çš„volatile<a class="hash-link" href="#åŸå­å˜é‡ç±»æ˜¯ä¸€ç§æ›´å¥½çš„volatile" title="Direct link to heading">â€‹</a></h3><p>åœ¨ç¬¬4ç« ä¸­çš„NumberRangeç±»ä¸­ï¼Œç”±äºå­˜åœ¨ä¸‹ç•Œå°äºä¸Šç•Œçš„ä¸å˜æ€§æ¡ä»¶ï¼Œä»…ä»…ä½¿ç”¨volatileæˆ–è€…åŸå­ç±»çš„ä¸Šä¸‹ç•Œéƒ½æ˜¯æœ‰é—®é¢˜çš„ã€‚å¦‚ä¸‹æ‰€ç¤ºä»£ç é€šè¿‡åŸå­å¼•ç”¨ç±»æ›´æ–°æ¥é¿å…é™æ€æ¡ä»¶ï¼š</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">CasNumberRange</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ç§æœ‰é™æ€å†…éƒ¨ç±»</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">IntPair</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// ä¸å˜æ€§æ¡ä»¶: lower &lt;= upper</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> lower</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> upper</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">IntPair</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> lower</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> upper</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lower </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lower</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">upper </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> upper</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">AtomicReference</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">IntPair</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> values </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AtomicReference</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">IntPair</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">IntPair</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getLower</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> values</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lower</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getUpper</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> values</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">upper</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">setLower</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">IntPair</span><span class="token plain"> oldv </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> values</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> oldv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">upper</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">IllegalArgumentException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Can&#x27;t set lower to &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot; &gt; upper&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">IntPair</span><span class="token plain"> newv </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">IntPair</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> oldv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">upper</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// CASæ“ä½œå¯èƒ½å¤±è´¥ï¼Œå› æ­¤è°ƒç”¨è€…è¦ä½¿ç”¨while-trueå¾ªç¯</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">values</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compareAndSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">setUpper</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">IntPair</span><span class="token plain"> oldv </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> values</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> oldv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lower</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">IllegalArgumentException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Can&#x27;t set upper to &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot; &lt; lower&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">IntPair</span><span class="token plain"> newv </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">IntPair</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lower</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">values</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compareAndSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="æ€§èƒ½æ¯”è¾ƒé”ä¸åŸå­å˜é‡">æ€§èƒ½æ¯”è¾ƒï¼šé”ä¸åŸå­å˜é‡<a class="hash-link" href="#æ€§èƒ½æ¯”è¾ƒé”ä¸åŸå­å˜é‡" title="Direct link to heading">â€‹</a></h3><p>ä½¿ç”¨ReentrantLockã€AtomicIntegeråˆ†åˆ«å®ç°éšæœºæ•°ç”Ÿæˆå™¨ï¼Œä½¿ç”¨ä¸åŒæ•°é‡çº¿ç¨‹æµ‹è¯•ï¼Œç»“è®ºå¦‚ä¸‹ï¼š</p><ol><li>ç«äº‰ç¨‹åº¦é«˜æ—¶ï¼Œé”çš„æ€§èƒ½ç•¥ä¼˜äºåŸå­å˜é‡</li><li>ç«äº‰ç¨‹åº¦ä¸­ç­‰æ—¶ï¼ŒåŸå­å˜é‡æ€§èƒ½æ˜¯é”æ€§èƒ½2å€</li><li>ä½¿ç”¨ThreadLocalæ—¶æ€§èƒ½æœ€é«˜ï¼Œè¯´æ˜åªæœ‰å®Œå…¨æ¶ˆé™¤ç«äº‰ï¼Œæ‰èƒ½å®ç°çœŸæ­£çš„å¯ä¼¸ç¼©æ€§</li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="éé˜»å¡ç®—æ³•">éé˜»å¡ç®—æ³•<a class="hash-link" href="#éé˜»å¡ç®—æ³•" title="Direct link to heading">â€‹</a></h2><p>éé˜»å¡ç®—æ³•ï¼šä¸€ä¸ªçº¿ç¨‹çš„å¤±è´¥æˆ–æŒ‚èµ·ä¸ä¼šå¯¼è‡´å…¶ä»–çº¿ç¨‹å¤±è´¥æˆ–æŒ‚èµ·
æ— é”ç®—æ³•ï¼šç®—æ³•çš„æ¯ä¸€ä¸ªæ­¥éª¤éƒ½å­˜åœ¨æŸä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œä¸‹å»</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="éé˜»å¡çš„æ ˆ">éé˜»å¡çš„æ ˆ<a class="hash-link" href="#éé˜»å¡çš„æ ˆ" title="Direct link to heading">â€‹</a></h3><p>åœ¨å®ç°ç›¸åŒåŠŸèƒ½æƒ…å†µä¸‹ï¼Œä½¿ç”¨éé˜»å¡ç®—æ³•æ¯”åŸºäºé”çš„æ›´åŠ å¤æ‚ã€‚å¦‚ä¸‹æ‰€ç¤ºä»£ç é€šè¿‡CASå®ç°ä¸€ä¸ªéé˜»å¡çš„æ ˆï¼š</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ConcurrentStack</span><span class="token plain"> </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">AtomicReference</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> top </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AtomicReference</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">E</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> newHead </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> oldHead</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            oldHead </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> top</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            newHead</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">next </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> oldHead</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">top</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compareAndSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldHead</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newHead</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">E</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> oldHead</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> newHead</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            oldHead </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> top</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldHead </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            newHead </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> oldHead</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">next</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">top</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compareAndSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldHead</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newHead</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> oldHead</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Node</span><span class="token plain"> </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">E</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> next</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">E</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">item </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>åœ¨pushå’Œpopæ–¹æ³•ä¸­ä½¿ç”¨do-whileå’ŒCASï¼Œé˜²æ­¢åœ¨æ“ä½œè¿‡ç¨‹ä¸­å› ä¸ºæœ‰å…¶ä»–çº¿ç¨‹è¿›è¡Œå‡ºæ ˆå…¥æ ˆæ“ä½œå¯¼è‡´ä¸å˜æ€§æ¡ä»¶è¢«ç ´åã€‚</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="éé˜»å¡çš„é“¾è¡¨">éé˜»å¡çš„é“¾è¡¨<a class="hash-link" href="#éé˜»å¡çš„é“¾è¡¨" title="Direct link to heading">â€‹</a></h3><p>ç›¸æ¯”äºéé˜»å¡çš„è®¡æ•°å™¨å’Œæ ˆï¼Œå®ç°éé˜»å¡çš„é“¾è¡¨æ›´ä¸ºå¤æ‚ã€‚ä¸ºäº†å®ç°å¯¹é“¾è¡¨å¤´å°¾èŠ‚ç‚¹çš„å¿«é€Ÿè®¿é—®ï¼Œéœ€è¦å•ç‹¬æ–‡è™å¤´å°¾æŒ‡é’ˆã€‚ä»¥å°¾èŠ‚ç‚¹ä¸ºä¾‹ï¼Œå€’æ•°ç¬¬äºŒä¸ªèŠ‚ç‚¹çš„nextæŒ‡é’ˆå’Œå°¾æŒ‡é’ˆéƒ½æŒ‡å‘å®ƒã€‚å½“æ’å…¥å…ƒç´ æ—¶ï¼Œè¿™ä¸¤ä¸ªæŒ‡é’ˆéƒ½éœ€è¦é‡‡ç”¨åŸå­æ›´æ–°ã€‚</p><p>åˆçœ‹èµ·æ¥ï¼Œè¿™éœ€è¦æ‰§è¡Œä¸¤ä¸ªCASæ“ä½œï¼Œå½“è¿™ä¸¤ä¸ªCASæ“ä½œå…¶ä¸­ä¸€ä¸ªå¤±è´¥ï¼Œæˆ–è€…å®ƒä»¬æ‰§è¡Œä¹‹é—´æœ‰å¦ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼Œéƒ½ä¼šå‡ºç°é“¾è¡¨çŠ¶æ€ä¸ä¸€è‡´çš„æƒ…å†µã€‚Michael-Scottæå‡ºçš„éé˜»å¡é“¾è¡¨ç®—æ³•è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå¦‚ä¸‹ç»™å‡ºäº†é“¾è¡¨æ’å…¥å…ƒç´ çš„ä»£ç å®ç°ï¼š</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">LinkedQueue</span><span class="token plain"> </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Node</span><span class="token plain"> </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">E</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">AtomicReference</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">LinkedQueue</span><span class="token generics class-name punctuation" style="color:#393A34">.</span><span class="token generics class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> next</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">E</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">LinkedQueue</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">item </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">next </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AtomicReference</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">LinkedQueue</span><span class="token generics class-name punctuation" style="color:#393A34">.</span><span class="token generics class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">LinkedQueue</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> dummy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">LinkedQueue</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">AtomicReference</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">LinkedQueue</span><span class="token generics class-name punctuation" style="color:#393A34">.</span><span class="token generics class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> head</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AtomicReference</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">LinkedQueue</span><span class="token generics class-name punctuation" style="color:#393A34">.</span><span class="token generics class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dummy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">AtomicReference</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">LinkedQueue</span><span class="token generics class-name punctuation" style="color:#393A34">.</span><span class="token generics class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> tail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AtomicReference</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">LinkedQueue</span><span class="token generics class-name punctuation" style="color:#393A34">.</span><span class="token generics class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dummy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">E</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">LinkedQueue</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> newNode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">LinkedQueue</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">LinkedQueue</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> curTail </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tail</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">LinkedQueue</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> tailNext </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> curTail</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">next</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// è¿™ä¸ªifæ£€æŸ¥ä¹Ÿå¾ˆå…³é”®</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">curTail </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> tail</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tailNext </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// é˜Ÿåˆ—å¤„äºä¸­é—´çŠ¶æ€ï¼Œæ¨è¿›å°¾èŠ‚ç‚¹</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tail</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compareAndSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">curTail</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tailNext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// å¤„äºç¨³å®šçŠ¶æ€ï¼Œå°è¯•æ’å…¥æ–°èŠ‚ç‚¹</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">curTail</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">next</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compareAndSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newNode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">// æ’å…¥æˆåŠŸï¼Œå°è¯•æ¨è¿›å°¾èŠ‚ç‚¹</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        tail</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compareAndSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">curTail</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newNode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>è¯¥ç®—æ³•çš„åŸºæœ¬æ€è·¯æ˜¯å½“é“¾è¡¨å¤„äºä¸­é—´çŠ¶æ€(å°¾æŒ‡é’ˆçš„nextä¸ä¸ºç©º)æ—¶ï¼Œç”±å½“å‰çº¿ç¨‹å®Œæˆå°¾æŒ‡é’ˆçš„è®¾ç½®ï¼Œä½¿é“¾è¡¨æ¢å¤ä¸ºç¨³å®šçŠ¶æ€ã€‚</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="åŸå­çš„åŸŸæ›´æ–°å™¨">åŸå­çš„åŸŸæ›´æ–°å™¨<a class="hash-link" href="#åŸå­çš„åŸŸæ›´æ–°å™¨" title="Direct link to heading">â€‹</a></h3><p>åœ¨ConcurrentLinkedQueueçš„å®é™…å®ç°ä¸ä¸Šä¸€å°èŠ‚çš„LinkedQueueç•¥æœ‰åŒºåˆ«ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼Œå®ƒå¹¶æ²¡æœ‰å°†Nodeçš„nextæŒ‡é’ˆå£°æ˜ä¸ºAtomicReferenceç±»å‹è€Œæ˜¯æ™®é€šçš„volatileç±»å‹ï¼Œå¹¶ä½¿ç”¨åŸºäºåå°„çš„AtomicReferenceFieldUpdateræ¥æ›´æ–°ï¼š</p><div class="codeBlockContainer_I0IT language-java theme-code-block"><div class="codeBlockContent_wNvx java"><pre tabindex="0" class="prism-code language-java codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">E</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> valatile </span><span class="token class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">E</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> next</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">E</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">AtomicReferenceFieldUpdater</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Node</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Node</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> nextUpdater</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AtomicReferenceFieldUpdater</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>åœ¨ConcurrentLinkedQueueä¸­ï¼Œé€šè¿‡nextUpdateçš„compareAndSetæ¥æ›´æ–°nextã€‚è™½ç„¶ä»£ç ç¨å¾®ç¹çï¼Œä½†æ˜¯å®ƒå…å»äº†æ¯ä¸ªNodeçš„AtomicReferenceåˆ›å»ºè¿‡ç¨‹ï¼Œå¯¹äºé¢‘ç¹åˆ›å»ºç”Ÿå‘½å‘¨æœŸçŸ­æš‚çš„å¯¹è±¡çš„åœºæ™¯ï¼Œèƒ½å¤Ÿé™ä½æ’å…¥æ“ä½œçš„å¼€é”€ã€‚</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="abaé—®é¢˜">ABAé—®é¢˜<a class="hash-link" href="#abaé—®é¢˜" title="Direct link to heading">â€‹</a></h3><p>å¦‚æœå†…å­˜å€¼ç”±Aå˜ä¸ºBï¼Œå†ç”±Bå˜ä¸ºAï¼Œè¿™ç§æƒ…å†µåœ¨æŸäº›ç®—æ³•ä¸­ä»ç„¶è¢«è®¤ä¸ºæ˜¯å‘ç”Ÿäº†å˜åŒ–ï¼Œä½†CASè®¤ä¸ºæ²¡æœ‰ï¼Œè¿™å°±æ˜¯ABAé—®é¢˜ã€‚ä¸€ä¸ªç®€å•çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼šå¼•å…¥ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œæ¯æ¬¡æ›´æ–°å†…å­˜å€¼ç‰ˆæœ¬å·ä¹Ÿæ›´æ–°ï¼ŒåŒæ—¶æ¯”è¾ƒå†…å­˜å€¼å’Œç‰ˆæœ¬å·ç›¸åŒæ‰è®¤ä¸ºæ²¡æœ‰å‘ç”Ÿå˜åŒ–ã€‚åœ¨JUCä¸­å¯¹åº”çš„å®ç°æ˜¯AtomicStampedReferenceå’ŒAtomicmarkableReferenceç±»ã€‚</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="æ€»ç»“">æ€»ç»“<a class="hash-link" href="#æ€»ç»“" title="Direct link to heading">â€‹</a></h2><ol><li>éé˜»å¡ç®—æ³•é€šè¿‡CASæ¥å®ç°çº¿ç¨‹å®‰å…¨æ€§</li><li>æ²¡æœ‰AtomicFloatå’ŒAtomicDoubleç±»</li><li>åœ¨ç«äº‰ç¨‹åº¦ä¸­ç­‰æƒ…å†µä¸‹ï¼Œä½¿ç”¨åŸå­ç±»æ€§èƒ½ä¼˜äºé”</li><li>éé˜»å¡ç®—æ³•çš„å®ç°æ›´åŠ å›°éš¾ï¼Œè§ConcurrentLinkedQueue</li><li>CASå­˜åœ¨ABAé—®é¢˜ï¼Œé€šè¿‡å¼•å…¥ç‰ˆæœ¬å·è§£å†³</li></ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/docs/tags/java-concurrency">Java Concurrency</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/docs/tags/reading-notes">ReadingNotes</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/kayhaw/kayhaw.github.io/edit/master/website/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap15.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap14"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">æ„å»ºè‡ªå®šä¹‰çš„åŒæ­¥å·¥å…·</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap16"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Javaå†…å­˜æ¨¡å‹</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#é”çš„åŠ£åŠ¿" class="table-of-contents__link toc-highlight">é”çš„åŠ£åŠ¿</a></li><li><a href="#ç¡¬ä»¶å¯¹å¹¶å‘çš„æ”¯æŒ" class="table-of-contents__link toc-highlight">ç¡¬ä»¶å¯¹å¹¶å‘çš„æ”¯æŒ</a><ul><li><a href="#æ¯”è¾ƒå¹¶äº¤æ¢" class="table-of-contents__link toc-highlight">æ¯”è¾ƒå¹¶äº¤æ¢</a></li><li><a href="#éé˜»å¡çš„è®¡æ•°å™¨" class="table-of-contents__link toc-highlight">éé˜»å¡çš„è®¡æ•°å™¨</a></li><li><a href="#jvmå¯¹casçš„æ”¯æŒ" class="table-of-contents__link toc-highlight">JVMå¯¹CASçš„æ”¯æŒ</a></li></ul></li><li><a href="#åŸå­å˜é‡ç±»" class="table-of-contents__link toc-highlight">åŸå­å˜é‡ç±»</a><ul><li><a href="#åŸå­å˜é‡ç±»æ˜¯ä¸€ç§æ›´å¥½çš„volatile" class="table-of-contents__link toc-highlight">åŸå­å˜é‡ç±»æ˜¯ä¸€ç§æ›´å¥½çš„volatile</a></li><li><a href="#æ€§èƒ½æ¯”è¾ƒé”ä¸åŸå­å˜é‡" class="table-of-contents__link toc-highlight">æ€§èƒ½æ¯”è¾ƒï¼šé”ä¸åŸå­å˜é‡</a></li></ul></li><li><a href="#éé˜»å¡ç®—æ³•" class="table-of-contents__link toc-highlight">éé˜»å¡ç®—æ³•</a><ul><li><a href="#éé˜»å¡çš„æ ˆ" class="table-of-contents__link toc-highlight">éé˜»å¡çš„æ ˆ</a></li><li><a href="#éé˜»å¡çš„é“¾è¡¨" class="table-of-contents__link toc-highlight">éé˜»å¡çš„é“¾è¡¨</a></li><li><a href="#åŸå­çš„åŸŸæ›´æ–°å™¨" class="table-of-contents__link toc-highlight">åŸå­çš„åŸŸæ›´æ–°å™¨</a></li><li><a href="#abaé—®é¢˜" class="table-of-contents__link toc-highlight">ABAé—®é¢˜</a></li></ul></li><li><a href="#æ€»ç»“" class="table-of-contents__link toc-highlight">æ€»ç»“</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">è¯»ä¹¦ç¬”è®°</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://www.zhihu.com/people/xiao-ke-dou-7" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>çŸ¥ä¹<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/kayhaw" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://gitee.com/kayhaw" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 ä½•è½²(Kay Haw). Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b8f66f99.js"></script>
<script src="/assets/js/main.a8d1eeac.js"></script>
</body>
</html>