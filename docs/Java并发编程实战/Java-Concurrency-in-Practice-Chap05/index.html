<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Kay Haw&#39;s Blog Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Kay Haw&#39;s Blog Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"><title data-react-helmet="true">åŸºç¡€æ„å»ºæ¨¡å— | Kay Haw&#x27;s Blog</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://kayhaw.github.io/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap05"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="åŸºç¡€æ„å»ºæ¨¡å— | Kay Haw&#x27;s Blog"><meta data-react-helmet="true" name="description" content="ã€ŠJavaå¹¶å‘ç¼–ç¨‹ã€‹ç¬¬äº”ç« è¯»ä¹¦ç¬”è®°"><meta data-react-helmet="true" property="og:description" content="ã€ŠJavaå¹¶å‘ç¼–ç¨‹ã€‹ç¬¬äº”ç« è¯»ä¹¦ç¬”è®°"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://kayhaw.github.io/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap05"><link data-react-helmet="true" rel="alternate" href="https://kayhaw.github.io/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap05" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://kayhaw.github.io/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap05" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.0138175c.css">
<link rel="preload" href="/assets/js/runtime~main.5c7121e2.js" as="script">
<link rel="preload" href="/assets/js/main.eedec005.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Kay Haw&#x27;s Blog" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Kay Haw&#x27;s Blog" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Kay Haw&#x27;s Blog</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro">è¯»ä¹¦ç¬”è®°</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/kayhaw" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ğŸŒ</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/intro">è¯»ä¹¦ç¬”è®°</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">C++PrimerPlus</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">EffectiveC++</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Learning Akka</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Stream Processing with Apache Flink</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap02">çº¿ç¨‹å®‰å…¨æ€§</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap03">å¯¹è±¡çš„å…±äº«</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap04">å¯¹è±¡çš„ç»„åˆ</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap05">åŸºç¡€æ„å»ºæ¨¡å—</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap06">ä»»åŠ¡æ‰§è¡Œ</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap07">å–æ¶ˆä¸å…³é—­</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap08">çº¿ç¨‹æ± çš„ä½¿ç”¨</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap10">é¿å…æ´»è·ƒæ€§å±é™©</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap13">æ˜¾å¼é”</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap14">æ„å»ºè‡ªå®šä¹‰çš„åŒæ­¥å·¥å…·</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap15">åŸå­å˜é‡ä¸éé˜»å¡åŒæ­¥æœºåˆ¶</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap16">Javaå†…å­˜æ¨¡å‹</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">é«˜æ€§èƒ½MySQL</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>åŸºç¡€æ„å»ºæ¨¡å—</h1></header><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>ã€ŠJavaå¹¶å‘ç¼–ç¨‹ã€‹ç¬¬äº”ç« è¯»ä¹¦ç¬”è®°</p></div></div><p>ä¸Šä¸€ç« ä»‹ç»æ„é€ çº¿ç¨‹å®‰å…¨ç±»çš„ä¸€äº›æŠ€æœ¯ï¼Œæœ¬ç« ä»‹ç»Javaç±»åº“æä¾›çš„åŒæ­¥å·¥å…·ç±»ï¼Œä»¥åŠä½¿ç”¨å®ƒä»¬çš„å¸¸ç”¨æ¨¡å¼ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="åŒæ­¥å®¹å™¨ç±»"></a>åŒæ­¥å®¹å™¨ç±»<a class="hash-link" href="#åŒæ­¥å®¹å™¨ç±»" title="Direct link to heading">#</a></h2><p>æ—©æœŸåŒæ­¥å®¹å™¨ç±»åŒ…æ‹¬Vectorå’ŒHashtableï¼Œåç»­åŠ å…¥Collections.synchronizedXxxå·¥å‚æ–¹æ³•æä¾›çš„åŒæ­¥å®¹å™¨å°è£…ç±»ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="åŒæ­¥å®¹å™¨ç±»çš„é—®é¢˜"></a>åŒæ­¥å®¹å™¨ç±»çš„é—®é¢˜<a class="hash-link" href="#åŒæ­¥å®¹å™¨ç±»çš„é—®é¢˜" title="Direct link to heading">#</a></h3><p>åŒæ­¥å®¹å™¨æœ¬èº«æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†åœ¨å®ƒä»¬èº«ä¸Šè¿›è¡Œçš„å¤åˆæ“ä½œï¼ˆè¿­ä»£éå†ã€è·³è½¬ä»¥åŠæ¡ä»¶è¿ç®—ï¼‰ä¼šå‡ºç°é—®é¢˜ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class UnsafeVectorHelpers {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static Object getLast(Vector list) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int lastIndex = list.size() - 1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return list.get(lastIndex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void deleteLast(Vector list) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int lastIndex = list.size() - 1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        list.remove(lastIndex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>å‡è®¾çº¿ç¨‹Aè°ƒç”¨getLastè·å–å®¹å™¨æœ€åä¸€ä¸ªå…ƒç´ ï¼Œçº¿ç¨‹Bè°ƒç”¨deleteLaståˆ é™¤å®¹å™¨æœ€åä¸€ä¸ªå…ƒç´ ã€‚åœ¨æŸç§ç‰¹å®šçš„æ‰§è¡Œé¡ºåºä¸‹ï¼Œå¯èƒ½å‡ºç°Aè·å–Båˆ é™¤çš„å…ƒç´ ï¼Œå¯¼è‡´getLastæŠ›å‡ºç´¢å¼•è¶Šç•Œå¼‚å¸¸ã€‚æ­¤æ—¶å¯ä»¥é€šè¿‡å®¢æˆ·ç«¯åŠ é”è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼Œå®¢æˆ·ç«¯åŠ é”ç²’åº¦è¿‡å¤§ï¼Œç‰ºç‰²äº†ä¼¸ç¼©æ€§ï¼Œé™ä½äº†å¹¶å‘åº¦ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class SafeVectorHelpers {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static Object getLast(Vector list) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (list) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            int lastIndex = list.size() - 1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return list.get(lastIndex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void deleteLast(Vector list) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (list) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            int lastIndex = list.size() - 1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            list.remove(lastIndex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>åŒæ­¥å®¹å™¨åˆ°åº•çº¿ç¨‹å®‰å…¨å—ï¼Ÿ</h5></div><div class="admonition-content"><p>å¤åˆæ“ä½œåœ¨æŸäº›æƒ…å†µä¸‹å¯¼è‡´é—®é¢˜ï¼ŒåŸä¹¦æè¿°ä¸º<em>è¿™å¹¶ä¸æ„å‘³ç€Vectorå°±ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºVectorçŠ¶æ€ä¾ç„¶æœ‰é™ï¼Œå¹¶ä¸”æŠ›å‡ºçš„å¼‚å¸¸ä¹Ÿä¸å…¶è§„èŒƒä¿æŒä¸€è‡´</em>ã€‚</p></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="è¿­ä»£å™¨ä¸concurrentmodificationexception"></a>è¿­ä»£å™¨ä¸ConcurrentModificationException<a class="hash-link" href="#è¿­ä»£å™¨ä¸concurrentmodificationexception" title="Direct link to heading">#</a></h3><p>éå†åŒæ­¥å®¹å™¨çš„æ ‡å‡†æ–¹å¼æ˜¯ä½¿ç”¨è¿­ä»£å™¨ï¼Œä½†è¿­ä»£ä½œä¸ºå¤åˆæ“ä½œä¹Ÿä¼šå¤šçº¿ç¨‹ä¿®æ”¹å®¹å™¨ä¸‹å‡ºç°é—®é¢˜ã€‚<strong>åœ¨è®¾è®¡åŒæ­¥å®¹å™¨ç±»çš„è¿­ä»£å™¨æ—¶å¹¶æ²¡æœ‰è€ƒè™‘å¹¶å‘ä¿®æ”¹çš„é—®é¢˜</strong>ï¼Œå½“è¿™ç§æƒ…å†µå‡ºç°æ—¶ï¼Œä¼šæŠ›å‡ºConcurrentModificationExceptionå¼‚å¸¸ï¼ˆFail-Fastæœºåˆ¶ï¼‰ã€‚å…·ä½“çš„å®ç°æ–¹å¼æ˜¯ç»´æŠ¤ä¸€ä¸ªå®¹å™¨å¤§å°çš„è®¡æ•°å™¨ï¼Œå½“è¿­ä»£æœŸé—´è®¡æ•°å™¨å‘ç”Ÿå˜åŒ–å³æŠ›å‡ºè¯¥å¼‚å¸¸ã€‚<strong>æ³¨æ„è¿™ç§æ£€æŸ¥æ˜¯æ²¡æœ‰åœ¨åŒæ­¥æƒ…å†µä¸‹æ‰§è¡Œçš„</strong>ï¼Œè¿™æ˜¯è®¾è®¡ä¸Šçš„æƒè¡¡ï¼Œä¸ºäº†é™ä½æ£€æµ‹ä»£ç å¸¦æ¥çš„å½±å“ã€‚</p><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>æ³¨æ„</h5></div><div class="admonition-content"><p>å½“ç›´æ¥ä»å®¹å™¨åˆ é™¤å…ƒç´ è€Œä¸æ˜¯ä½¿ç”¨è¿­ä»£å™¨æ—¶ï¼Œå•çº¿ç¨‹æƒ…å†µä¸‹ä¹Ÿä¼šæŠ›å‡ºConcurrentModificationExceptionå¼‚å¸¸ã€‚</p></div></div><p>è¦æƒ³å®Œå…¨æ¶ˆé™¤å¯èƒ½æŠ›å‡ºçš„ConcurrentModificationExceptionå¼‚å¸¸ï¼Œæœ‰ä¸¤ç§è§£å†³æ–¹å¼ï¼š</p><ol><li>å¯¹å®¹å™¨åŠ é”ï¼šå½“å®¹å™¨å…ƒç´ å¾ˆå¤šï¼Œè®¿é—®å…ƒç´ æ‰§è¡Œæ“ä½œæ—¶é—´å¾ˆé•¿æ—¶ï¼Œå¯èƒ½ä¼šäº§ç”Ÿæ­»é”ã€‚</li><li>å…‹éš†å®¹å™¨ï¼šåœ¨å‰¯æœ¬ä¸Šè¿›è¡Œè¿­ä»£ï¼Œä½†å…‹éš†è¿‡ç¨‹ä¸­ä»éœ€è¦å¯¹å®¹å™¨åŠ é”</li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="éšè—è¿­ä»£å™¨"></a>éšè—è¿­ä»£å™¨<a class="hash-link" href="#éšè—è¿­ä»£å™¨" title="Direct link to heading">#</a></h3><p>æ³¨æ„è¿­ä»£å™¨æ“ä½œåœ¨ä»£ç ä¸­å¯èƒ½å¹¶æ²¡æœ‰é‚£ä¹ˆæ˜æ˜¾ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼Œæ‰“å°æ—¥å¿—æ“ä½œåŒ…å«äº†ä¸€ä¸ªéšè—çš„è¿­ä»£æ“ä½œï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class HiddenIterator {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Set&lt;Integer&gt; set = new HashSet&lt;Integer&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized void add(Integer i) { set.add(i); }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized void remove(Integer i) { set.remove(i); }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void addTenThings() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Random r = new Random();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; 10; i++)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            add(r.nextInt());</span></span><span class="token-line docusaurus-highlight-code-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;DEBUG: added ten elements to &quot; + set);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ç¼–è¯‘å™¨å°†å­—ç¬¦ä¸²çš„è¿æ¥æ“ä½œè½¬ä¸ºStringBuilder.appendè°ƒç”¨ï¼Œè¿™ä¸ªæ–¹æ³•åˆä¼šè°ƒç”¨setçš„toStringæ–¹æ³•ï¼Œè€Œæ ‡å‡†å®¹å™¨çš„toStringæ–¹æ³•åˆä¼š<strong>è¿­ä»£</strong>å®¹å™¨è°ƒç”¨æ¯ä¸ªå…ƒç´ çš„toStringæ–¹æ³•ç”Ÿæˆæœ€åçš„å­—ç¬¦ä¸²ï¼Œç±»ä¼¼çš„æ–¹æ³•è¿˜åŒ…æ‹¬hashCodeã€equalsã€containsAllç­‰ï¼Œå®ƒä»¬éƒ½æœ‰å¯èƒ½æŠ›å‡ºConcurrentModificationExceptionå¼‚å¸¸ã€‚</p><div class="admonition admonition-danger alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>å°å¿ƒ</h5></div><div class="admonition-content"><p>çŠ¶æ€å’Œä¿æŠ¤å®ƒä»¬çš„åŒæ­¥ä»£ç ä¹‹é—´ç›¸éš”è¶Šè¿œï¼Œå¼€å‘äººå‘˜è¶Šå®¹æ˜“å¿˜è®°ä½¿ç”¨æ­£ç¡®çš„åŒæ­¥</p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="å¹¶å‘å®¹å™¨"></a>å¹¶å‘å®¹å™¨<a class="hash-link" href="#å¹¶å‘å®¹å™¨" title="Direct link to heading">#</a></h2><p>é‰´äºåŒæ­¥å®¹å™¨çš„æ€§èƒ½é—®é¢˜ï¼ˆä¸²è¡ŒåŒ–çŠ¶æ€è®¿é—®ï¼‰ï¼ŒJava 5.0æä¾›äº†å¹¶å‘å®¹å™¨æ¥æ”¹è¿›ï¼Œå¦‚ConcurrentMapæ¥å£æ–°å¢äº†Put-If-Absentã€æ¡ä»¶åˆ é™¤ç­‰å¤åˆæ“ä½œã€‚Java 5.0æ–°å¢äº†Queueå’ŒBlockingQueueä¸¤ç§å®¹å™¨ï¼Œé˜»å¡é˜Ÿåˆ—åœ¨é˜Ÿåˆ—çš„åŸºç¡€ä¸Šæ‰©å±•äº†å¯é˜»å¡çš„æ’å…¥å’Œè·å–æ“ä½œã€‚Java 6ä¹Ÿå¼•å…¥äº†ConcurrentSkipListMapå’ŒConcurrentSkipListSetåˆ†åˆ«ä»£æ›¿TreeMapã€TreeSetã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="concurrenthashmap"></a>ConcurrentHashMap<a class="hash-link" href="#concurrenthashmap" title="Direct link to heading">#</a></h3><p>åŒæ­¥å®¹å™¨ç²—ç²’åº¦çš„å¹¶å‘ç­–ç•¥ä½¿å¾—æ¯æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®å®¹å™¨ï¼ŒConcurrentHashMapä½¿ç”¨ç²’åº¦æ›´ç»†çš„åˆ†æ®µé”æœºåˆ¶æ¥å®ç°æœ€å¤§ç¨‹åº¦çš„å…±äº«ã€‚ä½œä¸ºå¹¶å‘å®¹å™¨ï¼Œå®ƒä¸ä¼šæŠ›å‡ºConcurrentModificationExceptionå¼‚å¸¸ï¼Œä½†æ˜¯è¿”å›çš„è¿­ä»£å™¨å…·æœ‰å¼±ä¸€è‡´æ€§è€ŒéFast-Failã€‚ConcurrentHashMapçš„sizeã€isEmptyç­‰æ–¹æ³•è¯­ä¹‰è¢«å‰Šå¼±ï¼Œå¹¶ä¸ä»£è¡¨å®¹å™¨çš„å®é™…çŠ¶æ€ï¼Œåªæœ‰å½“éœ€è¦å¯¹æ•´ä¸ªMapåŠ é”è¿›è¡Œç‹¬å è®¿é—®æ—¶æ‰æ”¾å¼ƒä½¿ç”¨ConcurrentHashMapï¼Œæ€»ä½“æ¥è¯´åˆ©å¤§äºå¼Šã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="é¢å¤–çš„åŸå­mapæ“ä½œ"></a>é¢å¤–çš„åŸå­Mapæ“ä½œ<a class="hash-link" href="#é¢å¤–çš„åŸå­mapæ“ä½œ" title="Direct link to heading">#</a></h3><p>ConcurrentHashMapä¸èƒ½è¢«åŠ é”æ¥æ‰§è¡Œç‹¬å è®¿é—®ï¼Œå› æ­¤æ— æ³•ç”¨å®¢æˆ·ç«¯åŠ é”æ–¹å¼å®ç°åŸå­æ“ä½œã€‚ä½†ConcurrentHashMapå·²ç»å£°æ˜å¹¶å®ç°äº†è¯¸å¦‚Put-If-Absentã€Remove-If-Equalã€Replace-If-Equalç­‰å¤åˆæ“ä½œã€‚å½“åœ¨ç°æœ‰åŒæ­¥Mapä¸Šæ·»åŠ å¤åˆæ“ä½œæ—¶ï¼Œè€ƒè™‘ä½¿ç”¨ConcurrentHashMapä»£æ›¿ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="copyonwritearraylist"></a>CopyOnWriteArrayList<a class="hash-link" href="#copyonwritearraylist" title="Direct link to heading">#</a></h3><p>CopyOnWriteArrayList(Set)ä½œä¸ºåŒæ­¥List(Set)çš„æ›¿ä»£å“ï¼Œåœ¨è¿­ä»£æœŸé—´ä¸éœ€è¦å¯¹å®¹å™¨åŠ é”æˆ–å¤åˆ¶(å‡†ç¡®åœ°æ¥è¯´æ˜¯è¯»æ—¶ä¸å¤åˆ¶)ã€‚â€œå†™æ—¶å¤åˆ¶â€å®¹å™¨ä¸ä¼šæŠ›å‡ºConcurrentModificationExceptionå¼‚å¸¸ï¼Œè¿”å›å…ƒç´ ä¸åˆ›å»ºè¿­ä»£å™¨æ—¶çš„ä¸€è‡´ã€‚ä»…å½“è¯»æ“ä½œè¿œå¤šäºå†™æ“ä½œæ—¶ï¼Œæ‰åº”è¯¥ä½¿ç”¨å†™æ—¶å¤åˆ¶å®¹å™¨ï¼Œæ¯”ä¾‹äº‹ä»¶é€šçŸ¥ç³»ç»Ÿï¼šåˆ†å‘é€šçŸ¥æ—¶è¿­ä»£å·²æ³¨å†Œç›‘å¬å™¨åˆ—è¡¨å¹¶è°ƒç”¨ç›‘å¬å™¨ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ç›‘å¬å™¨çš„æ³¨å†Œå’Œæ³¨é”€è¿œå°‘äºæ¥æ”¶äº‹ä»¶é€šçŸ¥çš„æ“ä½œã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="é˜»å¡é˜Ÿåˆ—å’Œç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼"></a>é˜»å¡é˜Ÿåˆ—å’Œç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼<a class="hash-link" href="#é˜»å¡é˜Ÿåˆ—å’Œç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼" title="Direct link to heading">#</a></h2><p>ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼å°†â€œæ‰¾å‡ºéœ€è¦å®Œæˆçš„å·¥ä½œâ€ä¸â€œæ‰§è¡Œå·¥ä½œâ€è§£è€¦ï¼ŒåŒæ—¶ä¹Ÿå°†ç”Ÿäº§æ•°æ®ä¸ä½¿ç”¨æ•°æ®è§£è€¦ï¼Œè§£å†³ä¸¤è€…é€Ÿç‡ç›¸å·®è¿‡å¤§çš„è´Ÿè½½é—®é¢˜ã€‚è€Œé˜»å¡é˜Ÿåˆ—å¤©ç”Ÿæ”¯æŒç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼Œæä¾›é˜»å¡çš„put/takeæ–¹æ³•å’Œå®šæ—¶çš„offer/pollæ–¹æ³•ã€‚é˜»å¡é˜Ÿåˆ—åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š</p><ol><li>LinkedBlockingQueue/ArrayBlockingQueueï¼ŒåŸºäºFIFOç­–ç•¥çš„é˜»å¡é˜Ÿåˆ—</li><li>PriorityBlockingQueueï¼ŒåŸºäºä¼˜å…ˆçº§çš„é˜»å¡é˜Ÿåˆ—</li><li>SynchronousQueueï¼Œç»´æŠ¤ä¸€ç»„çº¿ç¨‹</li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ç¤ºä¾‹æ¡Œé¢æœç´¢"></a>ç¤ºä¾‹ï¼šæ¡Œé¢æœç´¢<a class="hash-link" href="#ç¤ºä¾‹æ¡Œé¢æœç´¢" title="Direct link to heading">#</a></h3><p>é˜»å¡é˜Ÿåˆ—ä»£ç æ¨¡æ¿ï¼Œç”Ÿäº§è€…/æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œä½¿ç”¨é˜»å¡é˜Ÿåˆ—ä½œä¸ºæˆå‘˜ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­åˆ›å»ºé˜»å¡é˜Ÿåˆ—å¹¶å°†å¼•ç”¨ä½œä¸ºå‚æ•°ä¼ ç»™ç”Ÿäº§è€…/æ¶ˆè´¹è€…çº¿ç¨‹çš„æ„é€ å™¨ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class ProducerConsumer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class FileCrawler implements Runnable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final BlockingQueue&lt;File&gt; fileQueue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final FileFilter fileFilter;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final File root;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public FileCrawler(BlockingQueue&lt;File&gt; fileQueue,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final FileFilter fileFilter,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           File root) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.fileQueue = fileQueue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.root = root;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.fileFilter = new FileFilter() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                public boolean accept(File f) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return f.isDirectory() || fileFilter.accept(f);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private boolean alreadyIndexed(File f) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                crawl(root);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (InterruptedException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Thread.currentThread().interrupt();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private void crawl(File root) throws InterruptedException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            File[] entries = root.listFiles(fileFilter);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (entries != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (File entry : entries)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (entry.isDirectory())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        crawl(entry);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    else if (!alreadyIndexed(entry))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        fileQueue.put(entry);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class Indexer implements Runnable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final BlockingQueue&lt;File&gt; queue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public Indexer(BlockingQueue&lt;File&gt; queue) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.queue = queue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                while (true)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    indexFile(queue.take());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (InterruptedException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Thread.currentThread().interrupt();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void indexFile(File file) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Index the file...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final int BOUND = 10;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final int N_CONSUMERS = Runtime.getRuntime().availableProcessors();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void startIndexing(File[] roots) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        BlockingQueue&lt;File&gt; queue = new LinkedBlockingQueue&lt;File&gt;(BOUND);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        FileFilter filter = new FileFilter() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public boolean accept(File file) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (File root : roots)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            new Thread(new FileCrawler(queue, filter, root)).start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; N_CONSUMERS; i++)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            new Thread(new Indexer(queue)).start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ä¸²è¡Œçº¿ç¨‹å°é—­"></a>ä¸²è¡Œçº¿ç¨‹å°é—­<a class="hash-link" href="#ä¸²è¡Œçº¿ç¨‹å°é—­" title="Direct link to heading">#</a></h3><p>é˜»å¡é˜Ÿåˆ—çš„åŒæ­¥æœºåˆ¶ä½¿å¾—é˜Ÿåˆ—ä¸­çš„å¯¹è±¡ä»ç”Ÿäº§è€…çº¿ç¨‹<strong>å‘å¸ƒ</strong>åˆ°æ¶ˆè´¹è€…çº¿ç¨‹æ˜¯å®‰å…¨çš„ã€‚çº¿ç¨‹å°é—­æŒ‡å¯¹è±¡åªèƒ½æœ‰å•ä¸ªçº¿ç¨‹æ‰€æœ‰ï¼Œä½†æ˜¯å¯ä»¥å®‰å…¨å‘å¸ƒå¯¹è±¡æ¥è½¬ç§»å¯¹è±¡æ‰€æœ‰æƒã€‚è‹¥è½¬ç§»ååªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰å¯¹è±¡ä¸”ä¹‹å‰æ‰€æœ‰è€…ä¸ä¼šå†è®¿é—®å®ƒï¼Œå¯¹è±¡ä»ç„¶æ˜¯çº¿ç¨‹å°é—­çš„ã€‚å› æ­¤ï¼Œé˜»å¡é˜Ÿåˆ—ä¹Ÿå¯è§†ä¸ºä¸€ç§ä¸²è¡Œçº¿ç¨‹å°é—­ï¼Œå…¶ä»–ç±»ä¼¼æœºåˆ¶è¿˜åŒ…æ‹¬ConcurrentMapçš„åŸå­æ–¹æ³•removeæˆ–è€…AtomicReferenceçš„åŸå­æ–¹æ³•compareAndSetã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="åŒç«¯é˜Ÿåˆ—ä¸å·¥ä½œå¯†å–"></a>åŒç«¯é˜Ÿåˆ—ä¸å·¥ä½œå¯†å–<a class="hash-link" href="#åŒç«¯é˜Ÿåˆ—ä¸å·¥ä½œå¯†å–" title="Direct link to heading">#</a></h3><p>Java 6æ–°å¢äº†åŒç«¯é˜Ÿåˆ—Dequeï¼ˆå‘éŸ³åŒdeckï¼‰å’ŒBlockingDequeåˆ†åˆ«å¯¹Queueå’ŒBlockingQueueæ‰©å±•ã€‚åŒç«¯é˜Ÿåˆ—ä½¿ç”¨äºå·¥ä½œå¯†å–(Work Stealing)æ¨¡å¼ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹éƒ½æœ‰<strong>å„è‡ª</strong>çš„åŒç«¯é˜Ÿåˆ—ï¼Œå½“å®Œæˆè‡ªå·±é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡åï¼Œè¿˜å¯ä»¥ä»å°¾ç«¯è·å–å…¶ä»–æ¶ˆè´¹è€…çš„åŒç«¯é˜Ÿåˆ—ï¼Œ<strong>é€‚ç”¨äºæ—¢æ˜¯ç”Ÿäº§è€…åˆæ˜¯æ¶ˆè´¹è€…çš„åœºæ™¯(æ‰§è¡Œä»»åŠ¡æ—¶å‡ºç°äº†æ›´å¤šä»»åŠ¡)</strong>ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="é˜»å¡æ–¹æ³•ä¸ä¸­æ–­æ–¹æ³•"></a>é˜»å¡æ–¹æ³•ä¸ä¸­æ–­æ–¹æ³•<a class="hash-link" href="#é˜»å¡æ–¹æ³•ä¸ä¸­æ–­æ–¹æ³•" title="Direct link to heading">#</a></h2><p>é˜»å¡é˜Ÿåˆ—çš„put\takeç­‰æ–¹æ³•ä¼šæŠ›å‡ºå—æ£€æŸ¥å¼‚å¸¸InterruptedExceptionï¼Œè¡¨æ˜è¯¥æ–¹æ³•æ˜¯é˜»å¡æ–¹æ³•ï¼Œè‹¥æ–¹æ³•è¢«ä¸­æ–­ï¼Œå®ƒä¼šåŠªåŠ›æå‰ç»“æŸé˜»å¡çŠ¶æ€ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªbooleanç±»å‹çš„ä¸­æ–­çŠ¶æ€ï¼ŒThreadç±»çš„interruptæ–¹æ³•æ£€æŸ¥è¯¥çŠ¶æ€åˆ¤æ–­æ˜¯å¦è¢«ä¸­æ–­ï¼Œ</p><p>å½“è°ƒç”¨å°†æŠ›å‡ºInterruptedExceptionå¼‚å¸¸çš„æ–¹æ³•ï¼Œæ­¤æ—¶è°ƒç”¨æ–¹ä¹Ÿæˆä¸ºé˜»å¡æ–¹æ³•ï¼Œéœ€è¦å¤„ç†ä¸­æ–­ï¼Œé€šå¸¸æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹æ³•ï¼š</p><ul><li>ä¼ é€’InterruptedExceptionï¼šä¸æ•è·å¼‚å¸¸\æ•è·åç®€å•å¤„ç†å†æ¬¡æŠ›å‡º</li><li>æ¢å¤ä¸­æ–­ï¼šè°ƒç”¨interruptæ–¹æ³•æ¢å¤ä¸­æ–­çŠ¶æ€</li></ul><p>é”™è¯¯çš„å¤„ç†æ–¹å¼æ˜¯æ•è·ä½†æ˜¯ä¸åšä»»ä½•å“åº”ï¼Œæ­¤æ—¶çº¿ç¨‹è¢«ä¸­æ–­çš„è¯æ®å·²ç»ä¸¢å¤±ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="åŒæ­¥å·¥å…·ç±»"></a>åŒæ­¥å·¥å…·ç±»<a class="hash-link" href="#åŒæ­¥å·¥å…·ç±»" title="Direct link to heading">#</a></h2><p>åŒæ­¥å·¥å…·ç±»å¯ä»¥æ˜¯ä»»ä½•ä¸€ä¸ªå¯¹è±¡ï¼Œåªè¦å®ƒæ ¹æ®è‡ªèº«çŠ¶æ€æ¥åè°ƒçº¿ç¨‹çš„æ§åˆ¶æµã€‚é™¤äº†é˜»å¡é˜Ÿåˆ—å¤–ï¼ŒJavaç±»åº“è¿˜æä¾›äº†å…¶ä»–åŒæ­¥å·¥å…·ç±»ï¼Œä»¥ä¸‹é€ä¸€ä»‹ç»ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="é—­é”"></a>é—­é”<a class="hash-link" href="#é—­é”" title="Direct link to heading">#</a></h3><p>é—­é”æ˜¯ä¸€ç§åŒæ­¥å·¥å…·ç±»ï¼Œå½“é—­é”åˆ°è¾¾ç»“æŸçŠ¶æ€ä¹‹å‰ï¼Œæ‰€æœ‰ç­‰å¾…è¯¥é—­é”çš„çº¿ç¨‹è¢«é˜»å¡ï¼Œå½“åˆ°è¾¾ç»“æŸçŠ¶æ€åï¼Œæ‰€æœ‰çº¿ç¨‹å¼€å§‹æ‰§è¡Œå¹¶ä¸”<strong>é—­é”çŠ¶æ€ä¸ä¼šå†æ”¹å˜</strong>ã€‚é—­é”ç”¨äºç¡®ä¿æŸäº›æ´»åŠ¨åœ¨å…¶ä»–æ´»åŠ¨å®Œæˆåæ‰ç»§ç»­æ‰§è¡Œã€‚</p><p>CountDownLatchæ˜¯ä¸€ç§çµæ´»çš„é—­é”å®ç°ï¼Œå…¶æ„é€ å‡½æ•°æ¥æ”¶ä¸€ä¸ªæ­£æ•´æ•°ä½œä¸ºï¼Œæä¾›countDownæ–¹æ³•å°†è®¡æ•°å™¨å‡ä¸€ï¼Œæä¾›awaitæ–¹æ³•é˜»å¡çº¿ç¨‹ç›´è¾¾è®¡æ•°å™¨ä¸º0ã€‚å¦‚ä¸‹ç¤ºä¾‹ä»£ç ä½¿ç”¨CountDownLatchè®¡ç®—æ‰€æœ‰çº¿ç¨‹å®Œæˆå·¥ä½œæ€»æ—¶é—´ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class TestHarness {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public long timeTasks(int nThreads, final Runnable task)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throws InterruptedException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final CountDownLatch startGate = new CountDownLatch(1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final CountDownLatch endGate = new CountDownLatch(nThreads);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; nThreads; i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Thread t = new Thread() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        startGate.await();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            task.run();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            endGate.countDown();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (InterruptedException ignored) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            t.start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        long start = System.nanoTime();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        startGate.countDown();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        endGate.await();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        long end = System.nanoTime();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return end - start;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>è¿™é‡Œä½¿ç”¨äº†ä¸¤ä¸ªé—­é”ï¼Œåˆ†åˆ«è¡¨ç¤ºèµ·å§‹é—¨å’Œç»“æŸé—¨ã€‚èµ·å§‹é—¨åˆå§‹å€¼ä¸º1ï¼Œä¸»çº¿ç¨‹å°†å…¶å‡1ï¼Œå¦‚æ­¤ç¡®ä¿æ‰€æœ‰å·¥ä½œçº¿ç¨‹å‡†å¤‡å°±ç»ªåä¸€åŒå¼€å§‹æ‰§è¡Œä»»åŠ¡ã€‚ç»“æŸé—¨åˆå§‹å€¼ä¸ºå·¥ä½œçº¿ç¨‹ä¸ªæ•°ï¼Œå·¥ä½œçº¿ç¨‹ç»“æŸåå°†å…¶å‡1ï¼Œå¦‚æ­¤ç¡®ä¿æœ€åä¸€ä¸ªå·¥ä½œçº¿ç¨‹ç»“æŸåä¸»çº¿ç¨‹ç»“æŸã€‚</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>ä¸ºä»€ä¹ˆè¦ç”¨èµ·å§‹é—¨ï¼Œä¸€ä¸ªç»“æŸé—¨ä¸å°±å¯ä»¥å—ï¼Ÿ</h5></div><div class="admonition-content"><p>ä¸ºäº†ç¡®ä¿æ‰€æœ‰å·¥ä½œçº¿ç¨‹â€œåŒæ—¶â€å¼€å§‹æ‰§è¡Œï¼Œå¦åˆ™å…ˆstartçš„çº¿ç¨‹å…ˆç»“æŸï¼Œå¯èƒ½å¯¼è‡´æœ€åç»Ÿè®¡æ—¶é—´åå¤§</p></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="futuretask"></a>FutureTask<a class="hash-link" href="#futuretask" title="Direct link to heading">#</a></h3><p>FutureTaskä¹Ÿå¯ä½œä¸ºä¸€ç§é—­é”å®ç°ï¼Œå®ƒæ˜¯Callableè®¡ç®—ç»“æœçš„å ä½ç¬¦ã€‚FutureTaskæœ‰3ä¸­çŠ¶æ€ï¼šç­‰å¾…æ‰§è¡Œã€æ­£åœ¨æ‰§è¡Œã€è¿è¡Œå®Œæˆï¼Œå½“è¿›å…¥å®ŒæˆçŠ¶æ€åä¾¿æ°¸è¿œåœç•™åœ¨è¿™ä¸ªçŠ¶æ€ã€‚</p><p>FutureTask.get()æ–¹æ³•ç”¨äºè·å–ç»“æœï¼Œè‹¥ä»»åŠ¡å®Œæˆåˆ™ç«‹å³è¿”å›ï¼Œå¦åˆ™getå°†é˜»å¡ç›´åˆ°ä»»åŠ¡å®Œæˆæˆ–è€…æŠ›å‡ºå¼‚å¸¸ã€‚å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼Œè¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥å¼‚æ­¥åŠ è½½äº§å“ä¿¡æ¯çš„ä»»åŠ¡ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class Preloader {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ProductInfo loadProductInfo() throws DataLoadException { return null; }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final FutureTask&lt;ProductInfo&gt; future =</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        new FutureTask&lt;ProductInfo&gt;(new Callable&lt;ProductInfo&gt;() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public ProductInfo call() throws DataLoadException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return loadProductInfo();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Thread thread = new Thread(future);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void start() { thread.start(); }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ProductInfo get() throws DataLoadException, InterruptedException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return future.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (ExecutionException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Throwable cause = e.getCause();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (cause instanceof DataLoadException)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw (DataLoadException) cause;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            else</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw LaunderThrowable.launderThrowable(cause);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    interface ProductInfo {}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">class DataLoadException extends Exception { }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ä¸ºäº†é¿å…åœ¨æ„é€ å‡½æ•°ä¸­è°ƒç”¨start()æ–¹æ³•ï¼ŒåŒ…è£…äº†startæ–¹æ³•æ¥è°ƒç”¨çº¿ç¨‹ã€‚æ³¨æ„getæ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸éƒ½ä¼šè¢«å°è£…åˆ°ä¸€ä¸ªExecutionExceptionä¸­ï¼Œéœ€è¦æ ¹æ®æƒ…å†µåˆ†åˆ«å¤„ç†ã€‚å½“å¼‚å¸¸æ—¶å—æ£€æŸ¥å¼‚å¸¸æ—¶ï¼Œé‡æ–°æŠ›å‡ºï¼Œå¦åˆ™ä½¿ç”¨LaunderThrowable.launderThrowableæ–¹æ³•å¤„ç†ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class LaunderThrowable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Coerce an unchecked Throwable to a RuntimeException</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * &lt;p/&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * If the Throwable is an Error, throw it; if it is a</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * RuntimeException return it, otherwise throw IllegalStateException</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static RuntimeException launderThrowable(Throwable t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (t instanceof RuntimeException)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return (RuntimeException) t;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        else if (t instanceof Error)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw (Error) t;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        else</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalStateException(&quot;Not unchecked&quot;, t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ä¿¡å·é‡"></a>ä¿¡å·é‡<a class="hash-link" href="#ä¿¡å·é‡" title="Direct link to heading">#</a></h3><p>ä¿¡å·é‡(Semaphore)ç”¨äºæ§åˆ¶è®¿é—®æŸä¸ªç‰¹å®šèµ„æºçš„æ“ä½œæ•°é‡æˆ–è€…æŸä¸ªæŒ‡å®šæ“ä½œçš„æ•°é‡ï¼Œè¿˜å¯ä»¥ç”¨äºå®ç°èµ„æºæ± æˆ–è€…å°†å®¹å™¨å˜æˆæœ‰ç•Œé˜»å¡å®¹å™¨ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class BoundedHashSet &lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Set&lt;T&gt; set;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Semaphore sem;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public BoundedHashSet(int bound) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.set = Collections.synchronizedSet(new HashSet&lt;T&gt;());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        sem = new Semaphore(bound);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean add(T o) throws InterruptedException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        sem.acquire();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean wasAdded = false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            wasAdded = set.add(o);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return wasAdded;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!wasAdded)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                sem.release();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean remove(Object o) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean wasRemoved = set.remove(o);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (wasRemoved)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            sem.release();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return wasRemoved;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Semaphoreæ„é€ æ–¹æ³•ä¼ å…¥ä¸€ä¸ªæ­£æ•°ä½œä¸ºåˆå§‹è®¸å¯è¯ä¸ªæ•°ï¼Œæä¾›æ–¹æ³•releaseå’Œacquireåˆ†åˆ«æ–°å¢å’Œå‡å°‘ä¸€ä¸ªè®¸å¯è¯ã€‚å½“è®¸å¯è¯ä¸ªæ•°ä¸º0æ—¶ï¼Œacquireæ–¹æ³•è¢«é˜»å¡ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="æ …æ "></a>æ …æ <a class="hash-link" href="#æ …æ " title="Direct link to heading">#</a></h3><p>æ …æ (Barrier)ç±»ä¼¼é—­é”ï¼Œå®ƒèƒ½é˜»å¡ä¸€ç»„çº¿ç¨‹ç›´åˆ°æŸä¸ªäº‹ä»¶å‘ç”Ÿã€‚æ …æ å’Œé—­é”çš„åŒºåˆ«ï¼š</p><ol><li>é—­é”ç”¨äºç­‰å¾…äº‹ä»¶ï¼Œæ …æ ç”¨äºç­‰å¾…å…¶ä»–çº¿ç¨‹</li><li>é—­é”ä¸å¯é‡ç½®å¤ç”¨ï¼Œæ …æ å¯ä»¥ä½¿çº¿ç¨‹åå¤åœ¨æ …æ ä½ç½®æ±‡é›†</li><li>CountDownLatchæ˜¯å‡1åˆ°0ååŒæ—¶æ‰§è¡Œï¼ŒBarrieræ˜¯åŠ 1åˆ°ç‰¹å®šå€¼ååŒæ—¶æ‰§è¡Œ</li></ol><p>æ …æ æä¾›awaitæ–¹æ³•å°†é˜»å¡åˆ°æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾æ …æ ä½ç½®ï¼Œæ­¤æ—¶æ …æ æ‰“å¼€ï¼Œæ‰€æœ‰çº¿ç¨‹è¢«é‡Šæ”¾ï¼ŒåŒæ—¶æ …æ è¢«é‡ç½®ä¾›ä¸‹æ¬¡ä½¿ç”¨ã€‚å¦‚æœawaitè°ƒç”¨è¶…æ—¶æˆ–è€…awaité˜»å¡çš„çº¿ç¨‹è¢«ä¸­æ–­ï¼Œé‚£ä¹ˆæ …æ è¢«è®¤ä¸ºæ‰“ç ´ï¼Œæ‰€æœ‰é˜»å¡awaitè°ƒç”¨æŠ›å‡ºBrokenBarrierExceptionã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class CellularAutomata {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Board mainBoard;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final CyclicBarrier barrier;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Worker[] workers;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public CellularAutomata(Board board) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.mainBoard = board;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int count = Runtime.getRuntime().availableProcessors();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.barrier = new CyclicBarrier(count,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                new Runnable() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        mainBoard.commitNewValues();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }});</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.workers = new Worker[count];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; count; i++)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            workers[i] = new Worker(mainBoard.getSubBoard(count, i));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private class Worker implements Runnable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final Board board;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public Worker(Board board) { this.board = board; }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (!board.hasConverged()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (int x = 0; x &lt; board.getMaxX(); x++)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    for (int y = 0; y &lt; board.getMaxY(); y++)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        board.setNewValue(x, y, computeValue(x, y));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    barrier.await();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (InterruptedException ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (BrokenBarrierException ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private int computeValue(int x, int y) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Compute the new value that goes in (x,y)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void start() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; workers.length; i++)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            new Thread(workers[i]).start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mainBoard.waitForConvergence();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    interface Board {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int getMaxX();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int getMaxY();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int getValue(int x, int y);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int setNewValue(int x, int y, int value);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        void commitNewValues();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean hasConverged();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        void waitForConvergence();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Board getSubBoard(int numPartitions, int index);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>CellularAutomataç”¨äºæ¨¡æ‹Ÿç»†èƒå¢æ®–ä½ç½®ï¼Œå®ƒå°†é—®é¢˜åˆ†ä¸ºN(=CPUä¸ªæ•°)ä¸ªå­çº¿ç¨‹è§£å†³ã€‚å½“è¿™Nä¸ªå­é—®é¢˜éƒ½å®Œæˆè®¡ç®—å(åˆ°è¾¾æ …æ ä½ç½®)ï¼Œç”±æ …æ æäº¤è¿™äº›ç»“æœ(ç”±æœ€åä¸€ä¸ªåˆ°è¾¾çš„å­çº¿ç¨‹æ‰§è¡Œ)ï¼Œä¹‹åæ …æ çŠ¶æ€é‡ç½®ï¼Œè¿›è¡Œä¸‹ä¸€è½®è®¡ç®—ã€‚å¦ä¸€ç§ç®€åŒ–å½¢å¼çš„æ …æ æ˜¯Exchangerï¼Œå®ƒåªæœ‰ä¸¤ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œç”¨äºå®‰å…¨åœ°äº¤æ¢æ•°æ®ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="æ„å»ºé«˜æ•ˆä¸”å¯ä¼¸ç¼©çš„ç»“æœç¼“å­˜"></a>æ„å»ºé«˜æ•ˆä¸”å¯ä¼¸ç¼©çš„ç»“æœç¼“å­˜<a class="hash-link" href="#æ„å»ºé«˜æ•ˆä¸”å¯ä¼¸ç¼©çš„ç»“æœç¼“å­˜" title="Direct link to heading">#</a></h2><p>ä½œä¸ºä¸€ç§ç©ºé—´æ¢æ—¶é—´çš„ç­–ç•¥ï¼Œç®€å•çš„ç¼“å­˜è®¾è®¡å¯èƒ½å°†æ€§èƒ½ç“¶é¢ˆè½¬ä¸ºå¯ä¼¸ç¼©æ€§ç“¶é¢ˆã€‚é¦–å…ˆçœ‹ä¸€ä¸ªä½¿ç”¨HashMapç¼“å­˜è®¡ç®—ç»“æœçš„ç¤ºä¾‹ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class Memoizer1 &lt;A, V&gt; implements Computable&lt;A, V&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Map&lt;A, V&gt; cache = new HashMap&lt;A, V&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Computable&lt;A, V&gt; c;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Memoizer1(Computable&lt;A, V&gt; c) { this.c = c; }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized V compute(A arg) throws InterruptedException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        V result = cache.get(arg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (result == null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = c.compute(arg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            cache.put(arg, result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">interface Computable &lt;A, V&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    V compute(A arg) throws InterruptedException;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">class ExpensiveFunction implements Computable&lt;String, BigInteger&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public BigInteger compute(String arg) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // after deep thought...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new BigInteger(arg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ç¼“å­˜ç±»Memoizer1å®ç°Computableæ¥å£ï¼Œè°ƒç”¨computeæ–¹æ³•æ—¶é¦–å…ˆå°è¯•åœ¨å…¶å†…éƒ¨HashMapä¸­æ‰¾åˆ°ç¼“å­˜ç»“æœï¼Œæ²¡æœ‰æ‰¾åˆ°åˆ™è®¡ç®—å¹¶è¿”å›ã€‚ç”±äºHashMapä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè¿™é‡Œå¯¹æ•´ä¸ªcomputeæ–¹æ³•è¿›è¡ŒåŒæ­¥ã€‚ç»“æœæ˜¯æ¯æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œcomputeæ–¹æ³•ï¼Œå½“æŸä¸ªçº¿ç¨‹computeæ‰§è¡Œæ—¶é—´è¿‡é•¿æ—¶ï¼Œä½¿ç”¨ç¼“å­˜åè€Œä¼šå¯¼è‡´æ€»ä½“è®¡ç®—æ—¶é—´å¢åŠ ã€‚å¯¹æ­¤ï¼Œæ”¹è¿›æªæ–½æ˜¯ä½¿ç”¨ConcurrentHashMapæ¥ä»£æ›¿HashMapï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class Memoizer2 &lt;A, V&gt; implements Computable&lt;A, V&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Map&lt;A, V&gt; cache = new ConcurrentHashMap&lt;A, V&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Computable&lt;A, V&gt; c;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Memoizer2(Computable&lt;A, V&gt; c) { this.c = c; }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public V compute(A arg) throws InterruptedException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        V result = cache.get(arg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (result == null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = c.compute(arg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            cache.put(arg, result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ä½¿ç”¨ConcurrentHashMapæå‡äº†å¹¶å‘åº¦ï¼Œä½†æ˜¯è¿˜å­˜åœ¨ç¼ºé™·â€”â€”ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨computeæ—¶ä¼šè®¡ç®—ç›¸åŒå€¼ï¼Œè¿™è¿èƒŒäº†ä½¿ç”¨ç¼“å­˜çš„åˆè¡·ã€‚æˆ‘ä»¬å¸Œæœ›èƒ½é€šè¿‡æŸç§æ–¹å¼è¡¨è¾¾çº¿ç¨‹Aæ­£åœ¨è®¡ç®—ï¼Œçº¿ç¨‹Båªéœ€è¦ç­‰å¾…Aè®¡ç®—ç»“æŸç„¶åè·å–å…¶ç»“æœï¼Œè€ŒFutureTaskç±»æ°å¥½èƒ½æ»¡è¶³è¿™ç‚¹ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class Memoizer3 &lt;A, V&gt; implements Computable&lt;A, V&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Map&lt;A, Future&lt;V&gt;&gt; cache = new ConcurrentHashMap&lt;A, Future&lt;V&gt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Computable&lt;A, V&gt; c;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Memoizer2(Computable&lt;A, V&gt; c) { this.c = c; }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public V compute(A arg) throws InterruptedException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Future&lt;V&gt; f = cache.get(arg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (f == null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Callable&lt;V&gt; eval = new Callable&lt;V&gt;() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                public V call() throws InterruptedException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return c.compute(arg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            FutureTask&lt;V&gt; ft = new FutureTask&lt;V&gt;(eval);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            f = ft;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            cache.put(arg, ft);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ft.run();           // è°ƒç”¨c.compute</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return f.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (ExecutionException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw launderThrowable(e.getCause());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ç›¸æ¯”äºMemoizer2ï¼ŒMemoizer3ä¸­cacheçš„putæ“ä½œæ˜¯å¼‚æ­¥çš„ï¼Œä¸å¿…ç­‰åˆ°computeæ‰§è¡Œå®Œæˆã€‚è¿™å¤§å¤§å‡å°‘äº†çº¿ç¨‹é‡å¤è®¡ç®—çš„æ¦‚ç‡ï¼Œä½†æ˜¯ä»ä¼šå‘ç”Ÿï¼Œç©¶å…¶åŸå› æ˜¯å¤åˆæ“ä½œ(Put-If-Absent)å¹¶ä¸æ˜¯åŸå­çš„ï¼Œç»§ç»­æ”¹è¿›çš„computeä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public V compute(final A arg) throws InterruptedException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (true) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Future&lt;V&gt; f = cache.get(arg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (f == null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Callable&lt;V&gt; eval = new Callable&lt;V&gt;() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                public V call() throws InterruptedException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return c.compute(arg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            FutureTask&lt;V&gt; ft = new FutureTask&lt;V&gt;(eval);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            f = cache.putIfAbsent(arg, ft);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (f == null) { f = ft; ft.run(); }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return f.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (CancellationException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            cache.remove(arg, f);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (ExecutionException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw LaunderThrowable.launderThrowable(e.getCause());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ä½¿ç”¨putIfAbsentæ–¹æ³•è®¾ç½®ç¼“å­˜ï¼Œå¹¶ä¸”ç¬¬äºŒæ¬¡åˆ¤æ–­fæ˜¯å¦ä¸ºnullæ¥é˜²æ­¢å…¶ä»–çº¿ç¨‹å·²ç»æäº¤äº†computeä»»åŠ¡ï¼Œæœç»äº†é‡å¤è®¡ç®—ã€‚å¦å¤–ï¼Œä¸ºäº†è§£å†³<strong>ç¼“å­˜æ±¡æŸ“</strong>çš„é—®é¢˜ï¼Œå½“getæ–¹æ³•å‘ç”Ÿå¼‚å¸¸æ—¶ç§»é™¤è¯¥è®¡ç®—ä»»åŠ¡ç¼“å­˜ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="æ€»ç»“"></a>æ€»ç»“<a class="hash-link" href="#æ€»ç»“" title="Direct link to heading">#</a></h2><p>ä»¥ä¸‹æ˜¯å¯¹å‰5ç« åŸºç¡€çŸ¥è¯†éƒ¨åˆ†çš„æ¦‚å¿µå’Œè§„åˆ™çš„æ€»ç»“ï¼š</p><ol><li>å¯å˜çŠ¶æ€è‡³å…³é‡è¦ï¼Œè¶Šå°‘çš„å¯å˜çŠ¶æ€è¶Šå®¹æ˜“ç¡®ä¿çº¿ç¨‹å®‰å…¨æ€§</li><li>å°½é‡å°†å˜é‡å£°æ˜ä¸ºfinalï¼Œé™¤éå®ƒä»¬å¯å˜</li><li>ä¸å¯å˜å¯¹è±¡ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„</li><li>å°è£…æœ‰åŠ©äºç®¡ç†å¤æ‚æ€§</li><li>ç”¨é”ä¿æŠ¤å¯å˜å˜é‡</li><li><strong>å½“ä¿æŠ¤åŒä¸€ä¸ªä¸å˜æ€§æ¡ä»¶çš„æ‰€æœ‰å˜é‡æ—¶ï¼Œè¦ä½¿ç”¨åŒä¸€ä¸ªé”</strong></li><li><strong>åœ¨æ‰§è¡Œå¤åˆæ“ä½œæ—¶è¦æŒæœ‰é”</strong></li><li>å¤šçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå¯å˜å˜é‡ï¼Œæ²¡æœ‰åŒæ­¥æœºåˆ¶ä¼šå‡ºé—®é¢˜</li><li>ä¸è¦æ•…ä½œèªæ˜åœ°æ¨æ–­ä¸éœ€è¦åŒæ­¥</li><li>åœ¨è®¾è®¡è¿‡ç¨‹ä¸­è€ƒè™‘çº¿ç¨‹å®‰å…¨ï¼Œæˆ–åœ¨æ–‡æ¡£ä¸­æ˜ç¡®æŒ‡å‡ºå®ƒä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„</li><li>å°†åŒæ­¥ç­–ç•¥æ–‡æ¡£åŒ–</li></ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/docs/tags/java-concurrency">Java Concurrency</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/docs/tags/reading-notes">ReadingNotes</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/kayhaw/kayhaw.github.io/edit/master/website/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜\Java-Concurrency-in-Practice-Chap05.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap04"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« å¯¹è±¡çš„ç»„åˆ</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜/Java-Concurrency-in-Practice-Chap06"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">ä»»åŠ¡æ‰§è¡Œ Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#åŒæ­¥å®¹å™¨ç±»" class="table-of-contents__link">åŒæ­¥å®¹å™¨ç±»</a><ul><li><a href="#åŒæ­¥å®¹å™¨ç±»çš„é—®é¢˜" class="table-of-contents__link">åŒæ­¥å®¹å™¨ç±»çš„é—®é¢˜</a></li><li><a href="#è¿­ä»£å™¨ä¸concurrentmodificationexception" class="table-of-contents__link">è¿­ä»£å™¨ä¸ConcurrentModificationException</a></li><li><a href="#éšè—è¿­ä»£å™¨" class="table-of-contents__link">éšè—è¿­ä»£å™¨</a></li></ul></li><li><a href="#å¹¶å‘å®¹å™¨" class="table-of-contents__link">å¹¶å‘å®¹å™¨</a><ul><li><a href="#concurrenthashmap" class="table-of-contents__link">ConcurrentHashMap</a></li><li><a href="#é¢å¤–çš„åŸå­mapæ“ä½œ" class="table-of-contents__link">é¢å¤–çš„åŸå­Mapæ“ä½œ</a></li><li><a href="#copyonwritearraylist" class="table-of-contents__link">CopyOnWriteArrayList</a></li></ul></li><li><a href="#é˜»å¡é˜Ÿåˆ—å’Œç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼" class="table-of-contents__link">é˜»å¡é˜Ÿåˆ—å’Œç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼</a><ul><li><a href="#ç¤ºä¾‹æ¡Œé¢æœç´¢" class="table-of-contents__link">ç¤ºä¾‹ï¼šæ¡Œé¢æœç´¢</a></li><li><a href="#ä¸²è¡Œçº¿ç¨‹å°é—­" class="table-of-contents__link">ä¸²è¡Œçº¿ç¨‹å°é—­</a></li><li><a href="#åŒç«¯é˜Ÿåˆ—ä¸å·¥ä½œå¯†å–" class="table-of-contents__link">åŒç«¯é˜Ÿåˆ—ä¸å·¥ä½œå¯†å–</a></li></ul></li><li><a href="#é˜»å¡æ–¹æ³•ä¸ä¸­æ–­æ–¹æ³•" class="table-of-contents__link">é˜»å¡æ–¹æ³•ä¸ä¸­æ–­æ–¹æ³•</a></li><li><a href="#åŒæ­¥å·¥å…·ç±»" class="table-of-contents__link">åŒæ­¥å·¥å…·ç±»</a><ul><li><a href="#é—­é”" class="table-of-contents__link">é—­é”</a></li><li><a href="#futuretask" class="table-of-contents__link">FutureTask</a></li><li><a href="#ä¿¡å·é‡" class="table-of-contents__link">ä¿¡å·é‡</a></li><li><a href="#æ …æ " class="table-of-contents__link">æ …æ </a></li></ul></li><li><a href="#æ„å»ºé«˜æ•ˆä¸”å¯ä¼¸ç¼©çš„ç»“æœç¼“å­˜" class="table-of-contents__link">æ„å»ºé«˜æ•ˆä¸”å¯ä¼¸ç¼©çš„ç»“æœç¼“å­˜</a></li><li><a href="#æ€»ç»“" class="table-of-contents__link">æ€»ç»“</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">è¯»ä¹¦ç¬”è®°</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://www.zhihu.com/people/xiao-ke-dou-7" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>çŸ¥ä¹<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/kayhaw" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://gitee.com/kayhaw" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 ä½•è½²(Kay Haw). Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.5c7121e2.js"></script>
<script src="/assets/js/main.eedec005.js"></script>
</body>
</html>