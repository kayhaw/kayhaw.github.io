---
title: MySQL知识点总结
author: 何轲
author_title: Never settle down
author_url: https://github.com/kayhaw
author_image_url: https://avatars.githubusercontent.com/u/16892835?v=4
tags: 
  - MySQL
  - Summary
description: MySQL知识点总结
hide_table_of_contents: false
---

:pencil:MySQL知识点总结。
<!--truncate-->

## 存储引擎

MySQL可使用的存储引擎由InnoDB和MyISAM，两者的比对如下：

| 对比项 | MyISAM | InnoDB |
| ------ | ------ | ------ |
|存储结构|表信息分为3个文件：frm表定义信息、MYD表数据信息和MYI索引信息|表信息为1个文件|
|文件格式|数据文件(.MYD)和索引文件(.MYI)分开|数据和索引集中存储(.ibd)|
|记录存储顺序|按记录插入顺序保存|按主键大小有序插入|
|外键|不支持|支持|
|事务|不支持|支持|
|支持锁级别|表锁|行锁、表锁|
|索引实现|B+树索引|B+数索引|
|哈希索引|支持|不支持|
|全文索引|支持|不支持|

其他区别有：

1. InnoDB使用聚簇索引，MyISAM使用非聚簇索引；
2. InnoDB主键索引的叶子节点存储行数据，而MyISAM叶子节点存储行数据地址，需要再寻址一次才能得到数据；
3. InnDB非主键索引的叶子节点存储主键和其他索引列的数据查询时做到索引覆盖十分高效。

## 索引

索引时方便快速定位数据的一种数据结构，在实现上为一个文件。索引优点是可以加快数据检索速度，缺点是在增删改数据时需要维护以及占用物理空间。

### 索引类型

1. 从数据结构角度：B+树索引、hash索引、全文索引；
2. 从物理存储角度：聚簇索引、非聚簇索引(二级索引、辅助索引)；
3. 从字段特性角度：主键索引、唯一索引、普通缩影、前缀索引；
4. 从字段个数角度：单列索引、联合索引。

其中
5. 主键索引：数据列不能重复，不能为null，一个表只能有一个主键索引；
6. 唯一索引：数据列不能重复，可以为null，一个表允许创建多个唯一索引；
7. 普通索引：数据列可以重复，可以为null，没有限制。

其他的类型还包括前缀索引：当索引字段为字符串时，为了减少索引大小，使用其前n位为作为索引；全文索引：用于文本搜索。

### 索引数据结构

一般索引的数据结构有B+树和hash表两种。

#### B树和B+树区别

1. B树所有节点都存放键值对，而B+树非叶子节点只存放键没有值，只有叶子节点才同时存放键和值；
2. B+树叶子节点之间相连形成链表，而B树叶子节点没有。

由于上述两者结构的不同，把频繁访问数据放在靠近B树根节点时可以加快热点数据的查询效率，而B+数非叶子节点只存放键，相同条件下一次读取可以获取更多键，可以更快地缩小查询范围。由于叶子节点形成链表，在全局访问时可以先用O(logN)时间找到最小节点，然后用O(N)时间顺序遍历即可；但B数需要遍历每一层，需要更多的内存置换次数。总地来说：

1. B树只适合随机检索，B+树同时支持随机检索和顺序检索；
2. B+树空间利用率更高，减少IO次数；
3. B+树随机查询效率更稳定，B树检索可能在非叶子节点结束，B+树随机检索时都需要从根节点走到叶子节点，路径长度相同，因此查询效率相当；
4. B+树顺序查询效率高，适合范围查询；
5. 增删节点时B+树效率更高
6. B+树在满足聚簇索引和索引覆盖是不需要回表查询数据

对于具有N个节点的B+树，其搜索复杂度为$O(log_dN)$，其中d为B+树的度，实际中d值大于100，即使数据达到千万级别B+树的高度依然维持在3-4层左右，保证3-4次的磁盘IO就可以查到数据。而红黑树是二叉树，其搜索复杂度为$(OlogN)$，树层数多导致磁盘IO也多，严重影响查询性能。

### 聚簇索引与回表

聚簇索引：按照每张表的主键构建一个B+树，该树的叶子节点存放行数据。InnoDB通过主键建立聚簇索引，如果表没有主键，则使用非空的唯一索引，如果没有这样的索引，则隐式地生成一个主键来作为聚簇索引。聚簇索引的优点是数据访问快，对主键的排序查找和范围查找速度快，缺点是插入速度依赖于插入顺序，更新主键开销大。

非聚簇索引：又称辅助索引、二级索引，也是一个B+树，但叶子节点存放的是主键值，因此通过非聚簇索引找到主键后，再通过聚簇索引获取行数据，该过程称之为回表。回表包含2次B+树的遍历，因此效率更低。**注意非聚簇索引不一定发生回表**，如果查询字段就是索引字段，此时不需要回表。

### 索引覆盖

当查询字段都建立索引，引擎直接返回索引表中查询结果而不会二次访问，该行为称之为索引覆盖。索引覆盖加快查询速度，因此尽可能在select字段列表中给出必要的字段。

## 事务

### 事务特性：ACID

- 原子性(**A**tomicity)：事务中的操作不可分割，要么全都完成，要么全都取消；
- 一致性(**C**onsistency)：事务前后的数据保持一致；
- 隔离性(**I**solation)：多个事务互不干扰；
- 持久性(**D**urability)：事务提交后产生的影响是永久的。

通过`start`或`begin`命令开启事务，`commit`命令提交事务，`rollback`命令回滚事务。MySQL默认自动开启事务提交，即每执行一条语句都会提交事务。

### 并发问题与隔离级别

InnoDB支持事务，但是并发事务会导致如下问题：

- 脏读：事务B读取事务A未提交的数据；
- 不可重复读：事务B读取事务A已提交的**修改**数据；
- 幻读：事务B读取事务A已提交的**新增**数据。
  
为了解决如上并发问题，数据库提供如下4种隔离级别：

- 读未提交：什么问题也不能解决，相当于什么都不做；
- 读已提交：事务A提交后事务B才能看到其修改的数据，解决脏读问题(Oracle默认隔离级别)；
- 可重复读：事务A执行过程中看到的数据和该事务启动时看到的保持一致，解决脏读、不可重复读问题(MySQL默认隔离级别)；
- 串行化：同一行记录读加读锁、写加写锁，读写锁冲突时必须等前一个事务提交才能继续执行，解决脏读、不可重复读和幻读问题。

事务隔离级别越高，解决的并发问题也越多，但是并发性能也越低。实际应用中很少用到串行化。
